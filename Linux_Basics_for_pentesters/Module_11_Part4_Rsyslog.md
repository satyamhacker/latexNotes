# **Module 11: Advanced Logging & Auditing (Part 4)** ðŸ“ŠðŸ”

---

## **Topic 4: Centralized Logging (rsyslog Concept)** ðŸ“¡ðŸ”„

---

### **1ï¸âƒ£ Topic Summary (1-2 lines)**

rsyslog ek powerful logging system hai jo multiple servers ke logs ko ek central log server par collect karta hai - network-based log forwarding, filtering, aur centralized analysis ke liye essential tool.

---

### **2ï¸âƒ£ Detailed Explanation with Analogy** ðŸ§ 

**Kya hai Centralized Logging?**

Centralized logging matlab sabhi servers ke logs ek central location par collect karna. rsyslog (Rocket-fast System for Log processing) ye kaam karta hai - logs ko network par forward karta hai aur central server par store karta hai.

**rsyslog Architecture:**

1. **Log Clients** - Servers jo logs generate karte hain
2. **Log Server** - Central server jo logs receive aur store karta hai
3. **Protocol** - UDP (514) ya TCP (514) par communication
4. **Facilities** - Log categories (auth, kern, mail, etc.)
5. **Priorities** - Log levels (emerg, alert, crit, err, warning, notice, info, debug)

**Analogy:**

Centralized logging ek **post office** ki tarah hai:
- Har server (client) = ek ghar jo letters (logs) bhejta hai
- Central log server = main post office jo sab letters collect karta hai
- rsyslog = postal service jo letters deliver karti hai
- Facilities = letter categories (personal, business, urgent)
- Priorities = importance levels (urgent, normal, low)

---

### **3ï¸âƒ£ Why is this Important?** ðŸŽ¯

**Sysadmin Perspective:**
- Single point for log analysis
- Easier troubleshooting across servers
- Security incident correlation
- Compliance requirements
- Log retention and backup
- Real-time monitoring
- Disaster recovery (logs safe even if server crashes)

**Pentester Perspective:**
- Central log server = high-value target
- Log forwarding configuration reveals network topology
- Credentials in rsyslog configs
- Log tampering more difficult (remote storage)
- Attack correlation across servers
- Network traffic analysis

---

### **4ï¸âƒ£ Real-World Use Cases** ðŸ’¼

**Admin Use Cases:**
1. Multiple web servers logging to central server
2. Database cluster log aggregation
3. Security event correlation
4. Compliance reporting (centralized audit trail)
5. Real-time alerting on critical events

**Pentester Use Cases:**
1. Identify central log server
2. Analyze rsyslog configurations
3. Network topology mapping
4. Credential discovery in configs
5. Log server as pivot point

---

### **5ï¸âƒ£ Consequences of Not Knowing** âš ï¸

**Admin Problems:**
- âŒ Distributed logs difficult to analyze
- âŒ Security incidents hard to correlate
- âŒ Troubleshooting time-consuming
- âŒ Compliance violations
- âŒ Log loss if server crashes

**Pentester Problems:**
- âŒ Network topology miss karna
- âŒ Central log server overlook karna
- âŒ Log forwarding configs ignore karna
- âŒ Attack correlation miss karna
- âŒ High-value target miss karna

---

### **6ï¸âƒ£ Syntax & Command Structure** ðŸ“

#### **rsyslog Configuration:**
```bash
# Main config file
/etc/rsyslog.conf

# Additional configs
/etc/rsyslog.d/*.conf
```

#### **Log Forwarding Syntax:**
```bash
# Forward all logs to remote server (UDP)
*.* @remote-server:514

# Forward all logs (TCP - reliable)
*.* @@remote-server:514

# Forward specific facility
auth.* @@remote-server:514

# Forward specific priority and above
*.err @@remote-server:514
```

#### **Facility.Priority Format:**
```
facility.priority action

Facilities:
auth, authpriv, cron, daemon, kern, mail, user, local0-local7

Priorities:
emerg, alert, crit, err, warning, notice, info, debug

Actions:
/path/to/file    - Write to file
@server:port     - Forward via UDP
@@server:port    - Forward via TCP
```

---

### **7ï¸âƒ£ Detailed Examples with Explanation Tables** ðŸ’»

#### **Example 1: Setup Central Log Server**

```bash
# On central log server
sudo nano /etc/rsyslog.conf
```

**Uncomment these lines:**
```bash
# Provides UDP syslog reception
module(load="imudp")
input(type="imudp" port="514")

# Provides TCP syslog reception
module(load="imtcp")
input(type="imtcp" port="514")
```

```bash
# Restart rsyslog
sudo systemctl restart rsyslog

# Verify listening
sudo netstat -tulpn | grep 514
```

**Output:**
```
udp        0      0 0.0.0.0:514             0.0.0.0:*                           1234/rsyslogd
tcp        0      0 0.0.0.0:514             0.0.0.0:*                           1234/rsyslogd
```

---

#### **Example 2: Configure Client to Forward Logs**

```bash
# On client server
sudo nano /etc/rsyslog.d/50-forward.conf
```

**Add:**
```bash
# Forward all logs to central server (TCP)
*.* @@central-log-server:514

# Or with specific facility
auth.* @@central-log-server:514
*.err @@central-log-server:514
```

```bash
# Restart rsyslog
sudo systemctl restart rsyslog

# Test
logger -p auth.info "Test log from $(hostname)"
```

**On central server:**
```bash
tail -f /var/log/syslog | grep "Test log"
```

---

#### **Example 3: Organize Logs by Hostname**

```bash
# On central log server
sudo nano /etc/rsyslog.d/30-remote.conf
```

**Add:**
```bash
# Template for remote logs
$template RemoteLogs,"/var/log/remote/%HOSTNAME%/%PROGRAMNAME%.log"

# Apply template to remote logs
*.* ?RemoteLogs

# Stop processing (don't write to local syslog)
& stop
```

```bash
# Restart
sudo systemctl restart rsyslog

# Create directory
sudo mkdir -p /var/log/remote
```

**Result:** Logs organized as `/var/log/remote/server1/sshd.log`

---

#### **Example 4: Filter by Priority**

```bash
# On client
sudo nano /etc/rsyslog.d/50-forward.conf
```

**Add:**
```bash
# Forward only errors and above
*.err @@central-log-server:514

# Forward only auth logs
auth.* @@central-log-server:514

# Forward everything except info and debug
*.notice;*.warn;*.err;*.crit;*.alert;*.emerg @@central-log-server:514
```

---

#### **Example 5: Secure Logging with TLS**

**On central server:**
```bash
# Install TLS support
sudo apt install rsyslog-gnutls

# Generate certificates
sudo openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
    -keyout /etc/rsyslog-keys/server-key.pem \
    -out /etc/rsyslog-keys/server-cert.pem

# Configure
sudo nano /etc/rsyslog.conf
```

**Add:**
```bash
# Load TLS module
module(load="imtcp" StreamDriver.Name="gtls" StreamDriver.Mode="1" \
       StreamDriver.Authmode="anon")

# TLS input
input(type="imtcp" port="6514")
```

**On client:**
```bash
# Configure TLS forwarding
*.* @@(o)central-log-server:6514
```

---

#### **Example 6: Real-time Log Monitoring**

```bash
# On central log server
tail -f /var/log/syslog

# Or with filtering
tail -f /var/log/syslog | grep "Failed password"

# Or specific server
tail -f /var/log/remote/web-server1/sshd.log
```

---

#### **Example 7: Log Rotation for Remote Logs**

```bash
# Create logrotate config
sudo nano /etc/logrotate.d/remote-logs
```

**Add:**
```bash
/var/log/remote/*/*.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    create 0640 syslog adm
    sharedscripts
    postrotate
        /usr/lib/rsyslog/rsyslog-rotate
    endscript
}
```

---

#### **Example 8: Alert on Specific Events**

```bash
# On central server
sudo nano /etc/rsyslog.d/40-alerts.conf
```

**Add:**
```bash
# Alert on failed SSH logins
:msg, contains, "Failed password" ^/usr/local/bin/alert.sh

# Alert script
cat > /usr/local/bin/alert.sh << 'EOF'
#!/bin/bash
echo "$1" | mail -s "Security Alert: Failed Login" admin@example.com
EOF

chmod +x /usr/local/bin/alert.sh
```

---

#### **Example 9: Database Logging (MySQL)**

```bash
# Install MySQL module
sudo apt install rsyslog-mysql

# Configure
sudo nano /etc/rsyslog.d/mysql.conf
```

**Add:**
```bash
module(load="ommysql")

*.* :ommysql:localhost,Syslog,rsyslog,password
```

---

#### **Example 10: Pentester - Enumerate rsyslog Config**

```bash
# Check if rsyslog running
systemctl status rsyslog

# Check configuration
cat /etc/rsyslog.conf
cat /etc/rsyslog.d/*.conf

# Find central log server
grep -r "@" /etc/rsyslog.d/
# Output: *.* @@central-log-server:514

# Check for credentials
grep -ri "password\|user\|auth" /etc/rsyslog.d/

# Check listening ports
netstat -tulpn | grep rsyslog
```

---

### **8ï¸âƒ£ Common Mistakes & How to Avoid** âŒâž¡ï¸âœ…

| Mistake | Problem | Solution |
|---------|---------|----------|
| Using UDP only | Logs can be lost | Use TCP (`@@`) for reliability |
| No firewall rules | Logs can't reach server | Open port 514 on firewall |
| No log rotation | Disk full | Configure logrotate |
| Mixing local and remote | Duplicate logs | Use `& stop` after remote template |
| No TLS | Logs sent in plaintext | Use TLS for sensitive logs |
| Single log server | Single point of failure | Use redundant log servers |
| No monitoring | Log server down unnoticed | Monitor log server health |
| Weak permissions | Unauthorized log access | Secure log directories |

---

### **9ï¸âƒ£ Best Practices & Pro Tips** â­

**Admin Best Practices:**
1. âœ… **Use TCP**: More reliable than UDP
2. âœ… **TLS Encryption**: For sensitive logs
3. âœ… **Organize by Hostname**: Easier analysis
4. âœ… **Log Rotation**: Prevent disk full
5. âœ… **Redundancy**: Multiple log servers
6. âœ… **Monitoring**: Alert on log server issues
7. âœ… **Firewall Rules**: Restrict access to log server
8. âœ… **Regular Backups**: Backup log server

**Pentester Pro Tips:**
1. ðŸ” **Find Log Server**: Check rsyslog configs
2. ðŸ” **Network Topology**: Log forwarding reveals infrastructure
3. ðŸ” **Credentials**: Check configs for DB passwords
4. ðŸ” **High-Value Target**: Central log server has all logs
5. ðŸ” **Log Tampering**: Harder with remote logging
6. ðŸ” **Traffic Analysis**: Monitor port 514
7. ðŸ” **Pivot Point**: Log server may access all servers
8. ðŸ” **Attack Correlation**: Analyze logs across servers

---

### **ðŸ”Ÿ Real-World Scenarios** ðŸŒ

#### **Scenario 1: Setup Centralized Logging (Admin)**

**Situation:** 5 web servers ka centralized logging setup karna hai.

**Solution:**

**Step 1: Configure Central Log Server**
```bash
# On log-server
sudo nano /etc/rsyslog.conf
```

**Uncomment:**
```bash
module(load="imtcp")
input(type="imtcp" port="514")
```

**Add template:**
```bash
sudo nano /etc/rsyslog.d/30-remote.conf
```

```bash
$template RemoteLogs,"/var/log/remote/%HOSTNAME%/%PROGRAMNAME%.log"
*.* ?RemoteLogs
& stop
```

```bash
# Create directory
sudo mkdir -p /var/log/remote

# Restart
sudo systemctl restart rsyslog

# Open firewall
sudo ufw allow 514/tcp
```

**Step 2: Configure Web Servers**
```bash
# On web-server1, web-server2, etc.
sudo nano /etc/rsyslog.d/50-forward.conf
```

```bash
*.* @@log-server:514
```

```bash
# Restart
sudo systemctl restart rsyslog

# Test
logger "Test from $(hostname)"
```

**Step 3: Verify on Log Server**
```bash
ls -la /var/log/remote/
# web-server1/ web-server2/ web-server3/ ...

tail -f /var/log/remote/web-server1/sshd.log
```

**Result:** Centralized logging operational!

---

#### **Scenario 2: Security Event Correlation (Admin)**

**Situation:** Multiple servers par brute force attack detect karna hai.

**Solution:**
```bash
# On central log server
grep "Failed password" /var/log/remote/*/sshd.log | \
    awk '{print $(NF-3)}' | sort | uniq -c | sort -nr

# Output:
#  45 192.168.1.200  (attacking web-server1)
#  23 192.168.1.200  (attacking web-server2)
#  12 192.168.1.200  (attacking web-server3)

# Same IP attacking multiple servers!

# Block on firewall
sudo ufw deny from 192.168.1.200

# Alert team
echo "Brute force attack from 192.168.1.200 detected on multiple servers" | \
    mail -s "Security Alert" security@example.com
```

**Result:** Attack detected and blocked across infrastructure!

---

#### **Scenario 3: Compliance Reporting (Admin)**

**Situation:** Monthly compliance report generate karni hai.

**Solution:**
```bash
# On central log server
# Generate report for all servers

# Failed login attempts
echo "=== Failed Login Attempts ===" > /tmp/compliance_report.txt
grep "Failed password" /var/log/remote/*/sshd.log | wc -l >> /tmp/compliance_report.txt

# Successful logins
echo "=== Successful Logins ===" >> /tmp/compliance_report.txt
grep "Accepted" /var/log/remote/*/sshd.log | wc -l >> /tmp/compliance_report.txt

# Sudo commands
echo "=== Sudo Commands ===" >> /tmp/compliance_report.txt
grep "sudo.*COMMAND" /var/log/remote/*/auth.log | wc -l >> /tmp/compliance_report.txt

# Service restarts
echo "=== Service Restarts ===" >> /tmp/compliance_report.txt
grep "systemctl restart" /var/log/remote/*/syslog | wc -l >> /tmp/compliance_report.txt

# Email report
mail -s "Monthly Compliance Report" compliance@example.com < /tmp/compliance_report.txt
```

**Result:** Comprehensive compliance documentation!

---

#### **Scenario 4: Network Topology Discovery (Pentester)**

**Situation:** Compromised server se network topology discover karna hai.

**Reconnaissance:**
```bash
# Check rsyslog configuration
cat /etc/rsyslog.conf
cat /etc/rsyslog.d/*.conf

# Found:
*.* @@central-log-server.internal:514

# Now we know:
# 1. Central log server exists
# 2. Hostname: central-log-server.internal
# 3. Port: 514 (TCP)

# Resolve IP
nslookup central-log-server.internal
# 10.0.1.100

# Check connectivity
nc -zv 10.0.1.100 514
# Connection successful

# Check what else is logging there
# (if we can access log server)
ssh admin@10.0.1.100
ls /var/log/remote/
# web-server1/ web-server2/ db-server1/ app-server1/

# Now we know entire infrastructure!
```

**Finding:** Complete network topology discovered!

---

#### **Scenario 5: Log Server Compromise (Pentester)**

**Situation:** Central log server compromise karke all logs access karna hai.

**Attack:**
```bash
# After compromising log server
cd /var/log/remote

# List all servers
ls -la
# web-server1/ web-server2/ db-server1/ app-server1/

# Search for credentials across all servers
grep -r "password" . | grep -v "Failed password"

# Output:
./app-server1/syslog:Jan 15 10:30:45 app-server1 deploy: mysql -u root -pRootPass123
./web-server2/auth.log:Jan 15 11:20:30 web-server2 admin: scp backup.tar.gz admin@backup:BackupPass456

# Search for sensitive commands
grep -r "mysql\|ssh\|scp" . | grep -E "@|password"

# Timeline reconstruction
grep -r "192.168.1.100" . | sort

# Identify admin patterns
grep -r "sudo" . | awk '{print $5}' | sort | uniq -c | sort -nr
```

**Impact:** Complete infrastructure compromise!

---

### **1ï¸âƒ£1ï¸âƒ£ Checklist for Implementation** âœ…

**Admin Checklist:**
- [ ] Central log server configured
- [ ] TCP reception enabled
- [ ] Firewall rules configured
- [ ] All clients forwarding logs
- [ ] Logs organized by hostname
- [ ] Log rotation configured
- [ ] TLS encryption enabled (if needed)
- [ ] Monitoring setup
- [ ] Backup procedures in place
- [ ] Access controls configured

**Pentester Checklist:**
- [ ] rsyslog configs checked
- [ ] Central log server identified
- [ ] Network topology mapped
- [ ] Credentials searched in configs
- [ ] Log server access attempted
- [ ] All server logs analyzed
- [ ] Attack correlation performed
- [ ] Sensitive data extracted
- [ ] Pivot opportunities identified
- [ ] Findings documented

---

### **1ï¸âƒ£2ï¸âƒ£ Frequently Asked Questions (FAQs)** â“

**Q1: UDP vs TCP - kaunsa use karein?**
**A:** TCP (`@@`) more reliable hai. UDP (`@`) faster but logs loss ho sakta hai.

**Q2: Kya logs encrypted hote hain?**
**A:** By default NO. TLS enable karna padta hai for encryption.

**Q3: Central log server down ho jaye toh?**
**A:** Clients local logs store karte rahenge. Redundant log servers use karein.

**Q4: Kitni disk space chahiye log server ko?**
**A:** Depends on log volume. Typical: 10-100 GB/day for medium infrastructure. Use log rotation!

**Q5: Kya database mein logs store kar sakte hain?**
**A:** Haan, rsyslog-mysql module use karein. But file-based faster hai.

**Q6: Log forwarding verify kaise karein?**
**A:**
```bash
# On client
logger "Test from $(hostname)"

# On server
tail -f /var/log/syslog | grep "Test from"
```

**Q7: Firewall rules kya chahiye?**
**A:**
```bash
# On log server
sudo ufw allow from CLIENT_IP to any port 514 proto tcp
```

**Q8: Kya specific applications ke logs forward kar sakte hain?**
**A:** Haan:
```bash
# Only nginx logs
if $programname == 'nginx' then @@log-server:514
```

---

### **1ï¸âƒ£3ï¸âƒ£ Practice Tasks with Expected Output** ðŸŽ¯

#### **Task 1: Setup Log Server**
```bash
# Enable TCP reception
sudo nano /etc/rsyslog.conf
# Uncomment imtcp lines

sudo systemctl restart rsyslog
sudo netstat -tulpn | grep 514
```

**Expected:** Port 514 listening.

---

#### **Task 2: Configure Client Forwarding**
```bash
echo '*.* @@log-server:514' | sudo tee /etc/rsyslog.d/50-forward.conf
sudo systemctl restart rsyslog
logger "Test log"
```

**Expected:** Log appears on server.

---

#### **Task 3: Organize Logs by Hostname**
```bash
# On server
echo '$template RemoteLogs,"/var/log/remote/%HOSTNAME%/%PROGRAMNAME%.log"' | \
    sudo tee /etc/rsyslog.d/30-remote.conf
echo '*.* ?RemoteLogs' | sudo tee -a /etc/rsyslog.d/30-remote.conf
sudo systemctl restart rsyslog
```

**Expected:** Logs in `/var/log/remote/hostname/`

---

### **1ï¸âƒ£4ï¸âƒ£ Advanced Information & Edge Cases** ðŸš€

#### **Advanced Technique 1: Load Balancing**

```bash
# Multiple log servers for redundancy
*.* @@log-server1:514
*.* @@log-server2:514
```

---

#### **Advanced Technique 2: Conditional Forwarding**

```bash
# Forward only specific messages
:msg, contains, "error" @@log-server:514
:msg, contains, "failed" @@log-server:514
```

---

#### **Advanced Technique 3: Rate Limiting**

```bash
# Prevent log flooding
$ModLoad imuxsock
$SystemLogRateLimitInterval 5
$SystemLogRateLimitBurst 100
```

---

#### **Edge Case 1: Large Log Files**

```bash
# Compress old logs
find /var/log/remote -name "*.log" -mtime +7 -exec gzip {} \;
```

---

#### **Edge Case 2: Network Latency**

```bash
# Queue logs if server unreachable
$ActionQueueType LinkedList
$ActionQueueFileName remote
$ActionResumeRetryCount -1
$ActionQueueSaveOnShutdown on
```

---

### **1ï¸âƒ£5ï¸âƒ£ Final Summary & Key Takeaways** ðŸ“Œ

**Key Concepts:**
1. **Centralized Logging** - All logs in one place
2. **rsyslog** - Log forwarding and collection
3. **TCP vs UDP** - Reliability vs speed
4. **Facilities & Priorities** - Log categorization
5. **Templates** - Log organization

**Critical Commands:**
```bash
# Enable log reception (server)
module(load="imtcp")
input(type="imtcp" port="514")

# Forward logs (client)
*.* @@log-server:514

# Restart rsyslog
sudo systemctl restart rsyslog
```

**Admin Takeaways:**
- âœ… Centralized logging essential for infrastructure
- âœ… Use TCP for reliability
- âœ… Organize logs by hostname
- âœ… Configure log rotation
- âœ… Enable TLS for sensitive logs
- âœ… Monitor log server health
- âœ… Regular backups

**Pentester Takeaways:**
- ðŸ” rsyslog configs reveal network topology
- ðŸ” Central log server = high-value target
- ðŸ” All server logs in one place
- ðŸ” Credentials may be in configs
- ðŸ” Attack correlation possible
- ðŸ” Log server as pivot point
- ðŸ” Traffic analysis on port 514

**Remember:**
- Centralized logging = easier analysis
- TCP more reliable than UDP
- TLS for encryption
- Log rotation prevents disk full
- Monitor log server health

---

**Module 11 Complete! ðŸŽ‰**

**Topics Covered:**
1. âœ… journalctl Advanced Filtering
2. âœ… auditd: System ka 'CCTV Camera'
3. âœ… Bash History Hardening
4. âœ… Centralized Logging (rsyslog)

**Next Module:** Professional Monitoring & Alerting ðŸ“Š

---

**Happy Centralized Logging! ðŸ“¡ðŸ”„**
