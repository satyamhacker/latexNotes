# **Module 11: Advanced Logging & Auditing (Part 3)** ğŸ“ŠğŸ”

---

## **Topic 3: Bash History Hardening** ğŸ“œğŸ”’

---

### **1ï¸âƒ£ Topic Summary (1-2 lines)**

Bash history user ke command history ko `.bash_history` file mein store karta hai - HISTTIMEFORMAT timestamps add karta hai, HISTCONTROL duplicates control karta hai, aur proper configuration se security aur forensics improve hoti hai.

---

### **2ï¸âƒ£ Detailed Explanation with Analogy** ğŸ§ 

**Kya hai Bash History?**

Bash history ek feature hai jo terminal mein execute kiye gaye commands ko record karta hai. Ye `.bash_history` file mein store hota hai aur up/down arrow keys se access kar sakte ho.

**Key Components:**

1. **~/.bash_history** - History file (user-specific)
2. **HISTSIZE** - Memory mein kitne commands store karein
3. **HISTFILESIZE** - File mein kitne commands store karein
4. **HISTTIMEFORMAT** - Timestamp format
5. **HISTCONTROL** - Duplicate/space handling
6. **HISTIGNORE** - Specific commands ignore karna

**Analogy:**

Bash history ek **diary** ki tarah hai jo aapki har activity record karti hai:
- Kya kiya (command)
- Kab kiya (timestamp with HISTTIMEFORMAT)
- Kitna record rakhna hai (HISTSIZE)
- Kya ignore karna hai (HISTIGNORE)

Admin ke liye = audit trail
Pentester ke liye = goldmine of information (credentials, commands, patterns)

---

### **3ï¸âƒ£ Why is this Important?** ğŸ¯

**Sysadmin Perspective:**
- User activity tracking
- Troubleshooting (what commands were run)
- Security auditing
- Compliance requirements
- Incident investigation
- Training/documentation

**Pentester Perspective:**
- Credentials in command history
- Previous admin commands
- Network information (IPs, domains)
- File paths and locations
- Attack patterns from previous compromises
- Privilege escalation hints

---

### **4ï¸âƒ£ Real-World Use Cases** ğŸ’¼

**Admin Use Cases:**
1. Track user commands for auditing
2. Investigate security incidents
3. Troubleshoot issues (what was run before error)
4. Compliance reporting
5. User training (review commands)

**Pentester Use Cases:**
1. Find credentials in history (`mysql -u root -pPassword123`)
2. Discover internal IPs/domains
3. Identify sensitive file locations
4. Previous attack traces
5. Admin command patterns

---

### **5ï¸âƒ£ Consequences of Not Knowing** âš ï¸

**Admin Problems:**
- âŒ No audit trail of user commands
- âŒ Incident investigation difficult
- âŒ Troubleshooting time increase
- âŒ Compliance violations
- âŒ Security incidents undetected

**Pentester Problems:**
- âŒ Easy credential discovery miss karna
- âŒ Valuable reconnaissance data overlook
- âŒ Attack traces leave karna
- âŒ History cleanup forget karna
- âŒ Forensic evidence leave karna

---

### **6ï¸âƒ£ Syntax & Command Structure** ğŸ“

#### **History Commands:**
```bash
history              # Show command history
history 20           # Show last 20 commands
history -c           # Clear history from memory
history -w           # Write history to file
history -d N         # Delete specific entry
!N                   # Execute command number N
!!                   # Execute last command
!string              # Execute last command starting with string
```

#### **Environment Variables:**
```bash
HISTSIZE=1000                    # Commands in memory
HISTFILESIZE=2000                # Commands in file
HISTTIMEFORMAT="%F %T "          # Timestamp format
HISTCONTROL=ignoredups           # Ignore duplicates
HISTIGNORE="ls:cd:pwd:exit"      # Ignore specific commands
```

---

### **7ï¸âƒ£ Detailed Examples with Explanation Tables** ğŸ’»

#### **Example 1: View Command History**

```bash
history
```

**Output (without timestamps):**
```
  1  ls -la
  2  cd /var/www
  3  sudo systemctl restart nginx
  4  mysql -u root -pPassword123
  5  cat /etc/passwd
```

---

#### **Example 2: Enable Timestamps**

```bash
# Add to ~/.bashrc
echo 'export HISTTIMEFORMAT="%F %T "' >> ~/.bashrc
source ~/.bashrc

# View history with timestamps
history
```

**Output (with timestamps):**
```
  1  2024-01-15 10:30:45 ls -la
  2  2024-01-15 10:31:12 cd /var/www
  3  2024-01-15 10:32:00 sudo systemctl restart nginx
  4  2024-01-15 10:33:15 mysql -u root -pPassword123
  5  2024-01-15 10:34:30 cat /etc/passwd
```

| Part | Explanation |
|------|-------------|
| `HISTTIMEFORMAT` | Timestamp format variable |
| `"%F %T "` | Date (YYYY-MM-DD) + Time (HH:MM:SS) |
| `~/.bashrc` | User shell configuration |

---

#### **Example 3: Configure History Size**

```bash
# Add to ~/.bashrc
cat >> ~/.bashrc << 'EOF'
# History configuration
export HISTSIZE=10000           # 10,000 commands in memory
export HISTFILESIZE=20000       # 20,000 commands in file
export HISTTIMEFORMAT="%F %T "  # Timestamp
EOF

source ~/.bashrc

# Verify
echo $HISTSIZE
echo $HISTFILESIZE
```

---

#### **Example 4: Ignore Duplicates**

```bash
# Add to ~/.bashrc
export HISTCONTROL=ignoredups

# Or ignore duplicates and commands starting with space
export HISTCONTROL=ignoreboth
```

| Value | Behavior |
|-------|----------|
| `ignoredups` | Ignore duplicate consecutive commands |
| `ignorespace` | Ignore commands starting with space |
| `ignoreboth` | Both of above |
| `erasedups` | Remove all previous duplicates |

---

#### **Example 5: Ignore Specific Commands**

```bash
# Add to ~/.bashrc
export HISTIGNORE="ls:cd:pwd:exit:clear:history"

# These commands won't be saved in history
ls
cd /tmp
pwd
```

---

#### **Example 6: Search History**

```bash
# Search with Ctrl+R (reverse search)
# Press Ctrl+R, then type search term

# Or use grep
history | grep "mysql"
history | grep "password"
history | grep "ssh"
```

**Output:**
```
  4  2024-01-15 10:33:15 mysql -u root -pPassword123
 45  2024-01-15 11:20:30 mysql -u admin -pAdminPass456
```

---

#### **Example 7: Clear History**

```bash
# Clear from memory
history -c

# Clear file
cat /dev/null > ~/.bash_history

# Or delete file
rm ~/.bash_history

# Prevent current session from saving
unset HISTFILE
```

---

#### **Example 8: Delete Specific Entry**

```bash
# View history with numbers
history

# Delete entry number 4
history -d 4

# Write to file
history -w
```

---

#### **Example 9: Execute Previous Commands**

```bash
# Execute last command
!!

# Execute command number 5
!5

# Execute last command starting with "sudo"
!sudo

# Execute last command starting with "mysql"
!mysql
```

---

#### **Example 10: Pentester - Extract Credentials**

```bash
# Search for common credential patterns
history | grep -E "password|passwd|pwd|pass"
history | grep -E "mysql.*-p|psql.*password"
history | grep -E "ssh.*@|scp.*@"
history | grep -E "curl.*Authorization|wget.*password"

# Check other users' history (if root)
cat /home/*/.bash_history | grep -i password
```

---

### **8ï¸âƒ£ Common Mistakes & How to Avoid** âŒâ¡ï¸âœ…

| Mistake | Problem | Solution |
|---------|---------|----------|
| Passwords in commands | Visible in history | Use `-p` without password, prompt instead |
| No timestamps | Can't determine when | Set `HISTTIMEFORMAT` |
| Small HISTSIZE | Important commands lost | Increase to 10000+ |
| Not clearing history | Sensitive data exposed | Regular cleanup |
| Forgetting `unset HISTFILE` | Commands still logged | Use for sensitive operations |
| Not checking other users | Miss valuable data | Check `/home/*/.bash_history` |
| Trusting cleared history | File may still exist | Overwrite with `/dev/null` |
| No HISTIGNORE | Noise in history | Ignore common commands |

---

### **9ï¸âƒ£ Best Practices & Pro Tips** â­

**Admin Best Practices:**
1. âœ… **Enable Timestamps**: Always set `HISTTIMEFORMAT`
2. âœ… **Large History**: Set `HISTSIZE=10000` minimum
3. âœ… **Centralized Logging**: Forward history to syslog
4. âœ… **Read-only History**: Make `.bash_history` append-only
5. âœ… **Regular Audits**: Review user command history
6. âœ… **Ignore Noise**: Set `HISTIGNORE` for common commands
7. âœ… **Backup History**: Include in user backups
8. âœ… **Training**: Educate users about history

**Pentester Pro Tips:**
1. ğŸ” **Check All Users**: `cat /home/*/.bash_history`
2. ğŸ” **Root History**: `cat /root/.bash_history`
3. ğŸ” **Search Patterns**: grep for passwords, IPs, domains
4. ğŸ” **Deleted Files**: Check `.bash_history~` backups
5. ğŸ” **Memory History**: Current session not yet written
6. ğŸ” **Clear Traces**: `history -c && cat /dev/null > ~/.bash_history`
7. ğŸ” **Disable Logging**: `unset HISTFILE` before commands
8. ğŸ” **Space Prefix**: Start commands with space (if `ignorespace`)

---

### **ğŸ”Ÿ Real-World Scenarios** ğŸŒ

#### **Scenario 1: Enable Comprehensive History Logging (Admin)**

**Situation:** Production server par complete command auditing enable karni hai.

**Solution:**
```bash
# Create system-wide history configuration
sudo nano /etc/profile.d/history.sh
```

**Content:**
```bash
#!/bin/bash

# History size
export HISTSIZE=50000
export HISTFILESIZE=100000

# Timestamp format
export HISTTIMEFORMAT="%F %T %z "

# Control
export HISTCONTROL=ignoredups

# Ignore common commands
export HISTIGNORE="ls:ll:cd:pwd:exit:clear:history"

# Append to history file (don't overwrite)
shopt -s histappend

# Save history after each command
PROMPT_COMMAND="history -a"

# Log to syslog (optional)
export PROMPT_COMMAND='RETRN_VAL=$?;logger -p local6.debug "$(whoami) [$$]: $(history 1 | sed "s/^[ ]*[0-9]\+[ ]*//" )"'
```

```bash
# Make executable
sudo chmod +x /etc/profile.d/history.sh

# Apply to current session
source /etc/profile.d/history.sh

# Verify
echo $HISTSIZE
echo $HISTTIMEFORMAT
```

**Result:** Har user ka complete command history with timestamps!

---

#### **Scenario 2: Make History Append-Only (Admin)**

**Situation:** Users ko history delete karne se rokna hai.

**Solution:**
```bash
# Make .bash_history append-only
sudo chattr +a ~/.bash_history

# Verify
lsattr ~/.bash_history
# -----a---------- /home/user/.bash_history

# Now user can't delete or overwrite
rm ~/.bash_history
# rm: cannot remove '.bash_history': Operation not permitted

cat /dev/null > ~/.bash_history
# bash: .bash_history: Operation not permitted

# But can append
echo "test" >> ~/.bash_history  # Works!

# To remove append-only (root only)
sudo chattr -a ~/.bash_history
```

**Result:** History tamper-proof!

---

#### **Scenario 3: Centralized History Logging (Admin)**

**Situation:** Sabhi users ka history central server par log karna hai.

**Solution:**
```bash
# Add to /etc/profile.d/history.sh
export PROMPT_COMMAND='RETRN_VAL=$?;logger -p local6.debug "$(hostname) $(whoami) [$$]: $(history 1 | sed "s/^[ ]*[0-9]\+[ ]*//" )"'

# Configure rsyslog to forward
sudo nano /etc/rsyslog.d/bash-history.conf
```

**Content:**
```
local6.*    @@central-log-server:514
```

```bash
# Restart rsyslog
sudo systemctl restart rsyslog

# Test
ls -la

# Check on central server
tail -f /var/log/syslog | grep "$(hostname)"
```

**Result:** Har command central server par logged!

---

#### **Scenario 4: Credential Discovery (Pentester)**

**Situation:** Compromised server par credentials dhundhne hain.

**Attack:**
```bash
# Check current user history
cat ~/.bash_history | grep -i password

# Output:
mysql -u root -pRootPass123
scp -P 2222 backup.tar.gz admin@backup-server  # Password: BackupPass456
curl -u admin:ApiKey123 https://api.example.com

# Check all users (if root access)
for user in $(ls /home); do
    echo "=== $user ==="
    cat /home/$user/.bash_history 2>/dev/null | grep -iE "password|passwd|pass=|pwd|mysql.*-p|ssh.*@"
done

# Check root history
sudo cat /root/.bash_history | grep -iE "password|mysql|ssh"

# Search for IPs and domains
cat ~/.bash_history | grep -oE "\b([0-9]{1,3}\.){3}[0-9]{1,3}\b" | sort -u
cat ~/.bash_history | grep -oE "[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}" | sort -u

# Search for file paths
cat ~/.bash_history | grep -E "^(cat|vim|nano|less)" | awk '{print $2}' | sort -u
```

**Findings:**
- Database credentials
- SSH passwords
- API keys
- Internal IPs
- Sensitive file locations

---

#### **Scenario 5: Covering Tracks (Pentester)**

**Situation:** Attack ke baad history cleanup karni hai.

**Cleanup:**
```bash
# Method 1: Clear history completely
history -c
cat /dev/null > ~/.bash_history
logout

# Method 2: Delete specific entries
history | grep "malicious_command"
# 123  malicious_command
history -d 123
history -w

# Method 3: Disable history for session
unset HISTFILE
# Now run commands (won't be logged)
whoami
id
cat /etc/shadow
# Exit without saving
kill -9 $$

# Method 4: Use space prefix (if ignorespace enabled)
 whoami
 id
 cat /etc/shadow
# Commands starting with space not logged

# Method 5: Overwrite with fake history
cat > ~/.bash_history << 'EOF'
ls
cd /tmp
pwd
exit
EOF

# Method 6: Timestamp manipulation
# Edit .bash_history and add fake timestamps
```

**Result:** Attack traces minimized!

---

### **1ï¸âƒ£1ï¸âƒ£ Checklist for Implementation** âœ…

**Admin Checklist:**
- [ ] HISTTIMEFORMAT configured
- [ ] HISTSIZE increased (10000+)
- [ ] HISTFILESIZE increased (20000+)
- [ ] HISTCONTROL set (ignoredups)
- [ ] HISTIGNORE configured
- [ ] Append-only attribute set
- [ ] Centralized logging configured
- [ ] Regular history audits scheduled
- [ ] User training completed
- [ ] Backup procedures include history

**Pentester Checklist:**
- [ ] Current user history checked
- [ ] All users' history enumerated
- [ ] Root history analyzed
- [ ] Credentials extracted
- [ ] IPs/domains documented
- [ ] File paths identified
- [ ] Attack patterns noted
- [ ] Cleanup procedures planned
- [ ] Evasion techniques applied
- [ ] Findings documented

---

### **1ï¸âƒ£2ï¸âƒ£ Frequently Asked Questions (FAQs)** â“

**Q1: History file kab update hoti hai?**
**A:** By default, logout par. But `PROMPT_COMMAND="history -a"` se har command ke baad update hoti hai.

**Q2: Kya deleted history recover ho sakti hai?**
**A:** Haan, file system forensics se possible hai. Better to overwrite with `/dev/null`.

**Q3: Space se start karne par command log nahi hoti?**
**A:** Sirf agar `HISTCONTROL=ignorespace` ya `ignoreboth` set ho.

**Q4: Multiple terminals ka history kaise merge hota hai?**
**A:** Last logout wala overwrite kar deta hai. Use `shopt -s histappend` to append instead.

**Q5: Kya history disable kar sakte hain?**
**A:** Haan:
```bash
unset HISTFILE
# Or
export HISTSIZE=0
```

**Q6: Root user ka history kahan hota hai?**
**A:** `/root/.bash_history`

**Q7: History file ka location kaise change karein?**
**A:**
```bash
export HISTFILE=/path/to/custom/history
```

**Q8: Kya history encrypted ho sakti hai?**
**A:** By default nahi, but custom solution possible:
```bash
# Encrypt on logout
trap 'history -w; gpg -e ~/.bash_history' EXIT
```

---

### **1ï¸âƒ£3ï¸âƒ£ Practice Tasks with Expected Output** ğŸ¯

#### **Task 1: Enable Timestamps**
```bash
export HISTTIMEFORMAT="%F %T "
history 5
```

**Expected:** Last 5 commands with timestamps.

---

#### **Task 2: Search History**
```bash
history | grep "sudo"
```

**Expected:** All commands containing "sudo".

---

#### **Task 3: Clear History**
```bash
history -c
history
```

**Expected:** Empty history.

---

#### **Task 4: Configure History Size**
```bash
echo 'export HISTSIZE=10000' >> ~/.bashrc
echo 'export HISTFILESIZE=20000' >> ~/.bashrc
source ~/.bashrc
echo $HISTSIZE
```

**Expected:** 10000

---

### **1ï¸âƒ£4ï¸âƒ£ Advanced Information & Edge Cases** ğŸš€

#### **Advanced Technique 1: Real-time History Monitoring**

```bash
# Monitor history file in real-time
tail -f ~/.bash_history

# Or with timestamps
while true; do
    clear
    history 20
    sleep 2
done
```

---

#### **Advanced Technique 2: History Diff**

```bash
# Save current history
history > /tmp/history_before.txt

# Do some work
# ...

# Compare
history > /tmp/history_after.txt
diff /tmp/history_before.txt /tmp/history_after.txt
```

---

#### **Advanced Technique 3: Shared History Across Sessions**

```bash
# Add to ~/.bashrc
shopt -s histappend
export PROMPT_COMMAND="history -a; history -c; history -r"
```

**Result:** All terminals share same history in real-time.

---

#### **Edge Case 1: History with Sudo**

```bash
# Sudo commands in user history
sudo ls
# Logged in user's history

# But actual command runs as root
# Root's history separate
```

---

#### **Edge Case 2: History in Scripts**

```bash
# History not available in scripts by default
#!/bin/bash
history  # Won't work

# Enable with
set -o history
history
```

---

### **1ï¸âƒ£5ï¸âƒ£ Final Summary & Key Takeaways** ğŸ“Œ

**Key Concepts:**
1. **Bash History** - Command history tracking
2. **HISTTIMEFORMAT** - Add timestamps
3. **HISTSIZE** - Commands in memory
4. **HISTFILESIZE** - Commands in file
5. **HISTCONTROL** - Duplicate/space handling

**Critical Commands:**
```bash
# View history
history

# Enable timestamps
export HISTTIMEFORMAT="%F %T "

# Clear history
history -c && cat /dev/null > ~/.bash_history

# Disable for session
unset HISTFILE
```

**Admin Takeaways:**
- âœ… Enable timestamps always
- âœ… Increase history size
- âœ… Make history append-only
- âœ… Centralized logging
- âœ… Regular audits
- âœ… User training
- âœ… Backup history files

**Pentester Takeaways:**
- ğŸ” Check all users' history
- ğŸ” Search for credentials
- ğŸ” Extract IPs/domains
- ğŸ” Identify file paths
- ğŸ” Clear traces after attack
- ğŸ” Use `unset HISTFILE`
- ğŸ” Space prefix for stealth

**Remember:**
- History = audit trail + attack surface
- Timestamps essential for forensics
- Credentials often in history
- Clear history properly
- Append-only prevents tampering

**Next Topic:** Centralized Logging (rsyslog) ğŸ“¡

---

**Happy History Hardening! ğŸ“œğŸ”’**
