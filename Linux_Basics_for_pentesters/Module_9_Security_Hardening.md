# **Module 9: Security Hardening & Defense**

## **Topic 1: Firewall Management (iptables Basics & ufw/firewalld)**

### **1. Topic ka Naam / Ek Line Mein Summary** üöÄ
**Firewall Management:** Network traffic ko control karna - server ki pehli line of defense.

### **2. Ye Kya Hai? (What is it?)**
Firewall ek security system hai jo incoming aur outgoing network traffic ko rules ke basis par allow ya block karta hai. UFW (Uncomplicated Firewall) aur firewalld user-friendly frontends hain iptables ke liye.

**Analogy:** Firewall ek building ka security guard hai jo decide karta hai ki kaun andar aa sakta hai (incoming) aur kaun bahar ja sakta hai (outgoing). Rules wo list hai jisme likha hai ki kaun allowed hai aur kaun nahi.

### **3. VPS Admin ke liye Kyun Zaroori Hai? (Why important for admins?)**
- Unauthorized access rokna
- DDoS attacks mitigate karna
- Specific services ko expose karna
- Network segmentation
- Compliance requirements

### **4. Ise Kab Use Karna Chahiye? (When to use it?)**
- Server setup ke dauran
- New service deploy karte waqt
- Security audit mein
- Attack detect hone par
- Production deployment se pehle

### **5. Agar Ye Pata Nahi Hoga Toh Kya Hoga? (If not known then what?)** üòü
Server completely exposed rahega. Unauthorized access ho sakta hai. Brute force attacks successful honge. Compliance fail ho jayega. Security nightmare.

### **6. Ye Kaise Kaam Karta Hai? / Syntax aur Options**

**UFW (Ubuntu/Debian):**
```bash
# Enable/Disable
sudo ufw enable
sudo ufw disable

# Status
sudo ufw status
sudo ufw status verbose

# Default policies
sudo ufw default deny incoming
sudo ufw default allow outgoing

# Allow services
sudo ufw allow ssh
sudo ufw allow 22/tcp
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# Allow from specific IP
sudo ufw allow from 192.168.1.100
sudo ufw allow from 192.168.1.0/24 to any port 22

# Deny
sudo ufw deny 23/tcp

# Delete rule
sudo ufw delete allow 80/tcp
sudo ufw delete 3

# Reset
sudo ufw reset
```

**Firewalld (RHEL/CentOS):**
```bash
# Status
sudo systemctl status firewalld
sudo firewall-cmd --state

# Zones
sudo firewall-cmd --get-default-zone
sudo firewall-cmd --list-all

# Add service
sudo firewall-cmd --add-service=http --permanent
sudo firewall-cmd --add-port=8080/tcp --permanent

# Reload
sudo firewall-cmd --reload

# Remove
sudo firewall-cmd --remove-service=http --permanent
```

**iptables (Advanced):**
```bash
# List rules
sudo iptables -L -n -v

# Allow SSH
sudo iptables -A INPUT -p tcp --dport 22 -j ACCEPT

# Allow HTTP/HTTPS
sudo iptables -A INPUT -p tcp --dport 80 -j ACCEPT
sudo iptables -A INPUT -p tcp --dport 443 -j ACCEPT

# Drop all other
sudo iptables -A INPUT -j DROP

# Save rules
sudo iptables-save > /etc/iptables/rules.v4
```

### **7. Command Example (Poori Explanation ke Saath)**

**Scenario 1: Basic UFW setup**
```bash
sudo ufw default deny incoming
sudo ufw default allow outgoing
sudo ufw allow ssh
sudo ufw allow http
sudo ufw allow https
sudo ufw enable
```

**Scenario 2: Specific IP allow**
```bash
sudo ufw allow from 203.0.113.100 to any port 22
```

| Command Part | Matlab |
|--------------|--------|
| `allow from` | IP se allow karo |
| `203.0.113.100` | Specific IP |
| `to any port 22` | SSH port par |

**Scenario 3: Status check**
```bash
sudo ufw status numbered
```

**Expected Output:**
```
Status: active
[1] 22/tcp    ALLOW IN    Anywhere
[2] 80/tcp    ALLOW IN    Anywhere
[3] 443/tcp   ALLOW IN    Anywhere
```

**Scenario 4: Rate limiting (brute force protection)**
```bash
sudo ufw limit ssh
```

### **8. Beginners ki Aam Galtiyan (Common Mistakes)**
- SSH block kar dena (khud ko lock out)
- Rules enable karne se pehle SSH allow na karna
- Default deny set karke services allow na karna
- Firewall enable karke reload na karna
- Testing production par directly

### **9. Best Practices / Pro Tips**
- **CRITICAL Fix:** Hamesha SSH allow karein firewall enable karne se PEHLE
- Default deny incoming, allow outgoing
- Rate limiting SSH par: `ufw limit ssh`
- Specific IPs ko whitelist karein admin access ke liye
- Regular audit: `ufw status verbose`
- Backup rules: `ufw status numbered > firewall_backup.txt`

### **10. Asli Duniya ka Scenario (Real-World Scenario)**
Ek admin ne naya server setup kiya. Usne firewall enable kiya lekin SSH allow karna bhool gaya. Connection lost ho gaya aur console access lena pada. Lesson: Hamesha SSH pehle allow karein.

Dusre case mein, server par brute force attacks ho rahe the. Admin ne `ufw limit ssh` enable kiya jo 30 seconds mein 6 se zyada connections block karta hai. Attacks automatically block ho gaye.

### **11. Checklist / Chota Recap (TL;DR)**
- `ufw enable` - Firewall on
- `ufw allow ssh` - SSH allow (PEHLE!)
- `ufw allow 80/tcp` - HTTP
- `ufw status` - Check rules
- `ufw limit ssh` - Rate limiting

### **12. Aksar Puche Jaane Wale Sawaal (FAQs)**

**Q1: UFW aur iptables mein kya fark hai?**
A: UFW iptables ka user-friendly frontend hai. Backend mein iptables hi use hota hai.

**Q2: Khud ko lock out ho gaye to?**
A: Console/VNC access se login karein aur firewall fix karein.

**Q3: Firewall test kaise karein?**
A: `nmap` se external scan karein ya `telnet ip port` try karein.

**Q4: Rate limiting kya hai?**
A: Connection attempts ko limit karna (e.g., 6 connections per 30 seconds).

**Q5: Kya firewall 100% security deta hai?**
A: Nahi. Ye ek layer hai. Application-level security bhi zaroori hai.

### **13. Practice ke liye Task**
1. `sudo ufw status` - Current status
2. `sudo ufw allow 8080/tcp` - Custom port
3. `sudo ufw status numbered` - Verify
4. `sudo ufw delete 1` - Delete rule
5. `sudo ufw reset` - Reset (test environment)

**Expected Output:** Rules added/deleted successfully.

### **14. Extra / Advanced Jaankari (Optional)**
- **nftables:** Modern replacement for iptables
- **fail2ban:** Automatic IP banning
- **Port knocking:** Hidden port opening
- **GeoIP blocking:** Country-based filtering

### **15. Aakhri Choti Summary (5 lines)**
- Firewall network traffic control karta hai
- UFW simple, iptables powerful
- Default deny incoming, allow outgoing
- SSH hamesha pehle allow karein
- Rate limiting brute force rokta hai

> **Ye Zaroor Yaad Rakhein**
> 1. SSH pehle allow: `ufw allow ssh`
> 2. Default deny: `ufw default deny incoming`
> 3. Status check: `ufw status verbose`
> 4. Rate limit: `ufw limit ssh`
> 5. Test before production!

---

## **Topic 2: Intrusion Detection & Prevention (fail2ban, PSAD)**

### **1. Topic ka Naam / Ek Line Mein Summary** üöÄ
**Intrusion Detection:** Automated attack detection aur blocking - smart defense system.

### **2. Ye Kya Hai? (What is it?)**
Fail2ban aur PSAD tools hain jo logs monitor karte hain aur suspicious activities (brute force, port scans) detect karke automatically attackers ko ban kar dete hain.

**Analogy:** Ye ek smart CCTV system hai jo sirf record nahi karta, balki suspicious behavior detect karke automatically alarm baja deta hai aur intruder ko block kar deta hai.

### **3. VPS Admin ke liye Kyun Zaroori Hai? (Why important?)**
- Brute force attacks automatic block
- Port scan detection
- DDoS mitigation
- Automated response
- Log-based threat detection

### **4. Ise Kab Use Karna Chahiye? (When to use it?)**
- Production servers par
- Public-facing services ke liye
- SSH, web servers protect karne ke liye
- Automated security chahiye
- 24/7 monitoring ke liye

### **5. Agar Ye Pata Nahi Hoga Toh Kya Hoga? (If not known then what?)** üòü
Manual monitoring karna padega. Brute force attacks successful ho sakte hain. Response time slow hoga. Attackers ko multiple attempts milenge.

### **6. Ye Kaise Kaam Karta Hai? / Syntax aur Options**

**Fail2ban Installation:**
```bash
# Install
sudo apt install fail2ban -y

# Start
sudo systemctl start fail2ban
sudo systemctl enable fail2ban

# Status
sudo systemctl status fail2ban
sudo fail2ban-client status
```

**Configuration:**
```bash
# Main config
/etc/fail2ban/jail.conf

# Local overrides (recommended)
sudo cp /etc/fail2ban/jail.conf /etc/fail2ban/jail.local
sudo nano /etc/fail2ban/jail.local
```

**Basic jail.local:**
```ini
[DEFAULT]
bantime = 3600
findtime = 600
maxretry = 5
destemail = admin@example.com
action = %(action_mwl)s

[sshd]
enabled = true
port = ssh
logpath = /var/log/auth.log
maxretry = 3

[nginx-http-auth]
enabled = true
port = http,https
logpath = /var/log/nginx/error.log
```

**Fail2ban Commands:**
```bash
# Status
sudo fail2ban-client status
sudo fail2ban-client status sshd

# Unban IP
sudo fail2ban-client set sshd unbanip 192.168.1.100

# Ban IP manually
sudo fail2ban-client set sshd banip 192.168.1.100

# Reload
sudo fail2ban-client reload
```

**PSAD (Port Scan Attack Detector):**
```bash
# Install
sudo apt install psad -y

# Configure
sudo nano /etc/psad/psad.conf

# Status
sudo psad --Status
```

### **7. Command Example (Poori Explanation ke Saath)**

**Scenario 1: Fail2ban status**
```bash
sudo fail2ban-client status sshd
```

**Expected Output:**
```
Status for the jail: sshd
|- Filter
|  |- Currently failed: 2
|  |- Total failed:     15
|  `- File list:        /var/log/auth.log
`- Actions
   |- Currently banned: 1
   |- Total banned:     3
   `- Banned IP list:   203.0.113.50
```

**Scenario 2: Unban IP**
```bash
sudo fail2ban-client set sshd unbanip 203.0.113.50
```

**Scenario 3: Check banned IPs**
```bash
sudo iptables -L -n | grep DROP
```

**Scenario 4: Custom jail**
```bash
sudo nano /etc/fail2ban/jail.local
```

Add:
```ini
[custom-app]
enabled = true
port = 8080
logpath = /var/log/custom-app.log
maxretry = 5
bantime = 7200
```

### **8. Beginners ki Aam Galtiyan (Common Mistakes)**
- jail.conf directly edit karna (updates overwrite)
- Khud ko ban kar lena (whitelist bhoolna)
- Logs path galat hona
- Service restart na karna config change ke baad
- Email notifications configure na karna

### **9. Best Practices / Pro Tips**
- **CRITICAL Fix:** Apna IP whitelist karein: `ignoreip = 127.0.0.1/8 your-ip`
- jail.local use karein, jail.conf nahi
- Email notifications enable karein
- Ban time reasonable rakhein (1-24 hours)
- Regular monitoring: `fail2ban-client status`
- Logs regularly check karein: `/var/log/fail2ban.log`

### **10. Asli Duniya ka Scenario (Real-World Scenario)**
Ek server par daily 1000+ SSH brute force attempts ho rahe the. Admin ne fail2ban install kiya with maxretry=3 aur bantime=3600. Pehle din mein 50+ IPs automatically ban ho gaye. Successful attacks zero ho gaye.

### **11. Checklist / Chota Recap (TL;DR)**
- Install: `apt install fail2ban`
- Config: `/etc/fail2ban/jail.local`
- Status: `fail2ban-client status`
- Unban: `fail2ban-client set jail unbanip IP`
- Whitelist apna IP

### **12. Aksar Puche Jaane Wale Sawaal (FAQs)**

**Q1: Fail2ban kaise kaam karta hai?**
A: Logs monitor karta hai, patterns match karta hai, iptables rules add karke ban karta hai.

**Q2: Khud ko ban ho gaye to?**
A: Console se login karein, `/etc/fail2ban/jail.local` mein apna IP whitelist karein.

**Q3: Ban time kitna rakhein?**
A: 1 hour (3600) se 24 hours (86400) reasonable hai.

**Q4: Kya permanent ban kar sakte hain?**
A: Haan, `bantime = -1` set karein.

**Q5: Email notifications kaise enable karein?**
A: `destemail` aur `action = %(action_mwl)s` set karein jail.local mein.

### **13. Practice ke liye Task**
1. `sudo apt install fail2ban -y` - Install
2. `sudo systemctl status fail2ban` - Check
3. `sudo fail2ban-client status` - Jails list
4. `sudo fail2ban-client status sshd` - SSH jail
5. `sudo tail -f /var/log/fail2ban.log` - Live monitoring

**Expected Output:** Fail2ban running, jails active.

### **14. Extra / Advanced Jaankari (Optional)**
- **Custom filters:** Regex patterns for specific attacks
- **Recidive jail:** Repeat offenders ko longer ban
- **CloudFlare integration:** WAF-level blocking
- **OSSEC:** Host-based IDS

### **15. Aakhri Choti Summary (5 lines)**
- Fail2ban automated attack blocking
- Logs monitor karke suspicious IPs ban
- jail.local mein configuration
- Apna IP whitelist zaroori
- Email notifications enable karein

> **Ye Zaroor Yaad Rakhein**
> 1. jail.local use karein, jail.conf nahi
> 2. Whitelist: `ignoreip = your-ip`
> 3. Status: `fail2ban-client status`
> 4. Unban: `fail2ban-client set jail unbanip IP`
> 5. Logs: `/var/log/fail2ban.log`

---

## **Module 9 Takeaway (Part 1)**

Is module ke pehle 2 topics mein humne defense mechanisms seekhe. Firewall (UFW/iptables) network-level protection provide karta hai - incoming traffic control aur rate limiting. Fail2ban automated intrusion detection aur prevention - brute force attacks ko automatically block karta hai. Ye dono tools har production server par hone chahiye. Defense-in-depth approach important hai - multiple layers of security. Next topics mein GRUB password aur Linux password security seekhenge.

**Remaining topics:** GRUB Password, Linux Password Security, SELinux/AppArmor intro! üõ°Ô∏è

