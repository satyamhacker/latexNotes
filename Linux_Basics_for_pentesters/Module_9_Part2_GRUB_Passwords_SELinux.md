# **Module 9: Security Hardening & Defense (Part 2)**

## **Topic 3: GRUB ko Password se Secure karna**

### **1. Topic ka Naam / Ek Line Mein Summary** ðŸš€
**GRUB Password Protection:** Boot loader ko secure karna - physical access attacks rokna.

### **2. Ye Kya Hai? (What is it?)**
GRUB password protection wo security measure hai jo boot parameters edit karne aur single-user mode mein boot karne ke liye password require karta hai, jisse physical access attacks (jaise password reset) prevent hote hain.

**Analogy:** Ye building ke main gate par lock lagane jaisa hai. Agar koi physically building tak pahunch bhi jaye, to bina key (password) ke andar nahi aa sakta.

### **3. VPS Admin ke liye Kyun Zaroori Hai? (Why important?)**
- Physical access attacks rokna
- Single-user mode protect karna
- Boot parameters tampering prevent karna
- Compliance requirements
- Data center security

### **4. Ise Kab Use Karna Chahiye? (When to use it?)**
- Physical access possible ho
- High-security environments
- Compliance requirements
- Data center servers
- Multi-user systems

### **5. Agar Ye Pata Nahi Hoga Toh Kya Hoga? (If not known then what?)** ðŸ˜Ÿ
Physical access wala koi bhi GRUB edit karke single-user mode mein boot kar sakta hai aur bina password root access le sakta hai. Complete system compromise.

### **6. Ye Kaise Kaam Karta Hai? / Syntax aur Options**

**Password Generation:**
```bash
# Generate encrypted password
grub-mkpasswd-pbkdf2

# Enter password when prompted
# Copy the generated hash: grub.pbkdf2.sha512.10000.HASH...
```

**Configuration (Debian/Ubuntu):**
```bash
# Backup
sudo cp /etc/grub.d/40_custom /etc/grub.d/40_custom.bak

# Edit
sudo nano /etc/grub.d/40_custom

# Add at end:
set superusers="root"
password_pbkdf2 root grub.pbkdf2.sha512.10000.HASH...

# Update GRUB
sudo update-grub
# or
sudo grub-mkconfig -o /boot/grub/grub.cfg
```

**Configuration (RHEL/CentOS):**
```bash
# Edit
sudo nano /etc/grub.d/40_custom

# Add same lines as above

# Update
sudo grub2-mkconfig -o /boot/grub2/grub.cfg
```

**Protect Specific Entries:**
```bash
# In /etc/grub.d/10_linux
# Add --users "" to allow boot without password
# Add --users "root" to require password
```

### **7. Command Example (Poori Explanation ke Saath)**

**Scenario 1: Generate password**
```bash
grub-mkpasswd-pbkdf2
```

**Input:** Enter password twice

**Output:**
```
PBKDF2 hash of your password is:
grub.pbkdf2.sha512.10000.ABC123...XYZ789
```

**Scenario 2: Configure GRUB**
```bash
sudo nano /etc/grub.d/40_custom
```

**Add:**
```bash
set superusers="admin"
password_pbkdf2 admin grub.pbkdf2.sha512.10000.ABC123...XYZ789
```

**Scenario 3: Update GRUB**
```bash
sudo update-grub
```

**Expected Output:**
```
Generating grub configuration file ...
Found linux image: /boot/vmlinuz-5.15.0
done
```

**Scenario 4: Test**
- Reboot system
- Press 'e' to edit boot entry
- Password prompt aayega

### **8. Beginners ki Aam Galtiyan (Common Mistakes)**
- Password bhool jaana (recovery complex)
- Backup na lena
- update-grub na chalana
- Hash copy mein error
- Testing na karna

### **9. Best Practices / Pro Tips**
- **CRITICAL Fix:** Password safe jagah note karein - bhoolne par recovery difficult
- Backup rakhein: `cp /boot/grub/grub.cfg /boot/grub/grub.cfg.bak`
- Test karein reboot se pehle (dusra session open rakhein)
- Strong password use karein
- Documentation maintain karein

### **10. Asli Duniya ka Scenario (Real-World Scenario)**
Ek company ke data center mein physical security weak thi. Pentester ne physical access li aur GRUB edit karke single-user mode mein boot kiya, root password reset kiya. Recommendation: GRUB password set karo. Implementation ke baad same attack fail ho gaya.

### **11. Checklist / Chota Recap (TL;DR)**
- `grub-mkpasswd-pbkdf2` - Password generate
- Edit `/etc/grub.d/40_custom`
- Add `set superusers` aur `password_pbkdf2`
- `update-grub` - Apply changes
- Test with reboot

### **12. Aksar Puche Jaane Wale Sawaal (FAQs)**

**Q1: Password bhool gaye to kya karein?**
A: Live USB se boot karein, chroot karein, GRUB config edit karein.

**Q2: Kya normal boot bhi password maangega?**
A: Nahi, sirf edit/single-user mode ke liye. Normal boot automatic.

**Q3: Multiple users ke liye kaise set karein?**
A: Multiple `password_pbkdf2` lines add karein different usernames ke saath.

**Q4: Kya ye 100% secure hai?**
A: Nahi. Disk encryption bhi zaroori hai full security ke liye.

**Q5: Recovery mode kaise protect karein?**
A: Same password automatically recovery mode bhi protect karega.

### **13. Practice ke liye Task**
1. `grub-mkpasswd-pbkdf2` - Generate password
2. Copy hash
3. `sudo nano /etc/grub.d/40_custom` - Edit
4. Add superusers aur password lines
5. `sudo update-grub` - Update

**Expected Output:** GRUB updated successfully.

### **14. Extra / Advanced Jaankari (Optional)**
- **Disk Encryption:** LUKS full disk encryption
- **Secure Boot:** UEFI Secure Boot
- **TPM:** Trusted Platform Module
- **Physical Security:** Lock server racks

### **15. Aakhri Choti Summary (5 lines)**
- GRUB password physical access attacks rokta hai
- `grub-mkpasswd-pbkdf2` se encrypted password
- `/etc/grub.d/40_custom` mein configure
- `update-grub` apply karne ke liye
- Password safe rakhein - recovery difficult

> **Ye Zaroor Yaad Rakhein**
> 1. Password generate: `grub-mkpasswd-pbkdf2`
> 2. Config: `/etc/grub.d/40_custom`
> 3. Update: `update-grub`
> 4. Password safe rakhein!
> 5. Backup: `/boot/grub/grub.cfg.bak`

---

## **Topic 4: Linux Password Security (/etc/passwd vs /etc/shadow)**

### **1. Topic ka Naam / Ek Line Mein Summary** ðŸš€
**Linux Password Security:** Password storage aur security mechanisms - authentication ki backbone.

### **2. Ye Kya Hai? (What is it?)**
Linux mein passwords encrypted form mein `/etc/shadow` file mein store hote hain (historically `/etc/passwd` mein the). Ye separation security improve karta hai kyunki shadow file sirf root read kar sakta hai.

**Analogy:** Purane zamane mein bank ke safe ka combination safe ke bahar likha hota tha (passwd). Ab combination alag secure vault mein hai (shadow) jahan sirf manager (root) access kar sakta hai.

### **3. VPS Admin ke liye Kyun Zaroori Hai? (Why important?)**
- Password security samajhna
- User authentication manage karna
- Security audits
- Password policies implement karna
- Troubleshooting authentication issues

### **4. Ise Kab Use Karna Chahiye? (When to use it?)**
- User management
- Security audits
- Password policy implementation
- Troubleshooting login issues
- Forensic analysis

### **5. Agar Ye Pata Nahi Hoga Toh Kya Hoga? (If not known then what?)** ðŸ˜Ÿ
Password security mechanisms samajh nahi aayenge. Troubleshooting difficult hoga. Security misconfigurations detect nahi kar payenge.

### **6. Ye Kaise Kaam Karta Hai? / Syntax aur Options**

**/etc/passwd Format:**
```
username:x:UID:GID:comment:home:shell
```

**Example:**
```
john:x:1001:1001:John Doe:/home/john:/bin/bash
```

| Field | Matlab |
|-------|--------|
| john | Username |
| x | Password placeholder (actual password shadow mein) |
| 1001 | User ID |
| 1001 | Group ID |
| John Doe | Full name/comment |
| /home/john | Home directory |
| /bin/bash | Default shell |

**/etc/shadow Format:**
```
username:$algorithm$salt$hash:lastchange:min:max:warn:inactive:expire
```

**Example:**
```
john:$6$rounds=5000$salt$hash:18900:0:99999:7:::
```

| Field | Matlab |
|-------|--------|
| john | Username |
| $6$... | Encrypted password |
| 18900 | Last password change (days since 1970) |
| 0 | Min days before change allowed |
| 99999 | Max days before change required |
| 7 | Warning days before expiry |
| | Inactive days after expiry |
| | Account expiration date |

**Password Algorithms:**
- `$1$` - MD5 (weak, avoid)
- `$5$` - SHA-256
- `$6$` - SHA-512 (recommended)
- `$y$` - yescrypt (modern)

**Commands:**
```bash
# View passwd
cat /etc/passwd

# View shadow (root only)
sudo cat /etc/shadow

# Password aging
sudo chage -l username
sudo chage -M 90 username  # Max 90 days

# Lock/unlock account
sudo passwd -l username  # Lock
sudo passwd -u username  # Unlock

# Force password change
sudo passwd -e username
```

### **7. Command Example (Poori Explanation ke Saath)**

**Scenario 1: Check password info**
```bash
sudo chage -l john
```

**Expected Output:**
```
Last password change: Jan 15, 2024
Password expires: never
Password inactive: never
Account expires: never
```

**Scenario 2: Set password expiry**
```bash
sudo chage -M 90 -W 7 john
```

| Command Part | Matlab |
|--------------|--------|
| `-M 90` | Max 90 days |
| `-W 7` | 7 days warning |
| `john` | Username |

**Scenario 3: Lock account**
```bash
sudo passwd -l john
```

**Verify:**
```bash
sudo grep john /etc/shadow
```

**Output:** `john:!$6$...` (! means locked)

**Scenario 4: Generate password hash**
```bash
openssl passwd -6 -salt xyz MyPassword123
```

**Output:** `$6$xyz$hash...`

### **8. Beginners ki Aam Galtiyan (Common Mistakes)**
- `/etc/shadow` ko normal user se read karne ki koshish
- Password expiry policies na set karna
- Weak hashing algorithms use karna
- Account locking aur unlocking confuse karna
- Password aging ignore karna

### **9. Best Practices / Pro Tips**
- **CRITICAL Fix:** SHA-512 ($6$) ya yescrypt use karein
- Password expiry policy set karein: 90 days max
- Regular audits: `sudo chage -l username`
- Strong password policy enforce karein
- PAM (Pluggable Authentication Modules) configure karein
- Failed login attempts monitor karein

### **10. Asli Duniya ka Scenario (Real-World Scenario)**
Ek company mein password policy nahi thi. Users ne passwords kabhi change nahi kiye. Security audit mein pata chala ki kuch users ke passwords 5 saal purane the. Admin ne `chage -M 90` policy implement ki. Sab users ko 90 days mein password change karna pada.

### **11. Checklist / Chota Recap (TL;DR)**
- `/etc/passwd` - User info (world-readable)
- `/etc/shadow` - Passwords (root-only)
- `chage -l user` - Password info
- `chage -M 90 user` - Max 90 days
- `passwd -l user` - Lock account

### **12. Aksar Puche Jaane Wale Sawaal (FAQs)**

**Q1: `/etc/passwd` mein 'x' ka kya matlab?**
A: Password `/etc/shadow` mein hai (shadow password system enabled).

**Q2: Password hash kaise generate karein?**
A: `openssl passwd -6 MyPassword` ya `mkpasswd -m sha-512`

**Q3: Account lock aur password expiry mein kya fark?**
A: Lock = admin ne disable kiya. Expiry = time-based automatic disable.

**Q4: Kya `/etc/shadow` backup lena chahiye?**
A: Haan, lekin secure location par (encrypted).

**Q5: Password policy kaise enforce karein?**
A: PAM modules configure karein (`/etc/pam.d/common-password`).

### **13. Practice ke liye Task**
1. `cat /etc/passwd | grep $USER` - Apni entry
2. `sudo cat /etc/shadow | grep $USER` - Password hash
3. `sudo chage -l $USER` - Password info
4. `sudo chage -M 90 testuser` - Policy set (test user)
5. `sudo chage -l testuser` - Verify

**Expected Output:** User info, password hash, aging info.

### **14. Extra / Advanced Jaankari (Optional)**
- **PAM:** Pluggable Authentication Modules
- **Password Quality:** `libpam-pwquality`
- **Two-Factor Auth:** Google Authenticator PAM
- **LDAP/AD:** Centralized authentication

### **15. Aakhri Choti Summary (5 lines)**
- `/etc/passwd` user info, `/etc/shadow` passwords
- Shadow file sirf root read kar sakta
- SHA-512 ($6$) recommended algorithm
- `chage` password aging manage karta hai
- Password policies security improve karte hain

> **Ye Zaroor Yaad Rakhein**
> 1. Shadow file root-only readable
> 2. SHA-512 ($6$) use karein
> 3. `chage -l` password info
> 4. Password expiry: `chage -M 90`
> 5. Lock: `passwd -l`, Unlock: `passwd -u`

---

## **Topic 5: Introduction to SELinux/AppArmor (Mandatory Access Control)**

### **1. Topic ka Naam / Ek Line Mein Summary** ðŸš€
**SELinux/AppArmor:** Mandatory Access Control - traditional permissions se aage ka security layer.

### **2. Ye Kya Hai? (What is it?)**
SELinux (Security-Enhanced Linux) aur AppArmor Mandatory Access Control (MAC) systems hain jo traditional Unix permissions (DAC - Discretionary Access Control) ke upar ek additional security layer provide karte hain.

**Analogy:** Traditional permissions ek simple lock hai - agar aapke paas key hai to darwaza khul jayega. SELinux/AppArmor ek smart security system hai jo ye bhi check karta hai ki aap kaun hain, kya karna chahte hain, aur kya karne ki permission hai - chahe aapke paas key ho.

### **3. VPS Admin ke liye Kyun Zaroori Hai? (Why important?)**
- Zero-day exploits se protection
- Process isolation
- Privilege escalation mitigation
- Compliance (PCI-DSS, HIPAA)
- Defense-in-depth

### **4. Ise Kab Use Karna Chahiye? (When to use it?)**
- High-security environments
- Web servers
- Database servers
- Compliance requirements
- Production systems

### **5. Agar Ye Pata Nahi Hoga Toh Kya Hoga? (If not known then what?)** ðŸ˜Ÿ
Additional security layer miss ho jayega. Exploited processes ko zyada access milega. Compliance requirements fail ho sakti hain.

### **6. Ye Kaise Kaam Karta Hai? / Syntax aur Options**

**SELinux (RHEL/CentOS/Fedora):**

**Modes:**
- **Enforcing:** Policies enforce hote hain
- **Permissive:** Violations log hote hain, block nahi
- **Disabled:** SELinux off

**Commands:**
```bash
# Status check
getenforce
sestatus

# Mode change (temporary)
sudo setenforce 0  # Permissive
sudo setenforce 1  # Enforcing

# Permanent change
sudo nano /etc/selinux/config
# Set: SELINUX=enforcing|permissive|disabled

# Context check
ls -Z /var/www/html/
ps -eZ

# Restore context
sudo restorecon -Rv /var/www/html/

# Booleans
getsebool -a
sudo setsebool -P httpd_can_network_connect on

# Troubleshooting
sudo ausearch -m avc -ts recent
sudo audit2why < /var/log/audit/audit.log
```

**AppArmor (Ubuntu/Debian):**

**Modes:**
- **Enforce:** Profile enforce hota hai
- **Complain:** Violations log, block nahi
- **Disabled:** Profile inactive

**Commands:**
```bash
# Status
sudo apparmor_status

# Profiles location
/etc/apparmor.d/

# Mode change
sudo aa-enforce /etc/apparmor.d/usr.sbin.nginx
sudo aa-complain /etc/apparmor.d/usr.sbin.nginx

# Disable profile
sudo aa-disable /etc/apparmor.d/usr.sbin.nginx

# Reload
sudo systemctl reload apparmor

# Logs
sudo journalctl -fx | grep apparmor
```

### **7. Command Example (Poori Explanation ke Saath)**

**Scenario 1: SELinux status**
```bash
sestatus
```

**Expected Output:**
```
SELinux status: enabled
Current mode: enforcing
Policy version: 33
```

**Scenario 2: AppArmor status**
```bash
sudo apparmor_status
```

**Expected Output:**
```
apparmor module is loaded.
10 profiles are loaded.
10 profiles are in enforce mode.
0 profiles are in complain mode.
```

**Scenario 3: SELinux troubleshooting**
```bash
sudo ausearch -m avc -ts recent | audit2why
```

**Scenario 4: AppArmor profile mode**
```bash
sudo aa-complain /etc/apparmor.d/usr.sbin.nginx
```

### **8. Beginners ki Aam Galtiyan (Common Mistakes)**
- SELinux/AppArmor ko disable kar dena (easy fix but insecure)
- Context/profile issues ko ignore karna
- Logs check na karna
- Permissive mode mein production run karna
- Custom policies na banana

### **9. Best Practices / Pro Tips**
- **CRITICAL Fix:** Disable na karein - troubleshoot karein
- Permissive mode mein test karein pehle
- Logs regularly check karein
- `audit2allow` se custom policies banayein
- Documentation maintain karein
- Backup policies before changes

### **10. Asli Duniya ka Scenario (Real-World Scenario)**
Ek web server par Apache exploit ho gaya. Attacker ne shell access li lekin SELinux ne `/etc/shadow` read karne se rok diya. Attacker ko limited access mili. Bina SELinux ke complete compromise ho jata.

### **11. Checklist / Chota Recap (TL;DR)**
- SELinux: `getenforce`, `sestatus`
- AppArmor: `apparmor_status`
- Troubleshoot: Logs check karein
- Disable mat karein - fix karein
- Permissive mode for testing

### **12. Aksar Puche Jaane Wale Sawaal (FAQs)**

**Q1: SELinux aur AppArmor mein kya fark hai?**
A: SELinux complex, label-based. AppArmor simple, path-based. Functionality similar.

**Q2: Kya dono ek saath use kar sakte hain?**
A: Nahi, ek hi time par ek use karein.

**Q3: Application kaam nahi kar raha, SELinux disable karein?**
A: Nahi! Permissive mode mein dalein, logs check karein, fix karein.

**Q4: Custom policies kaise banayein?**
A: SELinux: `audit2allow`. AppArmor: `aa-genprof`.

**Q5: Production mein kaun sa mode use karein?**
A: Enforcing (SELinux) ya Enforce (AppArmor).

### **13. Practice ke liye Task**
1. `getenforce` (RHEL) ya `sudo apparmor_status` (Ubuntu)
2. Check current mode
3. Test: Permissive mode enable
4. Monitor logs
5. Re-enable enforcing

**Expected Output:** Status info, mode changes.

### **14. Extra / Advanced Jaankari (Optional)**
- **SELinux Policies:** Targeted, MLS, Strict
- **AppArmor Profiles:** Custom profile creation
- **Audit Logs:** Detailed analysis
- **Troubleshooting Tools:** `setroubleshoot`

### **15. Aakhri Choti Summary (5 lines)**
- SELinux/AppArmor additional security layer
- Traditional permissions se aage
- Disable mat karein - troubleshoot karein
- Logs critical hain debugging ke liye
- Production mein enforcing mode

> **Ye Zaroor Yaad Rakhein**
> 1. SELinux: `getenforce`, AppArmor: `apparmor_status`
> 2. Disable mat karein!
> 3. Permissive/Complain mode for testing
> 4. Logs check: `ausearch`, `journalctl`
> 5. Enforcing mode in production

---

## **Module 9 Complete Takeaway**

Is module mein humne comprehensive security hardening seekhi. Firewall (UFW/iptables) network-level protection, fail2ban automated intrusion prevention, GRUB password physical access attacks rokta hai, password security mechanisms authentication ki backbone, aur SELinux/AppArmor additional MAC layer provide karta hai. Ye sab combined defense-in-depth approach banate hain. Remember: Security layers mein redundancy important hai - ek layer fail ho to dusre protect karein. Regular audits aur monitoring zaroori hai.

**Congratulations! Module 9 complete!** ðŸŽ‰

**Next:** Module 10 - Backup, Restore & Version Control! ðŸ’¾

