# **Module 10: Backup, Restore & Version Control (Part 3)** ğŸ’¾ğŸ”„

---

## **Topic 3: File-level Backups (rsync & rsnapshot)** ğŸ“ğŸ”„

---

### **1ï¸âƒ£ Topic Summary (1-2 lines)**

rsync efficient incremental file synchronization tool hai aur rsnapshot uske upar built automated snapshot-style backup system hai jo hardlinks use karke space-efficient multiple backups banata hai.

---

### **2ï¸âƒ£ Detailed Explanation with Analogy** ğŸ§ 

**Kya hai rsync aur rsnapshot?**

**rsync** - Remote sync tool jo sirf changed files/parts copy karta hai. Local ya remote backups ke liye perfect.

**rsnapshot** - rsync ke upar built tool jo Apple Time Machine jaisa snapshot-based backup system banata hai. Har backup ek complete snapshot lagta hai but actually hardlinks use karke space bachata hai.

**Key Differences:**

| Feature | rsync | rsnapshot |
|---------|-------|-----------|
| Type | Sync tool | Backup system |
| Snapshots | No | Yes (multiple versions) |
| Space Usage | Mirror copy | Hardlinks (efficient) |
| Automation | Manual/cron | Built-in scheduling |
| Retention | Manual | Automatic (hourly/daily/weekly) |

**Analogy:**

- **rsync** = Ek **photocopier** jo sirf changed pages copy karta hai - fast aur efficient
- **rsnapshot** = Ek **photo album** jo har din ki photo rakhta hai, but duplicate photos sirf ek baar store karta hai (hardlinks) - space efficient multiple backups

---

### **3ï¸âƒ£ Why is this Important?** ğŸ¯

**Sysadmin Perspective:**
- User data ka regular automated backup
- Multiple versions maintain karna (hourly/daily/weekly)
- Space-efficient backups (hardlinks)
- Remote server backups over SSH
- Quick file restoration
- Disaster recovery for data

**Pentester Perspective:**
- Backup directories mein old sensitive files
- rsync/rsnapshot configs mein credentials
- Backup timing predict karna
- Old backups mein deleted files recover karna
- Weak backup permissions exploit karna
- Backup scripts analyze karna

---

### **4ï¸âƒ£ Real-World Use Cases** ğŸ’¼

**Admin Use Cases:**
1. User home directories daily backup
2. Website files incremental backup
3. Database dumps backup to remote server
4. Multiple versions maintain (7 daily, 4 weekly)
5. Quick file recovery for users

**Pentester Use Cases:**
1. Backup directories mein deleted sensitive files
2. Old backups mein credentials search karna
3. rsnapshot config mein SSH keys
4. Backup timing observe karna
5. Weak permissions on backup files

---

### **5ï¸âƒ£ Consequences of Not Knowing** âš ï¸

**Admin Problems:**
- âŒ Manual backups time-consuming
- âŒ Full backups waste space
- âŒ No multiple versions
- âŒ File recovery difficult
- âŒ Bandwidth waste on remote backups

**Pentester Problems:**
- âŒ Backup locations miss karna
- âŒ Old sensitive data overlook karna
- âŒ Backup credentials miss karna
- âŒ Easy data access opportunities miss
- âŒ Forensic analysis incomplete

---

### **6ï¸âƒ£ Syntax & Command Structure** ğŸ“

#### **rsync Syntax:**
```bash
rsync [options] source destination

Common Options:
-a  Archive mode (preserve permissions, timestamps, etc.)
-v  Verbose
-z  Compress during transfer
-h  Human-readable
-P  Show progress + keep partial files
--delete  Delete files in dest not in source
--exclude  Exclude files/directories
-e ssh  Use SSH for remote transfer
```

#### **rsnapshot Installation:**
```bash
# Ubuntu/Debian
sudo apt install rsnapshot

# Fedora/RHEL
sudo dnf install rsnapshot

# Arch Linux
sudo pacman -S rsnapshot
```

#### **rsnapshot Commands:**
```bash
rsnapshot configtest    # Test configuration
rsnapshot -t hourly     # Test hourly backup (dry-run)
rsnapshot hourly        # Run hourly backup
rsnapshot daily         # Run daily backup
rsnapshot weekly        # Run weekly backup
```

---

### **7ï¸âƒ£ Detailed Examples with Explanation Tables** ğŸ’»

#### **Example 1: Basic rsync Local Backup**

```bash
rsync -avh --progress /home/user/documents/ /backup/documents/
```

| Part | Explanation |
|------|-------------|
| `rsync` | Sync command |
| `-a` | Archive mode (preserve everything) |
| `-v` | Verbose output |
| `-h` | Human-readable sizes |
| `--progress` | Show transfer progress |
| `/home/user/documents/` | Source (trailing slash = contents) |
| `/backup/documents/` | Destination |

**Output:**
```
sending incremental file list
report.pdf
    2.45M 100%   45.23MB/s    0:00:00
presentation.pptx
    5.12M 100%   38.91MB/s    0:00:00

sent 7.58M bytes  received 54 bytes  15.16M bytes/sec
total size is 7.57M  speedup is 1.00
```

---

#### **Example 2: rsync Remote Backup over SSH**

```bash
rsync -avz -e ssh /var/www/html/ user@backup-server:/backups/website/
```

| Part | Explanation |
|------|-------------|
| `-z` | Compress during transfer |
| `-e ssh` | Use SSH protocol |
| `/var/www/html/` | Local source |
| `user@backup-server:` | Remote host |
| `/backups/website/` | Remote destination |

**Use Case:** Production website ka remote server par backup.

---

#### **Example 3: rsync with Exclusions**

```bash
rsync -avh --exclude='*.log' --exclude='cache/' --exclude='tmp/' \
    /var/www/ /backup/www/
```

| Part | Explanation |
|------|-------------|
| `--exclude='*.log'` | Skip all .log files |
| `--exclude='cache/'` | Skip cache directory |
| `--exclude='tmp/'` | Skip tmp directory |

**Result:** Backup without unnecessary files.

---

#### **Example 4: rsync Mirror (Delete Extra Files)**

```bash
rsync -avh --delete /source/ /backup/
```

| Part | Explanation |
|------|-------------|
| `--delete` | Delete files in dest not in source |

**Use Case:** Exact mirror - agar source se file delete hui, backup se bhi delete ho jayegi.

---

#### **Example 5: rsync Dry Run (Test)**

```bash
rsync -avhn --delete /source/ /backup/
```

| Part | Explanation |
|------|-------------|
| `-n` | Dry run (don't actually transfer) |

**Output:** Shows what would be transferred without actually doing it.

---

#### **Example 6: Install and Configure rsnapshot**

```bash
# Install
sudo apt install rsnapshot -y

# Edit config
sudo nano /etc/rsnapshot.conf
```

**Key Configuration:**
```bash
# Backup root directory
snapshot_root   /backup/rsnapshot/

# Retention policy
retain  hourly  6
retain  daily   7
retain  weekly  4
retain  monthly 3

# Backup points
backup  /home/          localhost/
backup  /etc/           localhost/
backup  /var/www/       localhost/
```

---

#### **Example 7: Test rsnapshot Configuration**

```bash
sudo rsnapshot configtest
```

**Output:**
```
Syntax OK
```

**If errors:**
```
ERROR: /etc/rsnapshot.conf line 25: Interval "hourly" has no backup points!
```

---

#### **Example 8: Run rsnapshot Backup (Dry Run)**

```bash
sudo rsnapshot -t hourly
```

| Part | Explanation |
|------|-------------|
| `-t` | Test mode (dry run) |
| `hourly` | Hourly backup interval |

**Output:**
```
echo 1234 > /backup/rsnapshot/.rsnapshot.pid
mkdir -m 0755 -p /backup/rsnapshot/hourly.0/
/usr/bin/rsync -a --delete --numeric-ids /home/ /backup/rsnapshot/hourly.0/localhost/home/
/usr/bin/rsync -a --delete --numeric-ids /etc/ /backup/rsnapshot/hourly.0/localhost/etc/
```

---

#### **Example 9: Run Actual rsnapshot Backup**

```bash
sudo rsnapshot hourly
```

**Creates directory structure:**
```
/backup/rsnapshot/
â”œâ”€â”€ hourly.0/    (most recent)
â”œâ”€â”€ hourly.1/
â”œâ”€â”€ hourly.2/
â”œâ”€â”€ daily.0/
â”œâ”€â”€ daily.1/
â””â”€â”€ weekly.0/
```

---

#### **Example 10: Automate rsnapshot with Cron**

```bash
sudo crontab -e
```

**Add entries:**
```bash
# Hourly backup at 30 minutes past the hour
30 */1 * * * /usr/bin/rsnapshot hourly

# Daily backup at 3:30 AM
30 3 * * * /usr/bin/rsnapshot daily

# Weekly backup on Sunday at 3:00 AM
0 3 * * 0 /usr/bin/rsnapshot weekly

# Monthly backup on 1st at 2:30 AM
30 2 1 * * /usr/bin/rsnapshot monthly
```

---

### **8ï¸âƒ£ Common Mistakes & How to Avoid** âŒâ¡ï¸âœ…

| Mistake | Problem | Solution |
|---------|---------|----------|
| Missing trailing slash | Copies folder instead of contents | Use `/source/` not `/source` |
| No `--delete` for mirror | Old files accumulate | Add `--delete` for exact mirror |
| Forgetting `-z` for remote | Slow transfer | Always use `-z` for compression |
| Wrong rsnapshot intervals | Backups don't rotate | Run in order: hourlyâ†’dailyâ†’weekly |
| Tabs vs spaces in rsnapshot.conf | Config errors | Use TABS not spaces |
| No backup verification | Corrupt backups undetected | Test restore regularly |
| Backing up to same disk | Disk failure = no backup | Use separate disk/server |
| No exclusions | Backup unnecessary files | Exclude logs, cache, tmp |

---

### **9ï¸âƒ£ Best Practices & Pro Tips** â­

**Admin Best Practices:**
1. âœ… **Test First**: Always dry run (`-n`) before actual backup
2. âœ… **Compression**: Use `-z` for remote backups
3. âœ… **Exclusions**: Exclude logs, cache, temp files
4. âœ… **Separate Disk**: Backup to different physical disk
5. âœ… **Monitor**: Check backup logs regularly
6. âœ… **Test Restore**: Monthly restore testing
7. âœ… **Bandwidth Limit**: Use `--bwlimit` for production servers
8. âœ… **Retention Policy**: Define clear retention (7 daily, 4 weekly)

**Pentester Pro Tips:**
1. ğŸ” **Find Backups**: `/backup/`, `/var/backups/`, `/mnt/backup/`
2. ğŸ” **Check Permissions**: `find / -name "*backup*" -readable 2>/dev/null`
3. ğŸ” **rsnapshot Config**: `/etc/rsnapshot.conf` may have SSH keys
4. ğŸ” **Old Backups**: Deleted files still in old snapshots
5. ğŸ” **Backup Scripts**: Often contain credentials
6. ğŸ” **Timing Analysis**: Cron jobs reveal backup schedules
7. ğŸ” **Hardlinks**: Multiple snapshots = same data (space efficient)
8. ğŸ” **Remote Backups**: Check for SSH keys in backup scripts

---

### **ğŸ”Ÿ Real-World Scenarios** ğŸŒ

#### **Scenario 1: Automated Website Backup (Admin)**

**Situation:** Production website ka daily backup with 7-day retention.

**Solution:**
```bash
# Create backup script
sudo nano /usr/local/bin/website_backup.sh
```

**Script:**
```bash
#!/bin/bash
DATE=$(date +%Y%m%d)
BACKUP_DIR="/backup/website"
SOURCE="/var/www/html"

# Create backup
rsync -avz --delete \
    --exclude='cache/' \
    --exclude='*.log' \
    "$SOURCE/" "$BACKUP_DIR/current/"

# Create dated snapshot (hardlink)
cp -al "$BACKUP_DIR/current" "$BACKUP_DIR/$DATE"

# Delete backups older than 7 days
find "$BACKUP_DIR" -maxdepth 1 -type d -mtime +7 -exec rm -rf {} \;

echo "Backup completed: $DATE" | logger -t website-backup
```

```bash
# Make executable
sudo chmod +x /usr/local/bin/website_backup.sh

# Add to cron (daily at 2 AM)
echo "0 2 * * * /usr/local/bin/website_backup.sh" | sudo crontab -
```

**Result:** Daily backups with 7-day history, space-efficient!

---

#### **Scenario 2: User Home Directory Backup with rsnapshot (Admin)**

**Situation:** All user home directories ka automated backup with multiple versions.

**Solution:**
```bash
# Install rsnapshot
sudo apt install rsnapshot -y

# Configure
sudo nano /etc/rsnapshot.conf
```

**Configuration:**
```bash
config_version  1.2
snapshot_root   /backup/rsnapshot/
cmd_cp          /bin/cp
cmd_rm          /bin/rm
cmd_rsync       /usr/bin/rsync
cmd_logger      /usr/bin/logger

retain  hourly  6
retain  daily   7
retain  weekly  4
retain  monthly 3

verbose         2
loglevel        3
logfile         /var/log/rsnapshot.log

# Backup points
backup  /home/          localhost/
backup  /etc/           localhost/

# Exclusions
exclude         .cache/
exclude         .thumbnails/
exclude         *.tmp
```

```bash
# Test config
sudo rsnapshot configtest

# Test backup
sudo rsnapshot -t hourly

# Setup cron
sudo crontab -e
```

**Cron entries:**
```bash
0 */4 * * *     /usr/bin/rsnapshot hourly
30 3 * * *      /usr/bin/rsnapshot daily
0 3 * * 1       /usr/bin/rsnapshot weekly
30 2 1 * *      /usr/bin/rsnapshot monthly
```

**Result:** 6 hourly, 7 daily, 4 weekly, 3 monthly backups!

---

#### **Scenario 3: Remote Server Backup (Admin)**

**Situation:** Production server ka backup remote backup server par.

**Solution:**
```bash
# Setup SSH key (passwordless)
ssh-keygen -t ed25519 -f ~/.ssh/backup_key
ssh-copy-id -i ~/.ssh/backup_key.pub user@backup-server

# Create backup script
nano ~/remote_backup.sh
```

**Script:**
```bash
#!/bin/bash
REMOTE_USER="backup"
REMOTE_HOST="backup-server.com"
REMOTE_DIR="/backups/$(hostname)"
LOCAL_DIRS="/var/www /etc /home"

for DIR in $LOCAL_DIRS; do
    echo "Backing up $DIR..."
    rsync -avz --delete \
        -e "ssh -i ~/.ssh/backup_key" \
        "$DIR/" \
        "$REMOTE_USER@$REMOTE_HOST:$REMOTE_DIR$(basename $DIR)/"
done

echo "Remote backup completed" | logger -t remote-backup
```

```bash
chmod +x ~/remote_backup.sh

# Add to cron (daily at 1 AM)
echo "0 1 * * * $HOME/remote_backup.sh" | crontab -
```

**Result:** Daily offsite backup for disaster recovery!

---

#### **Scenario 4: Finding Deleted Sensitive Files (Pentester)**

**Situation:** Target server pe rsnapshot backups hain, deleted files recover karne hain.

**Attack:**
```bash
# Check for rsnapshot
ls -la /backup/rsnapshot/

# List snapshots
ls -la /backup/rsnapshot/
# daily.0/ daily.1/ daily.2/ ... daily.6/

# Current system pe file nahi hai
ls /home/admin/.ssh/id_rsa
# No such file

# But old backup mein hai!
ls /backup/rsnapshot/daily.3/localhost/home/admin/.ssh/id_rsa
# -rw------- 1 admin admin 1234 Jan 10 10:00 id_rsa

# Copy private key
cp /backup/rsnapshot/daily.3/localhost/home/admin/.ssh/id_rsa /tmp/stolen_key
chmod 600 /tmp/stolen_key

# Use for SSH access
ssh -i /tmp/stolen_key admin@other-server
```

**Impact:** Deleted SSH key recovered from backup!

---

#### **Scenario 5: Backup Script Credential Extraction (Pentester)**

**Situation:** Backup scripts mein credentials search karna.

**Attack:**
```bash
# Find backup scripts
find / -name "*backup*.sh" 2>/dev/null

# Found: /root/db_backup.sh
cat /root/db_backup.sh
```

**Script content:**
```bash
#!/bin/bash
DB_USER="root"
DB_PASS="SuperSecret123"
mysqldump -u $DB_USER -p$DB_PASS --all-databases > /backup/db.sql
rsync -avz /backup/db.sql backup@backup-server:/backups/
```

**Finding:** Database credentials hardcoded!

```bash
# Also check rsnapshot config
cat /etc/rsnapshot.conf | grep -i "ssh\|password\|key"

# May find SSH key paths or credentials
```

**Impact:** Database access + backup server credentials!

---

### **1ï¸âƒ£1ï¸âƒ£ Checklist for Implementation** âœ…

**Admin Checklist:**
- [ ] rsync/rsnapshot installed
- [ ] Backup destination configured (separate disk)
- [ ] Retention policy defined
- [ ] Exclusions configured (logs, cache, tmp)
- [ ] SSH keys setup for remote backups
- [ ] Cron jobs configured
- [ ] Backup scripts secured (chmod 700)
- [ ] Logging configured
- [ ] Test restore performed
- [ ] Monitoring setup for backup failures

**Pentester Checklist:**
- [ ] Backup directories enumerated
- [ ] Backup file permissions checked
- [ ] rsnapshot config analyzed
- [ ] Backup scripts searched for credentials
- [ ] Old backups checked for deleted files
- [ ] SSH keys in backup configs checked
- [ ] Backup timing documented
- [ ] Remote backup destinations identified
- [ ] Weak permissions exploited
- [ ] Findings documented with PoC

---

### **1ï¸âƒ£2ï¸âƒ£ Frequently Asked Questions (FAQs)** â“

**Q1: rsync vs rsnapshot - kab kya use karein?**
**A:** 
- **rsync**: Simple sync/mirror, manual control, scripting
- **rsnapshot**: Automated multiple versions, Apple Time Machine style

**Q2: rsync mein trailing slash ka kya matlab?**
**A:**
- `/source/` = source ke contents copy
- `/source` = source folder itself copy

**Q3: rsnapshot kitni space leta hai?**
**A:** Pehla backup full size, baaki backups sirf changes (hardlinks use karta hai). Example: 100GB data, 7 daily backups = ~110GB (not 700GB!)

**Q4: Kya rsync encrypted hai?**
**A:** rsync itself encrypted nahi hai, but SSH ke saath use karne par encrypted ho jata hai (`-e ssh`).

**Q5: rsnapshot intervals ka order kyun important hai?**
**A:** hourlyâ†’dailyâ†’weeklyâ†’monthly order mein run karna chahiye. Pehle hourly, phir daily (jo hourly.5 ko daily.0 banata hai).

**Q6: Backup verification kaise karein?**
**A:**
```bash
# Random file restore test
rsync -avh /backup/rsnapshot/daily.0/localhost/home/user/test.txt /tmp/
diff /home/user/test.txt /tmp/test.txt
```

**Q7: Remote backup slow hai, kaise speed up karein?**
**A:**
```bash
# Compression + bandwidth limit
rsync -avz --bwlimit=5000 --compress-level=9 source/ dest/
```

**Q8: rsnapshot config mein tabs vs spaces?**
**A:** rsnapshot.conf mein TABS use karna mandatory hai, spaces se error aata hai.

---

### **1ï¸âƒ£3ï¸âƒ£ Practice Tasks with Expected Output** ğŸ¯

#### **Task 1: Basic rsync Backup**
```bash
# Create test data
mkdir -p ~/source/docs
echo "Document 1" > ~/source/docs/file1.txt
echo "Document 2" > ~/source/docs/file2.txt

# Backup
rsync -avh ~/source/ ~/backup/

# Verify
ls -la ~/backup/docs/
```

**Expected Output:**
```
drwxrwxr-x 2 user user 4096 Jan 15 10:30 .
-rw-rw-r-- 1 user user   11 Jan 15 10:30 file1.txt
-rw-rw-r-- 1 user user   11 Jan 15 10:30 file2.txt
```

---

#### **Task 2: rsync with Exclusions**
```bash
# Create test structure
mkdir -p ~/source/{docs,logs,cache}
echo "Important" > ~/source/docs/important.txt
echo "Log data" > ~/source/logs/app.log
echo "Cache data" > ~/source/cache/temp.cache

# Backup excluding logs and cache
rsync -avh --exclude='logs/' --exclude='cache/' ~/source/ ~/backup/

# Verify
ls ~/backup/
# Should only show: docs/
```

---

#### **Task 3: Install and Test rsnapshot**
```bash
# Install
sudo apt install rsnapshot -y

# Test config
sudo rsnapshot configtest

# Dry run
sudo rsnapshot -t hourly
```

**Expected:** Shows rsync commands that would run.

---

#### **Task 4: Restore File from rsnapshot**
```bash
# Assume rsnapshot configured and running
# Delete a file
rm ~/documents/important.txt

# Find in backup
ls /backup/rsnapshot/daily.0/localhost/home/$(whoami)/documents/

# Restore
cp /backup/rsnapshot/daily.0/localhost/home/$(whoami)/documents/important.txt ~/documents/

# Verify
cat ~/documents/important.txt
```

---

### **1ï¸âƒ£4ï¸âƒ£ Advanced Information & Edge Cases** ğŸš€

#### **Advanced Technique 1: rsync with Bandwidth Limit**

```bash
# Limit to 1MB/s (1000 KB/s)
rsync -avz --bwlimit=1000 /source/ user@remote:/backup/
```

**Use Case:** Production server backup without affecting network performance.

---

#### **Advanced Technique 2: rsync with Progress for Large Files**

```bash
rsync -avh --progress --partial /large_file.iso /backup/
```

| Option | Purpose |
|--------|---------|
| `--progress` | Show per-file progress |
| `--partial` | Keep partially transferred files |

**Use Case:** Resume interrupted transfers.

---

#### **Advanced Technique 3: rsnapshot with Remote Backups**

```bash
# In /etc/rsnapshot.conf
backup  user@remote-server:/var/www/  remote-server/
```

**Result:** Backup remote server to local rsnapshot.

---

#### **Advanced Technique 4: rsync with Checksum Verification**

```bash
rsync -avhc /source/ /backup/
```

| Option | Purpose |
|--------|---------|
| `-c` | Use checksum instead of timestamp |

**Use Case:** Ensure data integrity, detect corrupted files.

---

#### **Edge Case 1: Sparse Files**

```bash
# Preserve sparse files (like VM images)
rsync -avhS /source/ /backup/
```

**Why:** Sparse files have "holes" - S option preserves them.

---

#### **Edge Case 2: Hardlinks Preservation**

```bash
# Preserve hardlinks
rsync -avhH /source/ /backup/
```

**Why:** Multiple filenames pointing to same data.

---

### **1ï¸âƒ£5ï¸âƒ£ Final Summary & Key Takeaways** ğŸ“Œ

**Key Concepts:**
1. **rsync** - Efficient incremental file sync
2. **rsnapshot** - Automated snapshot-based backups
3. **Hardlinks** - Space-efficient multiple versions
4. **Retention** - Hourly/daily/weekly/monthly
5. **Remote Backups** - SSH-based offsite backups

**Critical Commands:**
```bash
# rsync basic
rsync -avh /source/ /dest/

# rsync remote
rsync -avz -e ssh /source/ user@remote:/dest/

# rsnapshot
sudo rsnapshot hourly
sudo rsnapshot daily
```

**Admin Takeaways:**
- âœ… Use rsync for simple sync/mirror
- âœ… Use rsnapshot for multiple versions
- âœ… Always test with dry run first
- âœ… Exclude unnecessary files (logs, cache)
- âœ… Backup to separate disk/server
- âœ… Automate with cron
- âœ… Test restore regularly
- âœ… Monitor backup success/failure

**Pentester Takeaways:**
- ğŸ” Check common backup locations
- ğŸ” Analyze backup scripts for credentials
- ğŸ” Old backups contain deleted files
- ğŸ” rsnapshot config may have SSH keys
- ğŸ” Weak permissions on backups
- ğŸ” Backup timing reveals patterns
- ğŸ” Remote backup destinations
- ğŸ” Hardlinks = same data, multiple paths

**Remember:**
- Trailing slash matters in rsync!
- rsnapshot uses TABS not spaces
- Test before running in production
- Separate disk for backups
- Offsite backup for disaster recovery

**Next Topic:** Database Backups (mysqldump) & Point-in-Time Recovery ğŸ—„ï¸

---

**Happy Backing Up! ğŸ“ğŸ”„**
