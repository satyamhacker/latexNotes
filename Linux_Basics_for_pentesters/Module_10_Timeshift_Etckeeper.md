# **Module 10: Backup, Restore & Version Control** ğŸ’¾ğŸ”„

---

## **Topic 1: System Snapshots with Timeshift** â±ï¸ğŸ“¸

---

### **1ï¸âƒ£ Topic Summary (1-2 lines)**

Timeshift Linux ka system snapshot tool hai jo Windows System Restore ki tarah kaam karta hai - poore system ka snapshot lekar ek click mein previous state restore kar sakte ho.

---

### **2ï¸âƒ£ Detailed Explanation with Analogy** ğŸ§ 

**Kya hai Timeshift?**

Timeshift ek backup utility hai jo Linux system ka complete snapshot leta hai. Ye rsync ya BTRFS filesystem snapshots use karta hai. Agar system update fail ho jaye, misconfiguration ho jaye, ya malware attack ho, toh aap ek click mein previous working state restore kar sakte ho.

**Timeshift Features:**

1. **RSYNC Mode** - File-level incremental backups (kisi bhi filesystem ke saath)
2. **BTRFS Mode** - Filesystem-level snapshots (sirf BTRFS filesystem ke saath)
3. **Scheduled Snapshots** - Automatic daily/weekly/monthly snapshots
4. **Incremental Backups** - Sirf changes save hote hain (space efficient)
5. **Boot Restore** - Live USB se bhi restore kar sakte ho

**Analogy:**

Timeshift ek **time machine** ki tarah hai. Jaise movies mein time travel karke past mein ja sakte ho, waise hi Timeshift se aap apne system ko past ki kisi bhi working state mein le ja sakte ho. Update kiya aur system crash? No problem - ek click mein wapas previous state!

---

### **3ï¸âƒ£ Why is this Important?** ğŸ¯

**Sysadmin Perspective:**
- System updates safely test kar sakte ho
- Configuration changes rollback kar sakte ho
- Disaster recovery in minutes (not hours)
- Production server downtime minimize
- User error se quick recovery
- Ransomware attack se protection

**Pentester Perspective:**
- Target system pe Timeshift snapshots analyze karna
- Old snapshots mein outdated vulnerable configs
- Snapshot files mein sensitive data
- Snapshot restore se malicious changes revert
- Snapshot locations often weak permissions
- Forensics - system history analysis

---

### **4ï¸âƒ£ Real-World Use Cases** ğŸ’¼

**Admin Use Cases:**
1. Before major system updates (kernel, drivers)
2. Before installing new software packages
3. Before configuration file changes
4. Daily automated system snapshots
5. Quick rollback after failed updates

**Pentester Use Cases:**
1. Snapshot files mein old credentials dhundhna
2. Previous system states analyze karna
3. Snapshot restore se persistence remove hona
4. Weak snapshot permissions exploit karna
5. Snapshot timing se admin activity predict karna

---

### **5ï¸âƒ£ Consequences of Not Knowing** âš ï¸

**Admin Problems:**
- âŒ Failed updates se system permanently broken
- âŒ Configuration mistakes se long downtime
- âŒ Manual recovery time-consuming
- âŒ Data loss risk increase
- âŒ No quick rollback option

**Pentester Problems:**
- âŒ Historical system data miss karna
- âŒ Old vulnerable configs overlook karna
- âŒ Snapshot-based persistence miss karna
- âŒ Forensic analysis incomplete
- âŒ Attack surface analysis weak

---

### **6ï¸âƒ£ Syntax & Command Structure** ğŸ“

#### **Timeshift Installation:**
```bash
# Ubuntu/Debian
sudo apt update
sudo apt install timeshift

# Fedora/RHEL
sudo dnf install timeshift

# Arch Linux
sudo pacman -S timeshift
```

#### **Timeshift Commands:**
```bash
timeshift --list                    # List all snapshots
timeshift --create                  # Create snapshot
timeshift --restore                 # Restore from snapshot
timeshift --delete --snapshot NAME  # Delete specific snapshot
timeshift --check                   # Check for scheduled snapshots
```

#### **Timeshift Options:**
```bash
--rsync              # Use RSYNC mode
--btrfs              # Use BTRFS mode
--comments "text"    # Add comment to snapshot
--tags {O,B,H,D,W,M} # Tag: Ondemand, Boot, Hourly, Daily, Weekly, Monthly
```

---

### **7ï¸âƒ£ Detailed Examples with Explanation Tables** ğŸ’»

#### **Example 1: Install and Setup Timeshift**

```bash
sudo apt install timeshift -y
sudo timeshift --list
```

| Part | Explanation |
|------|-------------|
| `apt install timeshift` | Install Timeshift package |
| `-y` | Auto-confirm installation |
| `timeshift --list` | Show existing snapshots |

**First Run Output:**
```
No snapshots found
```

---

#### **Example 2: Create First Snapshot**

```bash
sudo timeshift --create --comments "Initial system snapshot" --tags O
```

| Part | Explanation |
|------|-------------|
| `--create` | Create new snapshot |
| `--comments "..."` | Add description |
| `--tags O` | Tag as On-demand snapshot |

**Output:**
```
Creating new snapshot...(RSYNC)
Saving to device: /dev/sda1
Syncing files with rsync...
Created control file: /timeshift/snapshots/2024-01-15_10-30-45/info.json
RSYNC Snapshot saved successfully (15s)
Tagged snapshot '2024-01-15_10-30-45': ondemand
```

---

#### **Example 3: List All Snapshots**

```bash
sudo timeshift --list
```

**Output:**
```
Device : /dev/sda1
UUID   : 1234-5678-90ab-cdef

Num     Name                 Tags  Description
------------------------------------------------------------------------------
0    >  2024-01-15_10-30-45  O     Initial system snapshot
1       2024-01-14_02-00-00  D     Daily snapshot
2       2024-01-13_02-00-00  D     Daily snapshot
```

---

#### **Example 4: Restore from Snapshot**

```bash
sudo timeshift --restore --snapshot '2024-01-15_10-30-45'
```

| Part | Explanation |
|------|-------------|
| `--restore` | Restore system |
| `--snapshot 'NAME'` | Specific snapshot name |

**Interactive Prompt:**
```
WARNING: This will restore your system to the selected snapshot.
All current files will be replaced.
Continue? (y/n):
```

---

#### **Example 5: Create Snapshot Before Update**

```bash
# Create snapshot
sudo timeshift --create --comments "Before kernel update" --tags B

# Perform update
sudo apt upgrade linux-image-generic

# If update fails, restore
sudo timeshift --restore --snapshot '2024-01-15_11-00-00'
```

---

#### **Example 6: Delete Old Snapshot**

```bash
sudo timeshift --delete --snapshot '2024-01-10_02-00-00'
```

| Part | Explanation |
|------|-------------|
| `--delete` | Delete snapshot |
| `--snapshot 'NAME'` | Snapshot to delete |

**Output:**
```
Removing '2024-01-10_02-00-00'...
Removed successfully
```

---

#### **Example 7: Configure Automatic Snapshots (GUI)**

```bash
# Launch GUI
sudo timeshift-gtk
```

**GUI Settings:**
- **Snapshot Type:** RSYNC
- **Snapshot Location:** /dev/sda1
- **Schedule:**
  - âœ… Daily: Keep 5
  - âœ… Weekly: Keep 3
  - âœ… Monthly: Keep 2
- **Include:** @home (optional)

---

#### **Example 8: Check Snapshot Size**

```bash
sudo du -sh /timeshift/snapshots/*
```

**Output:**
```
2.5G    /timeshift/snapshots/2024-01-15_10-30-45
150M    /timeshift/snapshots/2024-01-14_02-00-00
180M    /timeshift/snapshots/2024-01-13_02-00-00
```

**Note:** Incremental snapshots sirf changes store karte hain, isliye size kam hota hai.

---

#### **Example 9: Pentester - Enumerate Timeshift Snapshots**

```bash
# Check if Timeshift installed
which timeshift

# List snapshots
sudo timeshift --list

# Check snapshot location
ls -la /timeshift/snapshots/

# Analyze old snapshot for credentials
sudo grep -r "password" /timeshift/snapshots/2024-01-10_02-00-00/localhost/etc/
```

---

#### **Example 10: Restore from Live USB**

```bash
# Boot from Live USB
# Mount system partition
sudo mkdir /mnt/system
sudo mount /dev/sda1 /mnt/system

# Run Timeshift
sudo timeshift --restore --snapshot '2024-01-15_10-30-45' --target /mnt/system

# Reboot
sudo reboot
```

---

### **8ï¸âƒ£ Common Mistakes & How to Avoid** âŒâ¡ï¸âœ…

| Mistake | Problem | Solution |
|---------|---------|----------|
| Snapshots on same disk | Disk failure = no backup | Use external drive for snapshots |
| No snapshots before updates | Can't rollback | Always create snapshot before changes |
| Including /home in snapshots | Huge snapshot size | Exclude /home, backup separately |
| Not testing restore | Restore may fail | Test restore process regularly |
| Too many snapshots | Disk full | Configure retention policy |
| Running as non-root | Permission denied | Always use `sudo` |
| BTRFS on ext4 | Won't work | Use RSYNC mode for ext4 |
| No snapshot comments | Can't identify snapshots | Always add descriptive comments |

---

### **9ï¸âƒ£ Best Practices & Pro Tips** â­

**Admin Best Practices:**
1. âœ… **Separate Partition**: Dedicated partition for Timeshift snapshots
2. âœ… **Before Updates**: Always snapshot before system updates
3. âœ… **Retention Policy**: Keep 5 daily, 3 weekly, 2 monthly
4. âœ… **Exclude /home**: Backup user data separately
5. âœ… **Test Restores**: Monthly restore testing
6. âœ… **External Backup**: Copy critical snapshots to external drive
7. âœ… **Monitor Space**: Check disk space regularly
8. âœ… **Document**: Note what each snapshot contains

**Pentester Pro Tips:**
1. ğŸ” **Check Timeshift**: `which timeshift` - if installed, enumerate
2. ğŸ” **Old Snapshots**: May contain outdated vulnerable configs
3. ğŸ” **Snapshot Permissions**: Check `/timeshift/` permissions
4. ğŸ” **Credentials in Snapshots**: Search old `/etc/shadow`, config files
5. ğŸ” **Snapshot Timing**: Reveals admin activity patterns
6. ğŸ” **Persistence Risk**: Snapshot restore removes backdoors
7. ğŸ” **Forensics**: Analyze system history via snapshots
8. ğŸ” **Exfiltration**: Old snapshots may have sensitive data

---

### **ğŸ”Ÿ Real-World Scenarios** ğŸŒ

#### **Scenario 1: Safe Kernel Update (Admin)**

**Situation:** Production server ka kernel update karna hai, but risk hai.

**Solution:**
```bash
# Step 1: Create snapshot
sudo timeshift --create --comments "Before kernel 5.15 update" --tags B

# Step 2: Perform update
sudo apt update
sudo apt upgrade linux-image-generic

# Step 3: Reboot and test
sudo reboot

# If system boots fine - SUCCESS!
# If system doesn't boot - Boot from Live USB and restore
```

**Result:** Agar kuch galat ho, 5 minutes mein restore!

---

#### **Scenario 2: Recover from Failed Configuration (Admin)**

**Situation:** Nginx config change kiya, ab website down hai aur config fix nahi ho raha.

**Solution:**
```bash
# Check last snapshot
sudo timeshift --list

# Restore from yesterday's snapshot
sudo timeshift --restore --snapshot '2024-01-14_02-00-00'

# System restored with working nginx config
sudo systemctl status nginx
# â— nginx.service - A high performance web server
#    Active: active (running)
```

**Result:** Website 10 minutes mein wapas online!

---

#### **Scenario 3: Ransomware Recovery (Admin)**

**Situation:** Server pe ransomware attack, files encrypted ho gayi.

**Solution:**
```bash
# Boot from Live USB
# Mount system partition
sudo mount /dev/sda1 /mnt/system

# Restore from pre-attack snapshot
sudo timeshift --restore --snapshot '2024-01-13_02-00-00' --target /mnt/system

# Reboot
sudo reboot

# System restored to pre-attack state
# All files decrypted (actually restored from backup)
```

**Result:** Ransomware se recovery without paying!

---

#### **Scenario 4: Finding Old Credentials (Pentester)**

**Situation:** Current system hardened hai, but old snapshots check karne hain.

**Attack:**
```bash
# Check Timeshift installation
which timeshift
# /usr/bin/timeshift

# List snapshots
sudo timeshift --list
# 2024-01-10_02-00-00  (6 months old)

# Search old snapshot for weak configs
sudo grep -r "PermitRootLogin yes" /timeshift/snapshots/2024-01-10_02-00-00/localhost/etc/ssh/

# Found: Old sshd_config allowed root login!

# Check old shadow file
sudo cat /timeshift/snapshots/2024-01-10_02-00-00/localhost/etc/shadow | grep root
# root:$6$old_hash...:18000:0:99999:7:::

# Try cracking old hash (might be weaker)
john --wordlist=rockyou.txt old_shadow.txt
```

**Finding:** Old snapshot mein weak password tha!

---

#### **Scenario 5: Automated Snapshot Strategy (Admin)**

**Situation:** Production server ke liye comprehensive snapshot strategy.

**Solution:**
```bash
# Install Timeshift
sudo apt install timeshift -y

# Configure via GUI
sudo timeshift-gtk
# Settings:
# - Daily: 7 snapshots
# - Weekly: 4 snapshots
# - Monthly: 3 snapshots
# - Exclude: /home, /tmp, /var/cache

# Manual snapshot before critical changes
sudo timeshift --create --comments "Before database migration" --tags O

# Verify snapshots
sudo timeshift --list

# Setup monitoring
echo '#!/bin/bash
SNAPSHOT_COUNT=$(sudo timeshift --list | grep -c "^[0-9]")
if [ $SNAPSHOT_COUNT -lt 5 ]; then
    echo "WARNING: Only $SNAPSHOT_COUNT snapshots available" | mail -s "Timeshift Alert" admin@example.com
fi' > /usr/local/bin/check_snapshots.sh

chmod +x /usr/local/bin/check_snapshots.sh

# Add to cron
echo "0 6 * * * /usr/local/bin/check_snapshots.sh" | sudo crontab -
```

**Result:** Automated snapshot management with monitoring!

---

### **1ï¸âƒ£1ï¸âƒ£ Checklist for Implementation** âœ…

**Admin Checklist:**
- [ ] Timeshift installed and configured
- [ ] Snapshot location selected (separate partition preferred)
- [ ] Automatic snapshot schedule configured
- [ ] Retention policy defined
- [ ] /home excluded from snapshots
- [ ] Test restore performed successfully
- [ ] Snapshot before every major change
- [ ] Disk space monitoring setup
- [ ] Team trained on restore process
- [ ] External backup of critical snapshots

**Pentester Checklist:**
- [ ] Check if Timeshift installed
- [ ] Enumerate all snapshots
- [ ] Check snapshot permissions
- [ ] Analyze old snapshots for credentials
- [ ] Search for weak configurations in old snapshots
- [ ] Check snapshot timing patterns
- [ ] Document snapshot locations
- [ ] Assess persistence risk (restore removes backdoors)
- [ ] Check for sensitive data in snapshots
- [ ] Report findings with remediation

---

### **1ï¸âƒ£2ï¸âƒ£ Frequently Asked Questions (FAQs)** â“

**Q1: Timeshift vs traditional backup - kya farak hai?**
**A:** Timeshift system files ka snapshot leta hai (OS, configs), user data nahi. Traditional backup sab kuch backup karta hai. Timeshift fast restore ke liye hai, data backup ke liye nahi.

**Q2: RSYNC vs BTRFS mode - kaun sa use karein?**
**A:** 
- **RSYNC**: Kisi bhi filesystem ke saath works (ext4, XFS) - recommended for most users
- **BTRFS**: Sirf BTRFS filesystem ke saath, faster snapshots but limited compatibility

**Q3: Snapshot kitni space lete hain?**
**A:** 
- First snapshot: 2-5 GB (depending on installed software)
- Incremental snapshots: 100-500 MB (sirf changes)

**Q4: Kya /home ko include karna chahiye?**
**A:** Generally NO. /home mein user data hota hai jo bahut bada ho sakta hai. User data ko separately backup karein (rsync, Deja Dup).

**Q5: Snapshot restore se kya-kya restore hota hai?**
**A:** System files, installed packages, configurations. User data (/home) restore nahi hota (unless included).

**Q6: Kya Live USB se restore kar sakte hain?**
**A:** Haan! Agar system boot nahi ho raha, Live USB se boot karke Timeshift restore kar sakte ho.

**Q7: Snapshot automatically delete hote hain?**
**A:** Haan, retention policy ke according. Example: "Keep 5 daily" means 6th day purana snapshot auto-delete.

**Q8: Kya Timeshift server ke liye suitable hai?**
**A:** Haan, but production servers ke liye additional offsite backups bhi rakhein. Timeshift local recovery ke liye best hai.

---

### **1ï¸âƒ£3ï¸âƒ£ Practice Tasks with Expected Output** ğŸ¯

#### **Task 1: Install and Create First Snapshot**
```bash
# Install
sudo apt install timeshift -y

# Create snapshot
sudo timeshift --create --comments "My first snapshot" --tags O

# List snapshots
sudo timeshift --list
```

**Expected Output:**
```
Num     Name                 Tags  Description
0    >  2024-01-15_14-30-00  O     My first snapshot
```

---

#### **Task 2: Simulate Update and Restore**
```bash
# Create snapshot
sudo timeshift --create --comments "Before test" --tags O

# Make a change (create test file)
sudo touch /etc/test_file.txt

# Verify file exists
ls /etc/test_file.txt

# Restore snapshot
sudo timeshift --restore --snapshot '2024-01-15_14-30-00'

# Check if file removed
ls /etc/test_file.txt
# ls: cannot access '/etc/test_file.txt': No such file or directory
```

---

#### **Task 3: Check Snapshot Size**
```bash
# Create snapshot
sudo timeshift --create --comments "Size test" --tags O

# Check size
sudo du -sh /timeshift/snapshots/*

# Create another snapshot after installing package
sudo apt install htop -y
sudo timeshift --create --comments "After htop install" --tags O

# Compare sizes
sudo du -sh /timeshift/snapshots/*
```

**Expected:** Second snapshot much smaller (incremental).

---

#### **Task 4: Pentester Enumeration**
```bash
# Check if installed
which timeshift

# List snapshots
sudo timeshift --list

# Check permissions
ls -la /timeshift/

# Search for credentials in old snapshot
sudo find /timeshift/snapshots/ -name "shadow" -o -name "*.conf" 2>/dev/null
```

---

### **1ï¸âƒ£4ï¸âƒ£ Advanced Information & Edge Cases** ğŸš€

#### **Advanced Technique 1: Timeshift with BTRFS Subvolumes**

```bash
# For BTRFS filesystem
sudo timeshift --btrfs --create --comments "BTRFS snapshot"

# BTRFS snapshots are instant (copy-on-write)
# No space used until files change
```

**Advantage:** Instant snapshots, space-efficient.

---

#### **Advanced Technique 2: Scripted Snapshot Before Updates**

```bash
#!/bin/bash
# /usr/local/bin/safe_update.sh

echo "Creating pre-update snapshot..."
sudo timeshift --create --comments "Before update $(date +%Y-%m-%d)" --tags B

if [ $? -eq 0 ]; then
    echo "Snapshot created successfully"
    echo "Proceeding with update..."
    sudo apt update && sudo apt upgrade -y
else
    echo "Snapshot failed! Aborting update."
    exit 1
fi
```

---

#### **Advanced Technique 3: Remote Snapshot Backup**

```bash
# Copy snapshot to remote server
sudo rsync -avz /timeshift/snapshots/2024-01-15_10-30-45/ \
    user@backup-server:/backups/timeshift/

# Restore from remote if needed
sudo rsync -avz user@backup-server:/backups/timeshift/2024-01-15_10-30-45/ \
    /timeshift/snapshots/2024-01-15_10-30-45/
```

---

#### **Edge Case 1: Snapshot During Low Disk Space**

```bash
# Check space before snapshot
df -h /

# If space low, delete old snapshots first
sudo timeshift --delete --snapshot 'oldest_snapshot_name'

# Then create new snapshot
sudo timeshift --create
```

---

#### **Edge Case 2: Restore Specific Files Only**

```bash
# Instead of full restore, copy specific files
sudo cp /timeshift/snapshots/2024-01-15_10-30-45/localhost/etc/nginx/nginx.conf \
    /etc/nginx/nginx.conf

# Restart service
sudo systemctl restart nginx
```

---

### **1ï¸âƒ£5ï¸âƒ£ Final Summary & Key Takeaways** ğŸ“Œ

**Key Concepts:**
1. **Timeshift** - System snapshot tool for quick recovery
2. **RSYNC Mode** - Works with any filesystem
3. **Incremental Snapshots** - Space-efficient backups
4. **Quick Restore** - Minutes, not hours
5. **Scheduled Snapshots** - Automated protection

**Critical Commands:**
```bash
# Create snapshot
sudo timeshift --create --comments "Description" --tags O

# List snapshots
sudo timeshift --list

# Restore
sudo timeshift --restore --snapshot 'NAME'

# Delete
sudo timeshift --delete --snapshot 'NAME'
```

**Admin Takeaways:**
- âœ… Always snapshot before major changes
- âœ… Configure automatic daily/weekly snapshots
- âœ… Exclude /home to save space
- âœ… Test restore process regularly
- âœ… Monitor disk space
- âœ… Keep external backup of critical snapshots
- âœ… Document snapshot strategy

**Pentester Takeaways:**
- ğŸ” Check for Timeshift installation
- ğŸ” Enumerate and analyze old snapshots
- ğŸ” Search for credentials in old configs
- ğŸ” Old snapshots may have weak security
- ğŸ” Snapshot restore removes persistence
- ğŸ” Snapshot timing reveals admin patterns
- ğŸ” Check snapshot permissions

**Remember:**
- Timeshift â‰  Data backup (system only)
- Snapshot before every major change
- Test restore process
- Monitor disk space
- External backup for critical snapshots

**Next Topic:** Configuration Versioning with etckeeper ğŸ“

---

**Happy Snapshotting! â±ï¸ğŸ“¸**
