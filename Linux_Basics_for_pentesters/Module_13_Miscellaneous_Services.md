# **Module 13: Miscellaneous Services & Techniques** ğŸ”§âš™ï¸

---

## **Topic 1: SAMBA Server Setup (File Sharing)** ğŸ“ğŸ”—

---

### **1ï¸âƒ£ Topic Summary (1-2 lines)**

SAMBA ek open-source implementation hai jo Linux/Unix systems ko Windows file sharing protocol (SMB/CIFS) use karke files aur printers share karne deta hai - cross-platform file sharing ka best solution! ğŸš€

---

### **2ï¸âƒ£ Detailed Explanation with Analogy** ğŸ§ 

**Kya hai SAMBA?**

SAMBA = **S**erver **M**essage **B**lock protocol ka Linux implementation

**Components:**
- **smbd** - File/printer sharing daemon (SMB/CIFS protocol)
- **nmbd** - NetBIOS name service daemon (network browsing)
- **winbindd** - Windows domain integration (optional)

**Analogy:**
Socho SAMBA ek **translator** hai:
- **Linux** = Hindi speaker (native Linux file system)
- **Windows** = English speaker (SMB protocol)
- **SAMBA** = Translator jo dono ko communicate karne deta hai
- **Shared Folder** = Common meeting room jahan dono files exchange karte hain

Jaise ek translator Hindi aur English dono samajhta hai, waise hi SAMBA Linux aur Windows dono protocols samajhta hai!

---

### **3ï¸âƒ£ Why is this Important?** ğŸ¯

**System Admin Perspective:**
- âœ… **Cross-platform sharing** - Linux aur Windows dono access kar sakte hain
- âœ… **Centralized storage** - Ek jagah files, sabko access
- âœ… **User authentication** - Secure access control
- âœ… **Printer sharing** - Network printers setup
- âœ… **Home directories** - Users ke personal folders
- âœ… **Backup solution** - Centralized backup location

**Pentester Perspective:**
- ğŸ” **SMB enumeration** - Shares, users, permissions discover karna
- ğŸ” **Null session attacks** - Anonymous access testing
- ğŸ” **Credential harvesting** - SMB relay attacks
- ğŸ” **Lateral movement** - Network shares se sensitive data
- ğŸ” **Misconfiguration** - Weak permissions exploit karna
- ğŸ” **EternalBlue** - SMBv1 vulnerabilities (MS17-010)

---

### **4ï¸âƒ£ Real-World Use Cases** ğŸ’¼

**Admin Use Cases:**
1. **Office File Server** - Company documents sharing
2. **Media Server** - Videos/music streaming to Windows PCs
3. **Backup Location** - Centralized backup storage
4. **Home Directories** - User personal folders
5. **Printer Sharing** - Network printer access
6. **Development** - Code sharing between Linux/Windows devs

**Pentester Use Cases:**
1. **Network Enumeration** - SMB shares discovery
2. **Anonymous Access** - Null session testing
3. **Password Attacks** - SMB brute force
4. **Sensitive Data** - Shared files mein credentials
5. **Privilege Escalation** - Writable shares exploit
6. **Lateral Movement** - SMB relay attacks

---

### **5ï¸âƒ£ What if NOT Done Properly?** âš ï¸

**Admin Consequences:**
- âŒ **Data Breach** - Misconfigured shares se sensitive data leak
- âŒ **Unauthorized Access** - Weak passwords se compromise
- âŒ **Ransomware** - SMB shares through malware spread
- âŒ **Performance Issues** - Improper configuration se slow network
- âŒ **Compliance Violation** - Audit failures

**Pentester Findings:**
- ğŸš¨ **Anonymous Access** - Guest shares without authentication
- ğŸš¨ **Weak Permissions** - Everyone can read/write
- ğŸš¨ **SMBv1 Enabled** - EternalBlue vulnerability
- ğŸš¨ **Credentials in Files** - Passwords in shared documents
- ğŸš¨ **Writable Shares** - Malware upload possible

---

### **6ï¸âƒ£ Syntax & Configuration** ğŸ“

#### **Installation:**
```bash
# Ubuntu/Debian
sudo apt update
sudo apt install samba samba-common-bin

# CentOS/RHEL
sudo yum install samba samba-client samba-common
```

#### **Main Configuration File:**
```
/etc/samba/smb.conf
```

#### **Basic Syntax:**
```ini
[ShareName]
   path = /path/to/directory
   browseable = yes/no
   read only = yes/no
   guest ok = yes/no
   valid users = user1, user2
   write list = user1
   create mask = 0755
   directory mask = 0755
```

---

### **7ï¸âƒ£ Detailed Examples with Tables** ğŸ’»

#### **Example 1: Public Share (Read-Only)**

**Command:**
```bash
# Create directory
sudo mkdir -p /srv/samba/public
sudo chmod 755 /srv/samba/public

# Edit config
sudo nano /etc/samba/smb.conf
```

**Configuration:**
```ini
[Public]
   comment = Public Read-Only Share
   path = /srv/samba/public
   browseable = yes
   read only = yes
   guest ok = yes
```

**Restart service:**
```bash
sudo systemctl restart smbd
sudo systemctl restart nmbd
```

| **Parameter** | **Value** | **Meaning** |
|--------------|-----------|-------------|
| `[Public]` | Share name | Windows mein dikhne wala naam |
| `comment` | Description | Share ka description |
| `path` | `/srv/samba/public` | Linux filesystem path |
| `browseable` | `yes` | Network browse mein visible |
| `read only` | `yes` | Sirf read access, write nahi |
| `guest ok` | `yes` | Bina password access allowed |

**Access from Windows:**
```
\\192.168.1.100\Public
```

**Access from Linux:**
```bash
smbclient //192.168.1.100/Public -N
```

---

#### **Example 2: Private Share (User Authentication)**

**Setup:**
```bash
# Create directory
sudo mkdir -p /srv/samba/private
sudo chown root:sambashare /srv/samba/private
sudo chmod 770 /srv/samba/private

# Create user
sudo useradd -M -s /sbin/nologin smbuser
sudo usermod -aG sambashare smbuser

# Set SAMBA password
sudo smbpasswd -a smbuser
# Enter password: SecurePass123
```

**Configuration:**
```ini
[Private]
   comment = Private Authenticated Share
   path = /srv/samba/private
   browseable = yes
   read only = no
   guest ok = no
   valid users = smbuser
   create mask = 0660
   directory mask = 0770
```

**Restart:**
```bash
sudo systemctl restart smbd
```

| **Parameter** | **Value** | **Meaning** |
|--------------|-----------|-------------|
| `[Private]` | Share name | Share ka naam |
| `read only` | `no` | Read aur write dono allowed |
| `guest ok` | `no` | Authentication required |
| `valid users` | `smbuser` | Sirf ye user access kar sakta |
| `create mask` | `0660` | New files ke permissions (rw-rw----) |
| `directory mask` | `0770` | New folders ke permissions (rwxrwx---) |

**Access:**
```
Windows: \\192.168.1.100\Private
Username: smbuser
Password: SecurePass123
```

---

#### **Example 3: Multi-User Share with Groups**

**Setup:**
```bash
# Create group
sudo groupadd developers

# Create users
sudo useradd -M -G developers dev1
sudo useradd -M -G developers dev2
sudo smbpasswd -a dev1
sudo smbpasswd -a dev2

# Create directory
sudo mkdir -p /srv/samba/devshare
sudo chown root:developers /srv/samba/devshare
sudo chmod 770 /srv/samba/devshare
```

**Configuration:**
```ini
[DevShare]
   comment = Developers Shared Folder
   path = /srv/samba/devshare
   browseable = yes
   read only = no
   guest ok = no
   valid users = @developers
   write list = @developers
   create mask = 0660
   directory mask = 0770
   force group = developers
```

| **Parameter** | **Value** | **Meaning** |
|--------------|-----------|-------------|
| `valid users` | `@developers` | Group ke sab members access kar sakte |
| `write list` | `@developers` | Group members write kar sakte |
| `force group` | `developers` | New files is group ki hongi |

---

#### **Example 4: Home Directories**

**Configuration:**
```ini
[homes]
   comment = Home Directories
   browseable = no
   read only = no
   create mask = 0700
   directory mask = 0700
   valid users = %S
```

| **Parameter** | **Value** | **Meaning** |
|--------------|-----------|-------------|
| `[homes]` | Special share | Har user ka apna home directory |
| `browseable` | `no` | List mein nahi dikhega |
| `valid users` | `%S` | Sirf owner access kar sakta (%S = username) |
| `create mask` | `0700` | Sirf owner read/write/execute (rwx------) |

**Access:**
```
User "john" logs in: \\server\john (automatically maps to /home/john)
```

---

### **8ï¸âƒ£ Common Mistakes & How to Avoid** âŒâ¡ï¸âœ…

| **Mistake** | **Problem** | **Solution** |
|------------|-------------|--------------|
| `guest ok = yes` everywhere | Anonymous access, security risk | Sirf public shares ke liye use karo |
| SMBv1 enabled | EternalBlue vulnerability | Disable: `min protocol = SMB2` |
| Weak passwords | Brute force attacks | Strong passwords enforce karo |
| `chmod 777` on shares | Everyone can access | Proper permissions: 770 or 750 |
| No firewall rules | Exposed to internet | UFW/iptables se restrict karo |
| Not testing permissions | Users can't access | `smbclient` se test karo |
| Forgetting to restart | Changes apply nahi hote | `systemctl restart smbd` |
| No backup of smb.conf | Config lost on mistake | Regular backup rakho |

---

### **9ï¸âƒ£ Best Practices & Pro Tips** â­

**Security Best Practices:**
```bash
# 1. Disable SMBv1 (vulnerable)
sudo nano /etc/samba/smb.conf
[global]
   min protocol = SMB2

# 2. Enable firewall
sudo ufw allow from 192.168.1.0/24 to any port 445
sudo ufw allow from 192.168.1.0/24 to any port 139

# 3. Strong password policy
sudo nano /etc/samba/smb.conf
[global]
   security = user
   encrypt passwords = yes

# 4. Restrict hosts
[ShareName]
   hosts allow = 192.168.1.0/24
   hosts deny = 0.0.0.0/0

# 5. Audit logging
[global]
   log file = /var/log/samba/log.%m
   max log size = 1000
   log level = 2
```

**Performance Tips:**
```ini
[global]
   socket options = TCP_NODELAY IPTOS_LOWDELAY SO_RCVBUF=65536 SO_SNDBUF=65536
   read raw = yes
   write raw = yes
   max xmit = 65535
   dead time = 15
```

**Pro Tips:**
- ğŸ’¡ Test config: `testparm`
- ğŸ’¡ List shares: `smbclient -L localhost -N`
- ğŸ’¡ Monitor connections: `smbstatus`
- ğŸ’¡ Check permissions: `smbcacls`
- ğŸ’¡ Debug: `tail -f /var/log/samba/log.smbd`

---

### **ğŸ”Ÿ Real-World Scenario** ğŸŒ

#### **Scenario 1: Office File Server Setup**

**Admin Task:**
```
Company needs:
- Public folder (announcements) - Everyone read
- HR folder - Only HR team read/write
- Finance folder - Only finance team read/write
- Each employee personal folder
```

**Solution:**
```bash
# 1. Create structure
sudo mkdir -p /srv/samba/{public,hr,finance}
sudo groupadd hr
sudo groupadd finance

# 2. Set permissions
sudo chmod 755 /srv/samba/public
sudo chown root:hr /srv/samba/hr
sudo chmod 770 /srv/samba/hr
sudo chown root:finance /srv/samba/finance
sudo chmod 770 /srv/samba/finance

# 3. Create users
sudo useradd -M -G hr hruser1
sudo useradd -M -G finance finuser1
sudo smbpasswd -a hruser1
sudo smbpasswd -a finuser1

# 4. Configure
sudo nano /etc/samba/smb.conf
```

```ini
[global]
   workgroup = COMPANY
   server string = Company File Server
   security = user
   min protocol = SMB2

[Public]
   path = /srv/samba/public
   browseable = yes
   read only = yes
   guest ok = yes

[HR]
   path = /srv/samba/hr
   browseable = yes
   read only = no
   valid users = @hr
   write list = @hr
   create mask = 0660
   directory mask = 0770

[Finance]
   path = /srv/samba/finance
   browseable = yes
   read only = no
   valid users = @finance
   write list = @finance
   create mask = 0660
   directory mask = 0770

[homes]
   browseable = no
   read only = no
   create mask = 0700
   directory mask = 0700
```

```bash
# 5. Restart
sudo systemctl restart smbd nmbd

# 6. Test
testparm
smbclient -L localhost -U hruser1
```

**Result:** Secure, organized file server! âœ…

---

#### **Scenario 2: Pentester - SMB Enumeration**

**Recon Task:**
```
Target: 192.168.1.50
Goal: Enumerate shares, find sensitive data
```

**Enumeration:**
```bash
# 1. Port scan
nmap -p 139,445 192.168.1.50

# 2. SMB version detection
nmap -p 445 --script smb-protocols 192.168.1.50

# 3. List shares (null session)
smbclient -L //192.168.1.50 -N

# 4. Enum4linux (comprehensive)
enum4linux -a 192.168.1.50

# 5. SMBMap
smbmap -H 192.168.1.50

# 6. CrackMapExec
crackmapexec smb 192.168.1.50 --shares

# 7. Try guest access
smbclient //192.168.1.50/Public -N

# 8. Found writable share!
smbclient //192.168.1.50/Backup -N
smb: \> ls
smb: \> get passwords.txt
```

**Findings:**
```
âœ“ SMBv1 enabled (EternalBlue vulnerable!)
âœ“ Guest access allowed on "Backup" share
âœ“ Found: passwords.txt, database_backup.sql
âœ“ Writable share - can upload malware
```

**Report:**
```
CRITICAL: SMBv1 enabled - MS17-010 vulnerable
HIGH: Anonymous access to "Backup" share
HIGH: Sensitive files exposed (passwords.txt)
MEDIUM: Writable share allows malware upload
```

---

### **1ï¸âƒ£1ï¸âƒ£ Troubleshooting Checklist** âœ…

**Can't Access Share:**
```bash
# 1. Check service running
sudo systemctl status smbd
sudo systemctl status nmbd

# 2. Test configuration
testparm

# 3. Check firewall
sudo ufw status
sudo ufw allow 445/tcp
sudo ufw allow 139/tcp

# 4. Verify user exists
sudo pdbedit -L

# 5. Check permissions
ls -la /srv/samba/sharename

# 6. Test locally
smbclient -L localhost -U username

# 7. Check logs
sudo tail -f /var/log/samba/log.smbd
```

**Permission Denied:**
```bash
# Check Linux permissions
ls -la /path/to/share

# Check SAMBA user
sudo pdbedit -L -v username

# Verify valid users in config
testparm -s | grep "valid users"

# Test access
smbclient //localhost/ShareName -U username
```

**Slow Performance:**
```bash
# Check connections
smbstatus

# Monitor logs
tail -f /var/log/samba/log.smbd

# Optimize config (add to [global])
socket options = TCP_NODELAY SO_RCVBUF=65536 SO_SNDBUF=65536
```

---

### **1ï¸âƒ£2ï¸âƒ£ FAQs** â“

**Q1: SAMBA aur NFS mein difference?**
```
SAMBA:
- Windows-compatible (SMB/CIFS)
- Cross-platform (Linux, Windows, Mac)
- User authentication built-in
- Slower than NFS

NFS:
- Unix/Linux native
- Faster performance
- Less security features
- Best for Linux-to-Linux
```

**Q2: SMBv1 kyun disable karna chahiye?**
```
SMBv1 = Old, vulnerable protocol
- EternalBlue exploit (MS17-010)
- WannaCry ransomware used this
- No encryption
- Security risk

Solution: min protocol = SMB2
```

**Q3: Guest access kab use karein?**
```
Use:
- Public announcements
- Company policies
- Read-only documents
- Non-sensitive data

Avoid:
- Confidential files
- User data
- Backups
- Any sensitive information
```

**Q4: SAMBA user aur Linux user same hain?**
```
No! Different databases:
- Linux users: /etc/passwd
- SAMBA users: /var/lib/samba/private/passdb.tdb

But: SAMBA user must exist as Linux user first
Process:
1. useradd linuxuser
2. smbpasswd -a linuxuser (creates SAMBA password)
```

**Q5: Share delete kaise karein?**
```bash
# 1. Remove from config
sudo nano /etc/samba/smb.conf
# Delete [ShareName] section

# 2. Restart
sudo systemctl restart smbd

# 3. (Optional) Delete directory
sudo rm -rf /srv/samba/sharename
```

---

### **1ï¸âƒ£3ï¸âƒ£ Practice Tasks** ğŸ¯

**Beginner:**
1. âœ… Install SAMBA on Ubuntu
2. âœ… Create public read-only share
3. âœ… Access share from Windows
4. âœ… Check SAMBA status
5. âœ… View active connections with `smbstatus`

**Intermediate:**
1. âœ… Create authenticated share with user
2. âœ… Setup group-based share
3. âœ… Configure home directories
4. âœ… Disable SMBv1
5. âœ… Setup firewall rules for SAMBA

**Advanced:**
1. âœ… Multi-department file server (3+ shares)
2. âœ… Implement audit logging
3. âœ… Performance optimization
4. âœ… Backup/restore SAMBA config
5. âœ… Integrate with Active Directory (Winbind)

**Pentester:**
1. ğŸ” Enumerate SMB shares with enum4linux
2. ğŸ” Test null session access
3. ğŸ” Brute force SMB credentials
4. ğŸ” Check for SMBv1 vulnerability
5. ğŸ” Extract sensitive files from shares

---

### **1ï¸âƒ£4ï¸âƒ£ Advanced Information** ğŸš€

#### **SAMBA with Active Directory:**
```bash
# Join domain
sudo apt install winbind
sudo nano /etc/samba/smb.conf

[global]
   security = ads
   realm = COMPANY.LOCAL
   workgroup = COMPANY
   winbind use default domain = yes

# Join
sudo net ads join -U Administrator
sudo systemctl restart smbd nmbd winbind
```

#### **SAMBA Performance Tuning:**
```ini
[global]
   # Async I/O
   aio read size = 16384
   aio write size = 16384
   
   # Caching
   getwd cache = yes
   
   # Large files
   strict allocate = yes
   allocation roundup size = 4096
   
   # Network
   socket options = TCP_NODELAY IPTOS_LOWDELAY SO_RCVBUF=131072 SO_SNDBUF=131072
```

#### **SAMBA Audit Logging:**
```ini
[ShareName]
   vfs objects = full_audit
   full_audit:prefix = %u|%I|%S
   full_audit:success = open opendir write unlink rename
   full_audit:failure = all
   full_audit:facility = local5
   full_audit:priority = notice
```

#### **Useful Commands:**
```bash
# List all SAMBA users
sudo pdbedit -L -v

# Delete SAMBA user
sudo smbpasswd -x username

# Disable user
sudo smbpasswd -d username

# Enable user
sudo smbpasswd -e username

# Change password
sudo smbpasswd username

# View share permissions
smbcacls //localhost/ShareName / -U username

# Kill specific connection
sudo smbcontrol smbd close-share ShareName
```

---

### **1ï¸âƒ£5ï¸âƒ£ Final Summary** ğŸ“‹

**SAMBA = Cross-Platform File Sharing Solution**

**Key Points:**
- âœ… **Installation**: `apt install samba`
- âœ… **Config**: `/etc/samba/smb.conf`
- âœ… **User**: `smbpasswd -a username`
- âœ… **Test**: `testparm`
- âœ… **Status**: `smbstatus`
- âœ… **Ports**: 445 (SMB), 139 (NetBIOS)

**Share Types:**
1. **Public** - Guest access, read-only
2. **Private** - User authentication, read/write
3. **Group** - Team-based access
4. **Homes** - Personal directories

**Security:**
- ğŸ”’ Disable SMBv1
- ğŸ”’ Strong passwords
- ğŸ”’ Firewall rules
- ğŸ”’ Proper permissions
- ğŸ”’ Audit logging

**Admin:** Secure file sharing, centralized storage, user management
**Pentester:** SMB enumeration, null sessions, sensitive data discovery

**Remember:** SAMBA bridges Linux and Windows - configure securely! ğŸ”

---

**Next Topic:** Linux Root Password Reset ğŸ”‘

---

**Happy File Sharing! ğŸ“ğŸš€**
