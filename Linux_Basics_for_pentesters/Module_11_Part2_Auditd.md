# **Module 11: Advanced Logging & Auditing (Part 2)** ğŸ“ŠğŸ”

---

## **Topic 2: auditd - System ka 'CCTV Camera'** ğŸ“¹ğŸ”

---

### **1ï¸âƒ£ Topic Summary (1-2 lines)**

auditd Linux ka audit framework hai jo system calls, file access, command execution, aur user activity ko track karta hai - ek CCTV camera ki tarah jo har action record karta hai for security auditing aur compliance.

---

### **2ï¸âƒ£ Detailed Explanation with Analogy** ğŸ§ 

**Kya hai auditd?**

auditd (Linux Audit Daemon) kernel-level auditing system hai jo:
- File access track karta hai (kisne kab kaunsi file access ki)
- System calls monitor karta hai
- User commands record karta hai
- Network connections log karta hai
- Security events capture karta hai

**auditd Components:**

1. **auditd** - Audit daemon (background service)
2. **auditctl** - Audit rules configure karne ka tool
3. **ausearch** - Audit logs search karne ka tool
4. **aureport** - Audit reports generate karne ka tool
5. **/var/log/audit/audit.log** - Main audit log file

**Analogy:**

auditd ek **security camera system** ki tarah hai jo:
- Har room (file/directory) mein camera hai
- Har action record hota hai (timestamp ke saath)
- Playback kar sakte ho (ausearch)
- Reports bana sakte ho (aureport)
- "Kisne kab kya kiya" - sab pata chal jata hai!

---

### **3ï¸âƒ£ Why is this Important?** ğŸ¯

**Sysadmin Perspective:**
- Security incident investigation
- Compliance requirements (PCI-DSS, HIPAA, SOX)
- Unauthorized access detection
- File integrity monitoring
- User activity auditing
- Forensic analysis

**Pentester Perspective:**
- Audit rules enumerate karna
- Logged activities identify karna
- Audit log tampering
- Evasion techniques
- Persistence detection
- Attack trace analysis

---

### **4ï¸âƒ£ Real-World Use Cases** ğŸ’¼

**Admin Use Cases:**
1. Track who accessed sensitive files
2. Monitor sudo command usage
3. Detect unauthorized file modifications
4. Audit user login/logout
5. Compliance reporting

**Pentester Use Cases:**
1. Check if actions are being logged
2. Identify audit rules
3. Attempt log tampering
4. Evade audit detection
5. Analyze attack traces

---

### **5ï¸âƒ£ Consequences of Not Knowing** âš ï¸

**Admin Problems:**
- âŒ Security incidents undetected
- âŒ Compliance violations
- âŒ No forensic evidence
- âŒ Unauthorized access untracked
- âŒ Incident response delayed

**Pentester Problems:**
- âŒ Actions logged without knowledge
- âŒ Forensic evidence left behind
- âŒ Detection risk increase
- âŒ Evasion techniques not applied
- âŒ Attack traces obvious

---

### **6ï¸âƒ£ Syntax & Command Structure** ğŸ“

#### **auditctl Commands:**
```bash
auditctl -l              # List audit rules
auditctl -w PATH -p PERM # Watch file/directory
auditctl -a ACTION,FILTER -S SYSCALL  # Add syscall rule
auditctl -D              # Delete all rules
auditctl -s              # Show audit status
```

#### **Watch Permissions:**
```
r - Read
w - Write
x - Execute
a - Attribute change
```

#### **ausearch Commands:**
```bash
ausearch -f FILE         # Search by filename
ausearch -k KEY          # Search by key
ausearch -ui UID         # Search by user ID
ausearch -ts TIME        # Search by timestamp
ausearch -i              # Interpret output (human-readable)
```

#### **aureport Commands:**
```bash
aureport                 # Summary report
aureport -f              # File access report
aureport -l              # Login report
aureport -x              # Executable report
aureport -u              # User report
```

---

### **7ï¸âƒ£ Detailed Examples with Explanation Tables** ğŸ’»

#### **Example 1: Install and Start auditd**

```bash
# Install
sudo apt install auditd audispd-plugins

# Start service
sudo systemctl start auditd
sudo systemctl enable auditd

# Check status
sudo systemctl status auditd
```

**Output:**
```
â— auditd.service - Security Auditing Service
   Active: active (running)
```

---

#### **Example 2: View Current Audit Rules**

```bash
sudo auditctl -l
```

**Output (if no rules):**
```
No rules
```

**Output (with rules):**
```
-w /etc/passwd -p wa -k passwd_changes
-w /etc/shadow -p wa -k shadow_changes
-w /var/log/audit/ -p wa -k audit_log_changes
```

---

#### **Example 3: Watch File for Changes**

```bash
sudo auditctl -w /etc/passwd -p wa -k passwd_changes
```

| Part | Explanation |
|------|-------------|
| `auditctl` | Audit control command |
| `-w /etc/passwd` | Watch this file |
| `-p wa` | Permissions: write, attribute change |
| `-k passwd_changes` | Key for searching logs |

**Test:**
```bash
# Make a change
sudo useradd testuser

# Search audit logs
sudo ausearch -k passwd_changes -i
```

---

#### **Example 4: Watch Directory Recursively**

```bash
sudo auditctl -w /etc/ssh/ -p wa -k ssh_config_changes
```

**Use Case:** Monitor all SSH configuration changes.

---

#### **Example 5: Audit Specific System Call**

```bash
sudo auditctl -a always,exit -F arch=b64 -S open -S openat -k file_open
```

| Part | Explanation |
|------|-------------|
| `-a always,exit` | Always log at syscall exit |
| `-F arch=b64` | 64-bit architecture |
| `-S open -S openat` | Monitor open/openat syscalls |
| `-k file_open` | Search key |

**Use Case:** Track all file open operations.

---

#### **Example 6: Audit Sudo Commands**

```bash
sudo auditctl -a always,exit -F arch=b64 -S execve -F euid=0 -k sudo_commands
```

| Part | Explanation |
|------|-------------|
| `-S execve` | Monitor execve syscall |
| `-F euid=0` | Effective UID = 0 (root) |
| `-k sudo_commands` | Search key |

**Search logs:**
```bash
sudo ausearch -k sudo_commands -i
```

---

#### **Example 7: Search Audit Logs by File**

```bash
sudo ausearch -f /etc/passwd -i
```

| Part | Explanation |
|------|-------------|
| `ausearch` | Search audit logs |
| `-f /etc/passwd` | Search for this file |
| `-i` | Interpret (human-readable) |

**Output:**
```
type=SYSCALL msg=audit(01/15/2024 10:30:45.123:456) : arch=x86_64 syscall=openat success=yes exit=3 a0=0xffffff9c a1=0x7ffd12345678 a2=O_RDONLY a3=0x0 items=1 ppid=1234 pid=1235 auid=admin uid=root gid=root euid=root suid=root fsuid=root egid=root sgid=root fsgid=root tty=pts0 ses=1 comm=useradd exe=/usr/sbin/useradd key=passwd_changes
```

---

#### **Example 8: Search by User**

```bash
# Find user ID
id username
# uid=1000(username)

# Search audit logs
sudo ausearch -ui 1000 -i
```

---

#### **Example 9: Search by Time Range**

```bash
# Today's logs
sudo ausearch -ts today -i

# Specific time range
sudo ausearch -ts 10:00:00 -te 11:00:00 -i

# Yesterday
sudo ausearch -ts yesterday -te today -i
```

---

#### **Example 10: Generate Reports**

```bash
# Summary report
sudo aureport

# File access report
sudo aureport -f

# Login report
sudo aureport -l

# Executable report
sudo aureport -x

# User activity report
sudo aureport -u
```

**Summary Output:**
```
Summary Report
======================
Range of time in logs: 01/15/2024 00:00:00.000 - 01/15/2024 23:59:59.999
Selected time for report: 01/15/2024 00:00:00 - 01/15/2024 23:59:59.999
Number of changes in configuration: 5
Number of changes to accounts, groups, or roles: 3
Number of logins: 12
Number of failed logins: 2
Number of authentications: 45
Number of failed authentications: 3
Number of users: 5
Number of terminals: 3
Number of host names: 2
Number of executables: 234
Number of commands: 567
Number of files: 123
Number of AVC's: 0
Number of MAC events: 0
Number of failed syscalls: 5
Number of anomaly events: 0
Number of responses to anomaly events: 0
Number of crypto events: 12
Number of integrity events: 0
Number of virt events: 0
Number of keys: 8
Number of process IDs: 456
Number of events: 1234
```

---

### **8ï¸âƒ£ Common Mistakes & How to Avoid** âŒâ¡ï¸âœ…

| Mistake | Problem | Solution |
|---------|---------|----------|
| Not using `-i` with ausearch | Raw output hard to read | Always use `-i` for interpretation |
| Too many audit rules | Performance impact | Monitor only critical files/syscalls |
| No key names | Can't search logs | Always use `-k` with meaningful names |
| Forgetting to persist rules | Rules lost on reboot | Add to `/etc/audit/rules.d/` |
| Not rotating logs | Disk full | Configure log rotation |
| Ignoring audit alerts | Security incidents missed | Regular log review |
| Weak audit rules | Important events not logged | Comprehensive rule set |
| Not testing rules | Rules may not work | Test with `ausearch` |

---

### **9ï¸âƒ£ Best Practices & Pro Tips** â­

**Admin Best Practices:**
1. âœ… **Critical Files**: Monitor `/etc/passwd`, `/etc/shadow`, `/etc/sudoers`
2. âœ… **SSH Config**: Watch `/etc/ssh/` directory
3. âœ… **Sudo Commands**: Audit all root executions
4. âœ… **Key Names**: Use descriptive keys for easy searching
5. âœ… **Persistent Rules**: Store in `/etc/audit/rules.d/audit.rules`
6. âœ… **Log Rotation**: Configure in `/etc/audit/auditd.conf`
7. âœ… **Regular Review**: Weekly audit log analysis
8. âœ… **Alerting**: Setup alerts for critical events

**Pentester Pro Tips:**
1. ğŸ” **Check Audit Status**: `sudo auditctl -s`
2. ğŸ” **Enumerate Rules**: `sudo auditctl -l`
3. ğŸ” **Identify Monitored Files**: Look for `-w` rules
4. ğŸ” **Check Logs**: `sudo ausearch -ts today`
5. ğŸ” **Log Tampering**: Audit logs often protected
6. ğŸ” **Evasion**: Disable auditd if possible (requires root)
7. ğŸ” **Stealth**: Avoid monitored files/commands
8. ğŸ” **Cleanup**: Clear audit logs (leaves traces)

---

### **ğŸ”Ÿ Real-World Scenarios** ğŸŒ

#### **Scenario 1: Monitor Sensitive Files (Admin)**

**Situation:** Critical system files ko monitor karna hai.

**Solution:**
```bash
# Create audit rules file
sudo nano /etc/audit/rules.d/sensitive_files.rules
```

**Rules:**
```bash
# Monitor password files
-w /etc/passwd -p wa -k passwd_changes
-w /etc/shadow -p wa -k shadow_changes
-w /etc/group -p wa -k group_changes

# Monitor sudo config
-w /etc/sudoers -p wa -k sudoers_changes
-w /etc/sudoers.d/ -p wa -k sudoers_changes

# Monitor SSH config
-w /etc/ssh/sshd_config -p wa -k sshd_config_changes

# Monitor cron
-w /etc/cron.d/ -p wa -k cron_changes
-w /etc/cron.daily/ -p wa -k cron_changes
-w /etc/cron.hourly/ -p wa -k cron_changes

# Monitor audit logs
-w /var/log/audit/ -p wa -k audit_log_changes
```

```bash
# Load rules
sudo augenrules --load

# Verify
sudo auditctl -l

# Test
sudo useradd testuser

# Check logs
sudo ausearch -k passwd_changes -i
```

**Result:** Har sensitive file change logged!

---

#### **Scenario 2: Audit Sudo Commands (Admin)**

**Situation:** Sabhi sudo commands track karne hain.

**Solution:**
```bash
# Add rule
sudo auditctl -a always,exit -F arch=b64 -S execve -F euid=0 -k sudo_commands

# Or add to rules file
echo '-a always,exit -F arch=b64 -S execve -F euid=0 -k sudo_commands' | sudo tee -a /etc/audit/rules.d/sudo.rules

# Reload
sudo augenrules --load

# Test
sudo ls /root

# View logs
sudo ausearch -k sudo_commands -i | grep comm=
```

**Output:**
```
comm=ls exe=/usr/bin/ls key=sudo_commands
```

**Result:** Har sudo command logged with full details!

---

#### **Scenario 3: Detect Unauthorized Access (Admin)**

**Situation:** Kisi ne unauthorized `/etc/shadow` access kiya.

**Investigation:**
```bash
# Search shadow file access
sudo ausearch -f /etc/shadow -i

# Output shows:
type=SYSCALL msg=audit(01/15/2024 14:30:45.123:456) : 
  arch=x86_64 
  syscall=openat 
  success=yes 
  exit=3 
  a0=0xffffff9c 
  a1=0x7ffd12345678 
  a2=O_RDONLY 
  items=1 
  ppid=1234 
  pid=1235 
  auid=hacker 
  uid=root 
  gid=root 
  euid=root 
  comm=cat 
  exe=/usr/bin/cat 
  key=shadow_changes

# Who: auid=hacker (became root via sudo)
# What: cat /etc/shadow
# When: 01/15/2024 14:30:45

# Check what else hacker did
sudo ausearch -ui $(id -u hacker) -ts 14:00:00 -te 15:00:00 -i
```

**Finding:** Hacker ne sudo se root bana aur shadow file read ki!

---

#### **Scenario 4: Compliance Reporting (Admin)**

**Situation:** Monthly compliance report generate karna hai.

**Solution:**
```bash
# Generate comprehensive report
sudo aureport --start 01/01/2024 00:00:00 --end 01/31/2024 23:59:59 > /tmp/audit_report_jan2024.txt

# Specific reports
sudo aureport -l --start 01/01/2024 > /tmp/login_report.txt
sudo aureport -f --start 01/01/2024 > /tmp/file_access_report.txt
sudo aureport -x --start 01/01/2024 > /tmp/executable_report.txt
sudo aureport -u --start 01/01/2024 > /tmp/user_activity_report.txt

# Failed authentication attempts
sudo aureport -au --failed --start 01/01/2024

# Modifications to accounts
sudo aureport -m --start 01/01/2024
```

**Result:** Complete compliance documentation!

---

#### **Scenario 5: Pentester Evasion (Pentester)**

**Situation:** Audit rules check karke evasion strategy banana hai.

**Reconnaissance:**
```bash
# Check if auditd running
systemctl status auditd

# Check audit rules
sudo auditctl -l

# Output:
-w /etc/passwd -p wa -k passwd_changes
-w /etc/shadow -p wa -k shadow_changes
-w /etc/sudoers -p wa -k sudoers_changes
-a always,exit -F arch=b64 -S execve -F euid=0 -k sudo_commands

# Check audit logs
sudo ausearch -ts today | wc -l
# 1234 events today

# Check if logs are being written
sudo tail -f /var/log/audit/audit.log
```

**Evasion Strategies:**

**Option 1: Disable auditd (if root)**
```bash
# Stop service
sudo systemctl stop auditd

# Disable
sudo systemctl disable auditd

# Clear logs
sudo rm -rf /var/log/audit/*
```

**Option 2: Avoid Monitored Actions**
```bash
# Don't modify monitored files
# Use alternative methods
# Example: Instead of editing /etc/passwd, use useradd

# Avoid sudo if possible
# Use existing root shells
```

**Option 3: Log Tampering (Advanced)**
```bash
# Audit logs are protected
# Tampering leaves traces
# Better to disable auditd completely
```

**Result:** Aware of monitoring, can plan accordingly!

---

### **1ï¸âƒ£1ï¸âƒ£ Checklist for Implementation** âœ…

**Admin Checklist:**
- [ ] auditd installed and running
- [ ] Critical files monitored
- [ ] Sudo commands audited
- [ ] SSH config monitored
- [ ] Cron jobs monitored
- [ ] Audit rules persistent
- [ ] Log rotation configured
- [ ] Regular log review scheduled
- [ ] Alerting setup
- [ ] Compliance reports automated

**Pentester Checklist:**
- [ ] Audit status checked
- [ ] Audit rules enumerated
- [ ] Monitored files identified
- [ ] Audit logs analyzed
- [ ] Evasion strategy planned
- [ ] Log tampering assessed
- [ ] Alternative methods identified
- [ ] Stealth techniques applied
- [ ] Cleanup procedures planned
- [ ] Findings documented

---

### **1ï¸âƒ£2ï¸âƒ£ Frequently Asked Questions (FAQs)** â“

**Q1: auditd vs journalctl - kya farak hai?**
**A:** 
- **auditd**: Security-focused, kernel-level, detailed syscall tracking
- **journalctl**: General logging, service logs, easier to use

**Q2: Audit logs kitni space lete hain?**
**A:** Depends on rules. Typical: 100MB-1GB/day. Configure rotation:
```bash
# /etc/audit/auditd.conf
max_log_file = 100
num_logs = 5
```

**Q3: Kya audit rules performance impact karte hain?**
**A:** Haan, but minimal if rules focused. Too many syscall rules = noticeable impact.

**Q4: Audit rules reboot ke baad persist kaise karein?**
**A:** Rules ko `/etc/audit/rules.d/` mein save karein:
```bash
sudo nano /etc/audit/rules.d/custom.rules
sudo augenrules --load
```

**Q5: Kya audit logs tamper-proof hain?**
**A:** Mostly yes. Root can modify, but tampering leaves traces. Use remote logging for better security.

**Q6: Specific command kaise audit karein?**
**A:**
```bash
sudo auditctl -a always,exit -F arch=b64 -S execve -F exe=/usr/bin/passwd -k passwd_command
```

**Q7: Audit logs kaise search karein?**
**A:**
```bash
# By key
sudo ausearch -k KEY_NAME -i

# By file
sudo ausearch -f /path/to/file -i

# By user
sudo ausearch -ui UID -i

# By time
sudo ausearch -ts 10:00:00 -te 11:00:00 -i
```

**Q8: Kya auditd disable kar sakte hain?**
**A:** Haan (root required):
```bash
sudo systemctl stop auditd
sudo systemctl disable auditd
```

---

### **1ï¸âƒ£3ï¸âƒ£ Practice Tasks with Expected Output** ğŸ¯

#### **Task 1: Install and Start auditd**
```bash
sudo apt install auditd -y
sudo systemctl start auditd
sudo systemctl status auditd
```

**Expected:** Service active (running).

---

#### **Task 2: Watch a File**
```bash
# Add rule
sudo auditctl -w /tmp/test.txt -p wa -k test_file

# Create/modify file
echo "test" > /tmp/test.txt

# Search logs
sudo ausearch -k test_file -i
```

**Expected:** Log entry showing file modification.

---

#### **Task 3: View Current Rules**
```bash
sudo auditctl -l
```

**Expected:** List of active audit rules.

---

#### **Task 4: Generate Summary Report**
```bash
sudo aureport
```

**Expected:** Summary of audit events.

---

### **1ï¸âƒ£4ï¸âƒ£ Advanced Information & Edge Cases** ğŸš€

#### **Advanced Technique 1: Audit Network Connections**

```bash
# Monitor network syscalls
sudo auditctl -a always,exit -F arch=b64 -S socket -S connect -S accept -k network_connections
```

---

#### **Advanced Technique 2: Audit File Deletions**

```bash
# Monitor unlink syscall
sudo auditctl -a always,exit -F arch=b64 -S unlink -S unlinkat -S rename -S renameat -k file_deletion
```

---

#### **Advanced Technique 3: Remote Audit Logging**

```bash
# Configure audisp to forward logs
sudo nano /etc/audisp/plugins.d/syslog.conf
# active = yes

# Configure rsyslog to forward
sudo nano /etc/rsyslog.conf
# *.* @@remote-server:514
```

---

#### **Edge Case 1: Immutable Audit Rules**

```bash
# Make rules immutable (can't be changed until reboot)
sudo auditctl -e 2

# Check status
sudo auditctl -s
# enabled 2 (immutable)
```

---

#### **Edge Case 2: Audit Rule Priority**

```bash
# Rules are processed in order
# More specific rules should come first
sudo auditctl -a always,exit -F path=/etc/passwd -F perm=wa -k passwd_changes
sudo auditctl -a always,exit -F dir=/etc/ -F perm=wa -k etc_changes
```

---

### **1ï¸âƒ£5ï¸âƒ£ Final Summary & Key Takeaways** ğŸ“Œ

**Key Concepts:**
1. **auditd** - Kernel-level audit framework
2. **auditctl** - Configure audit rules
3. **ausearch** - Search audit logs
4. **aureport** - Generate reports
5. **Audit Rules** - Define what to monitor

**Critical Commands:**
```bash
# Watch file
sudo auditctl -w /path/to/file -p wa -k key_name

# List rules
sudo auditctl -l

# Search logs
sudo ausearch -k key_name -i

# Generate report
sudo aureport
```

**Admin Takeaways:**
- âœ… Monitor critical system files
- âœ… Audit sudo commands
- âœ… Use descriptive key names
- âœ… Persist rules in /etc/audit/rules.d/
- âœ… Regular log review
- âœ… Configure log rotation
- âœ… Setup alerting
- âœ… Compliance reporting

**Pentester Takeaways:**
- ğŸ” Check audit status
- ğŸ” Enumerate audit rules
- ğŸ” Identify monitored files
- ğŸ” Analyze audit logs
- ğŸ” Plan evasion strategies
- ğŸ” Avoid monitored actions
- ğŸ” Consider disabling auditd
- ğŸ” Log tampering leaves traces

**Remember:**
- auditd = system CCTV camera
- Everything can be logged
- Logs are (mostly) tamper-proof
- Performance impact if too many rules
- Essential for compliance

**Next Topic:** Bash History Hardening ğŸ“œ

---

**Happy Auditing! ğŸ“¹ğŸ”**
